<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard L≈©y k·∫ø - v218.42 (Optimized)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-accent: #108AB1;
            --success-color: #06D7A0;
            --warning-color: #FFD167;
            --danger-color: #F04770;
            --secondary-accent: #F78C6A;
            --text-primary: #073A4B;
            --text-on-dark: #FFFFFF;
            --text-muted: #5A7A84;
            --bg-main: #F4F7F9; 
            --border-main: #DDE3E7;
            --shadow-main: 
                0px 2.8px 2.2px rgba(7, 58, 75, 0.02),
                0px 6.7px 5.3px rgba(7, 58, 75, 0.028),
                0px 12.5px 10px rgba(7, 58, 75, 0.035),
                0px 22.3px 17.9px rgba(7, 58, 75, 0.042),
                0px 41.8px 33.4px rgba(7, 58, 75, 0.05),
                0px 100px 80px rgba(7, 58, 75, 0.07);
        }
        .capture-mode .card,
        .capture-mode .input-section,
        .capture-mode .action-btn {
            box-shadow: none !important;
            transform: none !important;
            transition: none !important;
        }
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--bg-main); 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            color: var(--text-primary); 
        }
        .container { 
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }
        header { text-align: center; margin-bottom: 10px; }
        header h1 { color: var(--text-primary); margin: 0; font-size: 2.5em; font-weight: 700; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .input-section, .card { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid var(--border-main); 
            box-shadow: var(--shadow-main);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .input-section h4 { margin-top: 0; color: var(--text-muted); }
        .input-section h4 a { color: inherit; text-decoration: none; transition: color 0.2s; }
        .input-section h4 a:hover { color: var(--primary-accent); }
        textarea { width: 100%; padding: 10px; border: 1px solid var(--border-main); background: #f8f9fa; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; }
        .mainDataInput, .contestDataInput { height: 120px; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; width: 100%; margin-top: 25px; }
        .input-wrapper { display: flex; flex-direction: column; }
        .paste-btn-container { display: flex; justify-content: flex-end; padding-top: 8px; }
        .paste-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.2s;
        }
        .paste-btn:hover {
            opacity: 1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(16, 138, 177, 0.4);
        }
        .input-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .input-header-flex h4 { margin: 0; }
        .interactive-table-wrapper { height: 200px; overflow-y: auto; border: 1px solid var(--border-main); border-radius: 8px; }
        .interactive-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .interactive-table thead th { position: sticky; top: 0; background-color: #f8f9fa; color: var(--text-primary); font-weight: 600; padding: 5px; text-align: center; border-bottom: 1px solid var(--border-main); z-index: 1; vertical-align: top; }
        .interactive-table tbody td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; text-align: right; }
        .interactive-table tbody td:first-child { text-align: center; font-weight: 500; background-color: #f8f9fa; }
        .interactive-table tbody td[contenteditable="true"] { background-color: #fff; transition: background-color 0.2s; }
        .interactive-table tbody td[contenteditable="true"]:focus { background-color: #e6f7ff; outline: 2px solid var(--primary-accent); outline-offset: -2px; }
        .interactive-table tbody tr:last-child td { border-bottom: none; }
        .th-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding-top: 5px; }
        .col-actions { display: flex; gap: 8px; }
        .col-action-btn { background: none; border: none; cursor: pointer; padding: 2px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: background-color 0.2s; }
        .col-action-btn:hover { background-color: #ddd; }
        .col-action-btn svg { width: 16px; height: 16px; }
        .col-action-btn.copy svg { color: var(--success-color); }
        .col-action-btn.paste svg { color: var(--primary-accent); }
        .col-action-btn.clear svg { color: var(--danger-color); }
        .action-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            padding: 15px; 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--text-on-dark); 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.2);
            flex-grow: 1;
            max-width: 300px;
        }
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 10px rgba(0,0,0,0.15), inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.15), inset 0 1px 0 rgba(0,0,0,0.2);
        }
        .action-btn svg { width: 20px; height: 20px; }
        .analyzeBtn { background: var(--primary-accent); }
        .captureBtn { background: linear-gradient(45deg, var(--success-color), #05B386); }
        .copySummaryBtn { background: linear-gradient(45deg, var(--primary-accent), #0d6c8b); }
        .dashboard-body { display: none; margin-top: 15px; }
        .report-title { text-align: center; font-size: 1.8em; font-weight: 700; margin: 10px 0 0 0; color: var(--text-primary); }
        #capture-area-luyke > * + * { margin-top: 25px; }
        #capture-content-luyke > * + * { margin-top: 25px; }
        .progress-bar-container { padding: 15px 25px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 1em; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); }
        .progress-track { width: 100%; height: 18px; background-color: #e9ecef; border-radius: 9px; overflow: hidden; border: 1px solid #ddd; }
        .progress-fill { height: 100%; background: var(--primary-accent); border-radius: 9px; transition: width 0.8s ease-out; }
        .progress-text-wrapper {
            text-align: center;
            margin-top: 4px;
            font-size: 0.9em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        .kpi-group-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .kpi-group-card { background-color: #fff; border-radius: 15px; box-shadow: var(--shadow-main); overflow: hidden; border: 1px solid var(--border-main); }
        .kpi-group-header { color: white; padding: 12px 20px; font-size: 1.2em; font-weight: 700; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .kpi-group-header svg { width: 24px; height: 24px; }
        .kpi-group-header.blue { background-color: var(--primary-accent); }
        .kpi-group-header.orange { background-color: var(--secondary-accent); }
        .kpi-group-header.red { background-color: var(--danger-color); }
        .kpi-group-body { padding: 15px 20px; display: flex; flex-direction: column; gap: 12px; }
        .kpi-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .kpi-item:last-child { border-bottom: none; }
        .kpi-label { display: flex; align-items: center; gap: 10px; color: var(--text-primary); font-weight: 600; }
        .kpi-label svg { width: 20px; height: 20px; flex-shrink: 0; }
        .kpi-value { font-weight: 700; color: var(--text-primary); font-size: 1.15em; }
        .dashboard-layout-grid { display: grid; gap: 25px; align-items: flex-start; }
        .charts-column { display: flex; flex-direction: column; gap: 25px; }
        .chart-wrapper, .report-section { padding: 25px; min-width: 0; } 
        .report-section h2, .chart-wrapper h2 { font-size: 1.8em; color: var(--primary-accent); text-align: center; margin-top:0; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .chart-wrapper h2 svg, .report-section h2 svg { width: 24px !important; height: 24px !important; flex-shrink: 0; }
        .chart-container { position: relative; width: 100%; }
        .summary-textarea { height: 500px; background-color: #f8f9fa; border: 1px solid var(--border-main); }
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 16px 30px; border-radius: 8px; z-index: 1001; font-size: 1.1em; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: bottom 0.5s ease-in-out; }
        .toast-notification.show { bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }
        .details-toggle { text-align: center; margin-top: 25px; }
        .details-toggle button { font-size: 0.9em; font-weight: 600; background: #6c757d; color: var(--text-on-dark); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .details-toggle button:hover { background-color: #5a6268; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .tables-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .tables-container.show { max-height: 5000px; margin-top: 25px; }
        #specificTablesContainer.show { max-height: 5000px; margin-top: 25px; }
        .table-container { margin-bottom:25px; overflow-x: auto; } 
        .table-container h2 { margin-top: 0; font-size: 1.5em; color: var(--primary-accent); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-main); }
        thead th { background-color: var(--primary-accent); color: var(--text-on-dark); text-transform: uppercase; font-size: 0.9em; }
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9ecef; }
        #contest-table-luyke-wrapper { padding: 25px; }
        #contest-table-luyke-wrapper h2 { text-align: center; font-size: 2em; margin-bottom: 25px; }
        .contest-split-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: flex-start; }
        .contest-group { background: #fff; border-radius: 15px; padding: 20px; border: 1px solid var(--border-main); box-shadow: var(--shadow-main); }
        .contest-group-title { font-size: 1.5em; font-weight: 700; margin: 0 0 15px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .contest-group-title.top-performers { color: var(--success-color); }
        .contest-group-title.needs-improvement { color: var(--danger-color); }
        .contest-detail-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .contest-detail-table th, .contest-detail-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border-main); border-right: 1px solid var(--border-main); vertical-align: middle; }
        .contest-detail-table th:last-child, .contest-detail-table td:last-child { border-right: none; }
        .contest-detail-table thead th { background-color: #f8f9fa; color: var(--text-primary); font-weight: 600; text-align: center; font-size: 0.9em; text-transform: uppercase; }
        .contest-detail-table tbody tr:last-child td { border-bottom: none; }
        .contest-detail-table tbody tr:hover { background-color: #e9ecef; }
        .contest-detail-table td { font-weight: 500; }
        .contest-detail-table th:not(:nth-child(2)), .contest-detail-table td:not(:nth-child(2)) { text-align: center; }
        .contest-detail-table .col-category { text-align: left; font-weight: 700; width: 30%; }
        .contest-detail-table .col-rank { width: 40px; }
        .col-negative { color: var(--danger-color); font-weight: bold; }
        .progress-bar-cell { min-width: 100px; }
        .bar-wrapper { display: flex; align-items: center; gap: 8px; }
        .bar-track { flex-grow: 1; height: 12px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease-out; }
        .bar-percent-text { font-weight: 700; font-size: 1.1em; width: 50px; text-align: right; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 160px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity: 0.3s; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .table-io-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .action-btn-small {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.9;
        }
        .action-btn-small.import { background-color: var(--success-color); }
        .action-btn-small.export { background-color: var(--secondary-accent); }
        .action-btn-small:hover { 
            opacity: 1;
            transform: translateY(-1px); 
        }
        @media (max-width: 1200px) {
            .kpi-group-container { grid-template-columns: 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            .contest-split-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 992px) {
            .dashboard-layout-grid {grid-template-columns: 1fr !important;}
            .charts-column { grid-row: 1; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            header h1 { font-size: 1.8em; }
            .card { padding: 15px; }
            .report-section h2, .chart-wrapper h2 { font-size: 1.5em; }
            .contest-detail-table { font-size: 12px; }
            .contest-detail-table th, .contest-detail-table td { padding: 8px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>BI SI√äU TH·ªä ƒêMX SAVICO (LU·ª∏ K·∫æ)</h1></header>

        <div id="luyKeInputGrid" class="input-grid">
            <div class="input-section">
                <div class="input-header-flex">
                    <h4><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnh&rt=2&dm=1" target="_blank" rel="noopener noreferrer">D·ªØ li·ªáu B√°o c√°o Kinh doanh</a></h4>
                </div>
                <div class="input-wrapper">
                    <textarea id="mainDataInput" class="mainDataInput" placeholder="D√°n d·ªØ li·ªáu t·ª´ BI v√†o ƒë√¢y..."></textarea>
                    <div class="paste-btn-container">
                        <button class="paste-btn" data-target="mainDataInput">D√°n Th√¥ng Minh</button>
                    </div>
                </div>
            </div>
            <div class="input-section">
                <div class="input-header-flex">
                    <h4><a href="https://bi.thegioididong.com/thi-dua-st?id=16753&tab=1&rt=2&dm=2&mt=1" target="_blank" rel="noopener noreferrer">D·ªØ li·ªáu Thi ƒëua</a></h4>
                </div>
                <div class="input-wrapper">
                    <textarea id="contestDataInput" class="contestDataInput" placeholder="D√°n d·ªØ li·ªáu thi ƒëua v√†o ƒë√¢y..."></textarea>
                    <div class="paste-btn-container">
                        <button class="paste-btn" data-target="contestDataInput">D√°n Th√¥ng Minh</button>
                    </div>
                </div>
            </div>
            <div class="input-section">
                <div class="input-header-flex">
                    <h4>D·ªØ li·ªáu NƒÉm (B·∫£ng t∆∞∆°ng t√°c)</h4>
                </div>
                <div id="yearlyDataInputContainer"></div>
            </div>
            <div class="input-section">
                <div class="input-header-flex">
                    <h4>D·ªØ li·ªáu So s√°nh Ng√†y (B·∫£ng t∆∞∆°ng t√°c)</h4>
                </div>
                <div id="dailyComparisonInputContainer"></div>
            </div>
        </div>
        <div class="button-container">
             <button id="analyzeBtn" class="action-btn analyzeBtn">T·∫†O DASHBOARD LU·ª∏ K·∫æ</button>
             <button id="updateFromCloudBtn" class="action-btn" style="background: var(--secondary-accent);">
                 <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.04M19,18H6A4,4 0 0,1 2,14C2,11.95 3.53,10.24 5.56,10.03L6.63,9.92L7.13,8.97C8.08,7.14 9.94,6 12,6C14.62,6 16.88,7.86 17.39,10.43L17.69,11.93L19.22,12.04C20.78,12.14 22,13.45 22,15A3,3 0 0,1 19,18M8,13H10.55V16H13.45V13H16L12,9L8,13Z" /></svg>
                 C·∫≠p nh·∫≠t t·ª´ Cloud
             </button>
             <button id="showInputsBtnLuyKe" class="action-btn" style="display: none; background: #6c757d;">Ch·ªânh s·ª≠a D·ªØ li·ªáu</button>
             <button id="captureBtnLuyKe" class="action-btn captureBtn">
                 <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                 Ch·ª•p ·∫£nh B√°o c√°o
             </button>
        </div>
        <div id="dashboard-body-luyke" class="dashboard-body">
            <div id="capture-area-luyke">
                <div id="capture-content-luyke">
                    <div id="reportTitleLuyKe" class="report-title"></div>
                    <div class="progress-bar-container card">
                        <div class="progress-labels"><span>Ti·∫øn ƒë·ªô Th√°ng</span><span id="progress-summary-date"></span></div>
                        <div class="progress-track"><div class="progress-fill" id="progress-fill-date"></div></div>
                        <div class="progress-text-wrapper"><span id="progress-text-date"></span></div>
                    </div>
                    <div class="progress-bar-container card">
                        <div class="progress-labels"><span>Ti·∫øn ƒë·ªô Target</span><span id="progress-summary-target"></span></div>
                        <div class="progress-track"><div class="progress-fill" id="progress-fill-target"></div></div>
                        <div class="progress-text-wrapper"><span id="progress-text-target"></span></div>
                    </div>
                    
                    <div id="kpi-group-container" class="kpi-group-container"></div>
                    
                    <div class="dashboard-layout-grid" style="grid-template-columns: 2fr 1fr;">
                        <div class="charts-column">
                            <div class="chart-wrapper card" id="yearly-revenue-chart-wrapper"></div>
                            <div class="chart-wrapper card" id="daily-comparison-chart-wrapper"></div>
                        </div>
                        <div class="charts-column">
                            <div class="chart-wrapper card" id="contribution-chart-wrapper"></div>
                            <div class="chart-wrapper card" id="growth-chart-wrapper"></div>
                        </div>
                    </div>

                    <div id="contest-table-luyke-wrapper" class="report-section card" style="grid-column: 1 / -1;"></div>

                </div>
                <div class="details-toggle">
                    <button id="toggleSpecificTablesBtn">üìä ·∫®n/Hi·ªán B·∫£ng Chi ti·∫øt Ng√†nh h√†ng</button>
                </div>
                <div id="specificTablesContainer" class="tables-container">
                    <div class="dashboard-layout-grid" style="gap: 25px;">
                        <div id="contest-results-container" class="report-section card contest-results-container" style="display:none;"></div>
                        <div class="report-section card" id="category-table-container"></div>
                    </div>
                </div>
            </div>
            <div id="summary-report-wrapper-luyke" class="report-section card" style="display:none;"></div>
            <div class="details-toggle"><button id="toggleTablesBtn">üîç ·∫®n/Hi·ªán B·∫£ng D·ªØ li·ªáu ƒê·∫ßy ƒë·ªß</button></div>
            <div id="tablesContainer" class="tables-container">
                <div id="main-table-wrapper" class="table-container card"></div>
                <div id="comparison-table-wrapper" class="table-container card"></div>
                <div id="contest-tables-wrapper" class="table-container card"></div>
            </div>
        </div>
    </div>
	
	<script>
    /****************************************************************************
     * SMART PASTE FUNCTIONS
     ****************************************************************************/
    function extractData(fullText, regex) {
        const match = fullText.match(regex);
        return (match && match[1]) ? match[1].trim() : '';
    }

    async function handleSmartPaste(targetId) {
        const targetTextarea = document.getElementById(targetId);
        if (!targetTextarea) return;

        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                showToast('Clipboard r·ªóng!', true);
                return;
            }
            
            let extractedData = '';
            switch (targetId) {
                case 'mainDataInput':
                    extractedData = extractData(text, /(Nh√≥m ng√†nh h√†ng\tS·ªë l∆∞·ª£ng\tDTQƒê[\s\S]+?)H·ªó tr·ª£ BI/);
                    break;
                case 'contestDataInput':
                    extractedData = extractData(text, /(Ng√†nh h√†ng\tDTQƒê\tTarget[\s\S]+?)H·ªó tr·ª£ BI/);
                    break;
                default:
                    extractedData = text;
            }

            targetTextarea.value = extractedData || text;
            showToast('ƒê√£ d√°n v√† l·ªçc d·ªØ li·ªáu th√¥ng minh!');

        } catch (err) {
            console.error('L·ªói khi d√°n: ', err);
            showToast('Kh√¥ng th·ªÉ truy c·∫≠p clipboard. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p c·ªßa tr√¨nh duy·ªát.', true);
        }
    }

    function setupSmartPasteButtons() {
        document.querySelectorAll('.paste-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-target');
                handleSmartPaste(targetId);
            });
        });
    }


    /****************************************************************************
     * INTERACTIVE TABLE FUNCTIONS
     ****************************************************************************/
    
    async function copyColumnData(tableId, colIndex) {
        const table = document.getElementById(tableId);
        if (!table) return;
        let dataString = '';
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].cells[colIndex];
            if (cell) {
                dataString += cell.innerText.trim() + '\n';
            }
        }
        
        const textarea = document.createElement('textarea');
        textarea.value = dataString.trim();
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showToast('ƒê√£ sao ch√©p d·ªØ li·ªáu c·ªôt!');
        } catch (err) {
            console.error('L·ªói sao ch√©p c·ªôt: ', err);
            showToast('L·ªói khi sao ch√©p d·ªØ li·ªáu.', true);
        }
        document.body.removeChild(textarea);
    }

    async function pasteColumnData(tableId, colIndex) {
        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                showToast('Clipboard r·ªóng!', true);
                return;
            }
            const table = document.getElementById(tableId);
            if (!table) return;

            const pastedRows = text.split(/\r?\n/).filter(row => row.trim() !== '');
            const tableRows = table.tBodies[0].rows;

            pastedRows.forEach((cellData, i) => {
                if (i >= tableRows.length) return;
                const targetCell = tableRows[i].cells[colIndex];
                if (targetCell && targetCell.isContentEditable) {
                    targetCell.innerText = cellData.trim();
                }
            });

            saveTableData(tableId);
            showToast(`ƒê√£ d√°n d·ªØ li·ªáu v√†o c·ªôt!`);
        } catch (err) {
            console.error('L·ªói khi d√°n c·ªôt: ', err);
            showToast('Kh√¥ng th·ªÉ truy c·∫≠p clipboard.', true);
        }
    }

    function clearColumnData(tableId, colIndex) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].cells[colIndex];
            if (cell && cell.isContentEditable) {
                cell.innerText = '';
            }
        }
        saveTableData(tableId);
        showToast('ƒê√£ xo√° d·ªØ li·ªáu c·ªôt!');
    }

    function handleTablePaste(event, table) {
        event.preventDefault();
        const clipboardData = event.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text/plain');
        const rows = pastedData.split(/\r?\n/).filter(row => row.trim() !== '');

        const startCell = event.target;
        if (startCell.tagName !== 'TD') return;

        const startRowIndex = startCell.parentElement.rowIndex - 1; 
        const startColIndex = startCell.cellIndex;
        
        rows.forEach((rowData, i) => {
            const currentRowIndex = startRowIndex + i;
            const targetRow = table.tBodies[0].rows[currentRowIndex];
            if (!targetRow) return;

            const cellsToPaste = rowData.split('\t');
            cellsToPaste.forEach((cellData, j) => {
                const currentColIndex = startColIndex + j;
                const targetCell = targetRow.cells[currentColIndex];
                if (targetCell && targetCell.isContentEditable) {
                    targetCell.innerText = cellData.trim();
                }
            });
        });
        
        saveTableData(table.id);
        showToast('ƒê√£ d√°n v√† l∆∞u d·ªØ li·ªáu!');
    }

    function handleTableKeyDown(event) {
        if (event.key !== 'Enter' || !event.target.isContentEditable) {
            return;
        }
        event.preventDefault();
        const currentCell = event.target;
        const currentRow = currentCell.parentElement;
        const cellIndex = currentCell.cellIndex;
        const nextRow = currentRow.nextElementSibling;
        if (nextRow) {
            const nextCell = nextRow.cells[cellIndex];
            if (nextCell && nextCell.isContentEditable) {
                nextCell.focus();
            }
        }
    }

    function saveTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const data = [];
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            const rowData = [];
            for (let j = 1; j < cells.length; j++) {
                rowData.push(cells[j].innerText);
            }
            data.push(rowData);
        }
        try {
            localStorage.setItem(tableId, JSON.stringify(data));
        } catch (e) {
            console.error("L·ªói khi l∆∞u v√†o localStorage:", e);
        }
    }

    async function loadTableDataAdvanced(tableId, defaultData = {}, fromButtonClick = false) {
        const fileName = `${tableId}_data.json`;
        try {
            const response = await fetch(fileName, { cache: "no-store" }); 
            if (!response.ok) {
                throw new Error(`File ${fileName} not found, falling back to localStorage.`);
            }
            const dataToLoad = await response.json();
            if (!Array.isArray(dataToLoad)) {
                 throw new Error('ƒê·ªãnh d·∫°ng JSON kh√¥ng h·ª£p l·ªá.');
            }
            
            const table = document.getElementById(tableId);
            if (!table) return;

            const tableRows = table.tBodies[0].rows;
            for (let i = 0; i < dataToLoad.length && i < tableRows.length; i++) {
                const rowData = dataToLoad[i];
                if (!Array.isArray(rowData)) continue;
                const cells = tableRows[i].cells;
                for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                    if (cells[j + 1] && cells[j + 1].isContentEditable) {
                        cells[j + 1].innerText = rowData[j];
                    }
                }
            }
            saveTableData(tableId); 
            const tableName = tableId.includes('yearly') ? 'NƒÉm' : 'So s√°nh Ng√†y';
            if(fromButtonClick) {
                showToast(`ƒê√£ t·∫£i d·ªØ li·ªáu cho b·∫£ng ${tableName} t·ª´ file!`, false);
            }
            console.log(`ƒê√£ t·∫£i th√†nh c√¥ng d·ªØ li·ªáu t·ª´ ${fileName}`);

        } catch (error) {
            console.warn(error.message);
            if (fromButtonClick) { 
                 showToast(`Kh√¥ng t√¨m th·∫•y file ${fileName}. ƒêang d√πng d·ªØ li·ªáu ƒë√£ l∆∞u.`, true);
            }
            loadTableDataFromStorage(tableId, defaultData);
        }
    }

    function loadTableDataFromStorage(tableId, defaultData = {}) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        let dataToLoad = defaultData[tableId] || [];
        try {
            const savedData = localStorage.getItem(tableId);
            if (savedData) {
                const parsedSavedData = JSON.parse(savedData);
                if (Array.isArray(parsedSavedData) && parsedSavedData.some(row => Array.isArray(row) && row.some(cell => cell && cell.trim() !== ''))) {
                    dataToLoad = parsedSavedData;
                }
            }
        } catch (e) {
            console.error("L·ªói khi t·∫£i t·ª´ localStorage:", e);
            dataToLoad = defaultData[tableId] || [];
        }

        const rows = table.tBodies[0].rows;
        for (let i = 0; i < dataToLoad.length && i < rows.length; i++) {
            const rowData = dataToLoad[i];
            const cells = rows[i].cells;
            for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                cells[j + 1].innerText = rowData[j];
            }
        }
    }

    function getStructuredTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) {
            console.error(`Table with id ${tableId} not found.`);
            return [];
        }

        const data = [];
        const keys = tableId === 'yearlyDataTable' 
            ? ['Th√°ng', 'Doanh thu th√°ng', 'Target th√°ng'] 
            : ['Ng√†y', 'DT Th√°ng n√†y', 'DT Th√°ng tr∆∞·ªõc'];

        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            if (!cells || cells.length < 2) continue;

            const rowObject = {};
            let hasData = false;

            rowObject[keys[0]] = cells[0] ? cells[0].innerText.trim() : '';

            const val1_str = cells[1] ? cells[1].innerText.trim().replace(/,/g, '') : '0';
            const val1 = parseFloat(val1_str);
            rowObject[keys[1]] = isNaN(val1) ? 0 : val1;
            if (!isNaN(val1) && val1 !== 0) hasData = true;
            
            if (keys.length > 2 && cells[2]) {
                 const val2_str = cells[2].innerText.trim().replace(/,/g, '');
                 const val2 = parseFloat(val2_str);
                 rowObject[keys[2]] = isNaN(val2) ? 0 : val2;
                 if (!isNaN(val2) && val2 !== 0) hasData = true;
            } else if (keys.length > 2) {
                rowObject[keys[2]] = 0;
            }

            if (hasData) {
                data.push(rowObject);
            }
        }
        return data;
    }
    
    function createYearlyDataTable() {
        const container = document.getElementById('yearlyDataInputContainer');
        let tableHTML = `
            <div class="interactive-table-wrapper">
                <table id="yearlyDataTable" class="interactive-table">
                    <thead>
                        <tr>
                            <th>Th√°ng</th>
                            <th>
                                <div class="th-content">
                                    <span>Doanh thu th√°ng</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="yearlyDataTable" data-col-index="1" title="Sao ch√©p c·ªôt Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="yearlyDataTable" data-col-index="1" title="D√°n v√†o c·ªôt Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="yearlyDataTable" data-col-index="1" title="Xo√° d·ªØ li·ªáu c·ªôt Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <span>Target th√°ng</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="yearlyDataTable" data-col-index="2" title="Sao ch√©p c·ªôt Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="yearlyDataTable" data-col-index="2" title="D√°n v√†o c·ªôt Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="yearlyDataTable" data-col-index="2" title="Xo√° d·ªØ li·ªáu c·ªôt Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>`;
        for (let i = 1; i <= 12; i++) {
            tableHTML += `<tr>
                                <td>${i}</td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                            </tr>`;
        }
        tableHTML += `</tbody></table></div>`;
        tableHTML += `
            <div class="table-io-actions">
                <button class="action-btn-small import" data-table-id="yearlyDataTable" title="Nh·∫≠p d·ªØ li·ªáu t·ª´ file .json">Nh·∫≠p D·ªØ li·ªáu</button>
                <button class="action-btn-small export" data-table-id="yearlyDataTable" title="Xu·∫•t d·ªØ li·ªáu ra file .json">Xu·∫•t D·ªØ li·ªáu</button>
            </div>
        `;
        container.innerHTML = tableHTML;

        const table = document.getElementById('yearlyDataTable');
        table.addEventListener('input', () => saveTableData('yearlyDataTable'));
        table.addEventListener('paste', (e) => handleTablePaste(e, table));
        table.addEventListener('keydown', handleTableKeyDown);
    }

    function createDailyComparisonTable() {
        const container = document.getElementById('dailyComparisonInputContainer');
        let tableHTML = `
            <div class="interactive-table-wrapper">
                <table id="dailyComparisonTable" class="interactive-table">
                    <thead>
                        <tr>
                            <th>Ng√†y</th>
                             <th>
                                <div class="th-content">
                                    <span>DT Th√°ng n√†y</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="dailyComparisonTable" data-col-index="1" title="Sao ch√©p c·ªôt DT Th√°ng n√†y"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="dailyComparisonTable" data-col-index="1" title="D√°n v√†o c·ªôt DT Th√°ng n√†y"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="dailyComparisonTable" data-col-index="1" title="Xo√° d·ªØ li·ªáu c·ªôt DT Th√°ng n√†y"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <span>DT Th√°ng tr∆∞·ªõc</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="dailyComparisonTable" data-col-index="2" title="Sao ch√©p c·ªôt DT Th√°ng tr∆∞·ªõc"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="dailyComparisonTable" data-col-index="2" title="D√°n v√†o c·ªôt DT Th√°ng tr∆∞·ªõc"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="dailyComparisonTable" data-col-index="2" title="Xo√° d·ªØ li·ªáu c·ªôt DT Th√°ng tr∆∞·ªõc"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>`;
        for (let i = 1; i <= 31; i++) {
            tableHTML += `<tr>
                                <td>${i}</td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                            </tr>`;
        }
        tableHTML += `</tbody></table></div>`;
        tableHTML += `
            <div class="table-io-actions">
                <button class="action-btn-small import" data-table-id="dailyComparisonTable" title="Nh·∫≠p d·ªØ li·ªáu t·ª´ file .json">Nh·∫≠p D·ªØ li·ªáu</button>
                <button class="action-btn-small export" data-table-id="dailyComparisonTable" title="Xu·∫•t d·ªØ li·ªáu ra file .json">Xu·∫•t D·ªØ li·ªáu</button>
            </div>
        `;
        container.innerHTML = tableHTML;

        const table = document.getElementById('dailyComparisonTable');
        table.addEventListener('input', () => saveTableData('dailyComparisonTable'));
        table.addEventListener('paste', (e) => handleTablePaste(e, table));
        table.addEventListener('keydown', handleTableKeyDown);
    }

    function exportTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const data = [];
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            const rowData = [];
            for (let j = 1; j < cells.length; j++) {
                rowData.push(cells[j].innerText.trim());
            }
            data.push(rowData);
        }
        
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${tableId}_data.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu!');
    }

    function importTableData(tableId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = readerEvent.target.result;
                    const dataToLoad = JSON.parse(content);
                    
                    if (!Array.isArray(dataToLoad)) {
                        throw new Error('ƒê·ªãnh d·∫°ng JSON kh√¥ng h·ª£p l·ªá.');
                    }

                    const table = document.getElementById(tableId);
                    if (!table) return;

                    const tableRows = table.tBodies[0].rows;
                    for (let i = 0; i < dataToLoad.length && i < tableRows.length; i++) {
                        const rowData = dataToLoad[i];
                        if (!Array.isArray(rowData)) continue;
                        const cells = tableRows[i].cells;
                        for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                            if (cells[j + 1] && cells[j + 1].isContentEditable) {
                                cells[j + 1].innerText = rowData[j];
                            }
                        }
                    }
                    saveTableData(tableId);
                    showToast('ƒê√£ nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng!');
                } catch (err) {
                    console.error('L·ªói khi nh·∫≠p file:', err);
                    showToast(`L·ªói: ${err.message}`, true);
                }
            };
            reader.readAsText(file, 'UTF-8');
        };
        input.click();
    }

    /****************************************************************************
     * SHARED UTILITY & SETUP FUNCTIONS
     ****************************************************************************/
    var VIBRANT_PALETTE = ['#108AB1', '#06D7A0', '#FFD167', '#F78C6A', '#F04770', '#073A4B'];
    var formatNumber = (num, decimals = 0) => {
        const number = parseFloat(num);
        if (isNaN(number)) {
            return ''; 
        }
        return number.toLocaleString('vi-VN', { maximumFractionDigits: decimals });
    };
    var formatShortK = (num) => {
        if (isNaN(num) || num === 0) return '0';
        return (num / 1000).toLocaleString('vi-VN', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    };
    var getColor = (value, threshold1 = 50, threshold2 = 100) => value < threshold1 ? '#F04770' : value < threshold2 ? '#F78C6A' : '#06D7A0';
    
    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (isError) toast.classList.add('error');
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.parentNode && toast.parentNode.removeChild(toast), 500);
        }, 3000);
    }

    async function updateFromCloud() {
        showToast('B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t d·ªØ li·ªáu t·ª´ cloud...');
        await loadTableDataAdvanced('yearlyDataTable', {}, true);
        await loadTableDataAdvanced('dailyComparisonTable', {}, true);
    }
    
    function parseAllContestData(text) {
        const blocks = text.trim().split(/\n\s*\n/); 
        return blocks.map(block => parseSingleContestBlock(block)).filter(b => b.rows.length > 0); 
    }

    function parseSingleContestBlock(blockText) { 
        const lines = blockText.trim().split('\n').filter(l => l.trim() !== ''); 
        if (lines.length < 1) return { headers: [], rows: [] }; 
        const headers = lines[0].split('\t').map(h => h.trim()); 
        const rows = lines.slice(1).map(line => line.split('\t').map(cell => cell.trim())); 
        return { headers, rows }; 
    }

    function processFullContestData(allContests, daysRemaining) {
        let processedItems = [];
        if (!allContests || allContests.length === 0) return { all: [], veDich:[], canCoGang:[], canTapTrung:[], baoDong:[], onTrack:[], behind:[] };
        allContests.forEach(contest => {
            const percentIndex = contest.headers.findIndex(h => h.toLowerCase().includes('% ht d·ª± ki·∫øn') || h.toLowerCase().includes('%ht'));
            const actualIndex = contest.headers.findIndex(h => h.toLowerCase().includes('th·ª±c hi·ªán') || h.toLowerCase().includes('dtqƒë') || h.toLowerCase().includes('sllk') || h.toLowerCase().includes('dtlk'));
            const targetIndex = contest.headers.findIndex(h => h.toLowerCase().includes('target'));
            if (percentIndex === -1 || actualIndex === -1 || targetIndex === -1) {
                console.warn("M·ªôt b·∫£ng thi ƒëua thi·∫øu header c·∫ßn thi·∫øt (target, th·ª±c hi·ªán, %ht d·ª± ki·∫øn), ƒë√£ b·ªè qua.");
                return;
            };
            const items = contest.rows.filter(row => row.length > 1 && row[0].toLowerCase() !== 't·ªïng' && row[0].toLowerCase() !== 'ng√†nh h√†ng');
            items.forEach(row => {
                const actual = parseFloat(row[actualIndex].replace(/,/g, '')) || 0;
                const target = parseFloat(row[targetIndex].replace(/,/g, '')) || 0;
                const remaining = target - actual;
                processedItems.push({
                    name: row[0],
                    percentProjected: parseFloat(row[percentIndex]) || 0,
                    percentActual: target > 0 ? (actual / target * 100) : 0,
                    actual, target, remaining,
                    dailyTarget: remaining > 0 && daysRemaining > 0 ? remaining / daysRemaining : 0,
                });
            });
        });
        const sortedItems = processedItems.sort((a,b) => b.percentProjected - a.percentProjected);
        
        return {
            all: sortedItems,
            onTrack: sortedItems.filter(p => p.percentProjected >= 100),
            behind: sortedItems.filter(p => p.percentProjected < 100),
            veDich_actual: sortedItems.filter(p => p.percentActual >= 100),
            canCoGang_actual: sortedItems.filter(p => p.percentActual >= 80 && p.percentActual < 100),
            canTapTrung_actual: sortedItems.filter(p => p.percentActual >= 50 && p.percentActual < 80),
            baoDong_actual: sortedItems.filter(p => p.percentActual < 50)
        };
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);
        Chart.defaults.color = 'var(--text-muted)';
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.font.weight = '600';
        
        const defaultData = {
            yearlyDataTable: [
                ['11745', '11940'], ['7567', '7158'], ['7639', '7177'],
                ['9442', '6277'], ['8772', '7166'], ['9630', '7762'],
                ['6911', '8910'], [], [], [], [], []
            ],
            dailyComparisonTable: [
                ['116', '246'], ['114', '154'], ['116', '129'], ['','136'], ['','156'],
                ['','205'], ['','305'], ['','222'], ['','149'], ['','149'],
                ['','117'], ['','157'], ['','161'], ['','236'], ['','371'],
                ['','132'], ['','218'], ['','174'], ['','114'], ['','121'],
                ['','166'], ['','410'], ['','91'], ['','106'], ['','80'],
                ['','162'], ['','430'], ['','387'], ['','353'], ['','187'], []
            ]
        };

        createYearlyDataTable();
        createDailyComparisonTable();
        loadTableDataAdvanced('yearlyDataTable', defaultData);
        loadTableDataAdvanced('dailyComparisonTable', defaultData);

        setupLuyKeTab();
        
        setupSmartPasteButtons();
        
        document.getElementById('updateFromCloudBtn').addEventListener('click', updateFromCloud);

        document.body.addEventListener('click', function(e) {
            const colButton = e.target.closest('.col-action-btn');
            if (colButton) {
                const tableId = colButton.dataset.tableId;
                const colIndex = parseInt(colButton.dataset.colIndex, 10);

                if (colButton.classList.contains('copy')) {
                    copyColumnData(tableId, colIndex);
                } else if (colButton.classList.contains('paste')) {
                    pasteColumnData(tableId, colIndex);
                } else if (colButton.classList.contains('clear')) {
                    clearColumnData(tableId, colIndex);
                }
                return; 
            }

            const ioButton = e.target.closest('.action-btn-small');
            if (ioButton) {
                const tableId = ioButton.dataset.tableId;
                if (ioButton.classList.contains('import')) {
                    importTableData(tableId);
                } else if (ioButton.classList.contains('export')) {
                    exportTableData(tableId);
                }
                return;
            }
        });

        try {
            document.getElementById('mainDataInput').value = localStorage.getItem('luyKeMainData') || '';
            document.getElementById('contestDataInput').value = localStorage.getItem('luyKeContestData') || '';
        } catch (e) {
            console.error("Could not access localStorage. Data will not be saved.", e);
            showToast("Kh√¥ng th·ªÉ truy c·∫≠p b·ªô nh·ªõ c·ª•c b·ªô. D·ªØ li·ªáu s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.", true);
        }
    });

    /****************************************************************************
     * TAB 1: LU·ª∏ K·∫æ LOGIC                                     *
     ****************************************************************************/
    function setupLuyKeTab() {
        let allChartsLuyKe = [];
        const destroyAllChartsLuyKe = () => { allChartsLuyKe.forEach(chart => chart && chart.destroy()); allChartsLuyKe = []; };

        document.getElementById('analyzeBtn').addEventListener('click', () => { 
            const mainDataFromTextarea = document.getElementById('mainDataInput').value;
            const contestDataFromTextarea = document.getElementById('contestDataInput').value;
            try {
                localStorage.setItem('luyKeMainData', mainDataFromTextarea);
                localStorage.setItem('luyKeContestData', contestDataFromTextarea);
            } catch (e) { console.error("Could not save to localStorage", e); }

            const yearlyDataFromTable = getStructuredTableData('yearlyDataTable');
            const dailyDataFromTable = getStructuredTableData('dailyComparisonTable');

            if (!mainDataFromTextarea.trim()) { 
                showToast('Vui l√≤ng d√°n d·ªØ li·ªáu B√°o c√°o Kinh doanh v√†o √¥ nh·∫≠p li·ªáu.', true); 
                return; 
            } 
            if (yearlyDataFromTable.length === 0 || dailyDataFromTable.length === 0) {
                showToast('Vui l√≤ng nh·∫≠p d·ªØ li·ªáu v√†o b·∫£ng NƒÉm v√† So s√°nh Ng√†y.', true);
                return;
            }
            
            try { 
                const mainParsedData = parseLuyKeData(mainDataFromTextarea); 
                const contestParsedData = contestDataFromTextarea.trim() ? parseAllContestData(contestDataFromTextarea) : []; 
                
                document.getElementById('luyKeInputGrid').style.display = 'none';
                document.getElementById('showInputsBtnLuyKe').style.display = 'inline-flex';

                displayLuyKeDashboard(mainParsedData, contestParsedData, yearlyDataFromTable, dailyDataFromTable); 
            } catch (error) { 
                showToast("L·ªói x·ª≠ l√Ω d·ªØ li·ªáu Lu·ªπ k·∫ø: " + error.message, true); 
                console.error(error); 
            } 
        });

        document.getElementById('showInputsBtnLuyKe').addEventListener('click', function() {
            const inputGrid = document.getElementById('luyKeInputGrid');
            const isHidden = inputGrid.style.display === 'none';
            inputGrid.style.display = isHidden ? 'grid' : 'none';
            this.textContent = isHidden ? '·∫®n M·ª•c Nh·∫≠p Li·ªáu' : 'Ch·ªânh s·ª≠a D·ªØ li·ªáu';
        });
        
        document.getElementById('toggleSpecificTablesBtn').addEventListener('click', () => {
            document.getElementById('specificTablesContainer').classList.toggle('show');
        });

        document.getElementById('toggleTablesBtn').addEventListener('click', () => document.getElementById('tablesContainer').classList.toggle('show'));
        
        document.getElementById('captureBtnLuyKe').addEventListener('click', () => {
            const dashboardBody = document.getElementById('dashboard-body-luyke');
            if (dashboardBody.style.display === 'none') {
                showToast('Ch∆∞a c√≥ d·ªØ li·ªáu Lu·ªπ k·∫ø ƒë·ªÉ ch·ª•p ·∫£nh.', true);
                return;
            }

            const specificTablesContainer = document.getElementById('specificTablesContainer');
            const tablesAreVisible = specificTablesContainer.classList.contains('show');
            
            const captureElement = tablesAreVisible 
                ? document.getElementById('capture-area-luyke') 
                : document.getElementById('capture-content-luyke');

            const mainContainer = document.querySelector('body');
            mainContainer.classList.add('capture-mode');
            
            setTimeout(() => {
                html2canvas(captureElement, { 
                    useCORS: true, 
                    backgroundColor: '#F4F7F9',
                    scale: 2.5 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `b√°o c√°o lu·ªπ k·∫ø ng√†y ${new Date().toLocaleDateString('vi-VN')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    showToast('L·ªói khi ch·ª•p ·∫£nh. H√£y th·ª≠ l·∫°i.', true);
                    console.error(err);
                }).finally(() => {
                    mainContainer.classList.remove('capture-mode');
                });
            }, 100);
        });

        function parseLuyKeData(text) { 
            const headers = [ "Nh√≥m ng√†nh h√†ng", "S·ªë l∆∞·ª£ng", "DTQƒê", "Target (Qƒê)", "L√£i g·ªôp Qƒê", "% HT Target (Qƒê)", "+/- DTCK Th√°ng (Qƒê)", "ƒê∆°n gi√°", "DT Tr·∫£ G√≥p", "T·ª∑ Tr·ªçng Tr·∫£ G√≥p" ]; 
            const rawLines = text.trim().split('\n'); 
            const dataRows = rawLines[0].toLowerCase().includes('nh√≥m ng√†nh h√†ng') ? rawLines.slice(1) : rawLines; 
            return dataRows.map(line => { 
                const values = line.split('\t'); 
                const rowObject = {}; 
                headers.forEach((header, index) => { 
                    const valueStr = values[index] || '0'; 
                    if (header === "Nh√≥m ng√†nh h√†ng") {
                        rowObject[header] = valueStr.trim();
                    } else {
                        const cleanedValueStr = valueStr.replace(/,/g, '').replace(/%/, '');
                        rowObject[header] = parseFloat(cleanedValueStr) || 0; 
                    }
                }); 
                return rowObject; 
            }); 
        }
        
        function displayLuyKeDashboard(mainData, contestData, yearlyData, dailyData) {
            document.getElementById('dashboard-body-luyke').style.display = 'block';
            destroyAllChartsLuyKe();
            const totalRow = mainData.find(row => row["Nh√≥m ng√†nh h√†ng"] === "T·ªïng");
            if (!totalRow) { throw new Error("Kh√¥ng t√¨m th·∫•y d√≤ng 'T·ªïng' trong d·ªØ li·ªáu Kinh doanh."); }
            
            let today = new Date();
            let reportDate = new Date(today);
            let daysUsed, daysInMonth, daysRemaining;

            if (today.getDate() === 1) {
                const prevMonthEndDate = new Date(today.getFullYear(), today.getMonth(), 0);
                daysInMonth = prevMonthEndDate.getDate();
                daysUsed = prevMonthEndDate.getDate();
                daysRemaining = 0;
                reportDate = prevMonthEndDate;
            } else {
                daysUsed = today.getDate() - 1;
                daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                daysRemaining = daysInMonth - daysUsed;
            }

            const categoryData = mainData.filter(row => row["Nh√≥m ng√†nh h√†ng"] !== "T·ªïng");
            
            const luyKe = totalRow["DTQƒê"], target = totalRow["Target (Qƒê)"], htTarget = luyKe > 0 && target > 0 ? (luyKe/target*100) : 0;
            const growthRate = totalRow["+/- DTCK Th√°ng (Qƒê)"];
            const dtDuKien = (daysUsed > 0 ? (luyKe / daysUsed) : 0) * daysInMonth;
            const htDuKien = target > 0 ? (dtDuKien / target * 100) : 0;
            const chenhLech = luyKe - ((1 + growthRate / 100) !== 0 ? luyKe / (1 + growthRate / 100) : 0);
            const mucTieuNgay = daysRemaining > 0 ? (target - luyKe) / daysRemaining : 0;
            const mainKpis = { luyKe, target, htTarget, growthRate, dtDuKien, htDuKien, chenhLech, mucTieuNgay, tyTrongTraGop: totalRow["T·ª∑ Tr·ªçng Tr·∫£ G√≥p"], doanhThuTraGop: totalRow["DT Tr·∫£ G√≥p"] };

            const processedContestData = processFullContestData(contestData, daysRemaining);

            const dateString = `ng√†y ${reportDate.getDate()}/${reportDate.getMonth() + 1}/${reportDate.getFullYear()}`;
            document.getElementById('reportTitleLuyKe').textContent = `B√°o c√°o s·ª©c kho·∫ª si√™u th·ªã ƒë·∫øn ${dateString}`;

            renderLuyKeKPIs(mainKpis, daysUsed, daysInMonth, yearlyData, reportDate);
            renderLuyKeCharts(categoryData);
            
            renderYearlyRevenueChart(yearlyData, mainKpis, reportDate);
            renderDailyComparisonChart(dailyData, yearlyData, mainKpis, reportDate, daysInMonth);

            renderLuyKeCategoryTables(categoryData);
            renderLuyKeContestTable(processedContestData);
            
            document.getElementById('contest-results-container').style.display = 'none';
            const specificGrid = document.querySelector('#specificTablesContainer .dashboard-layout-grid');
            if (specificGrid) {
                specificGrid.style.gridTemplateColumns = '1fr';
            }

            renderLuyKeSummary(mainKpis, processedContestData, reportDate);
            displayLuyKeHiddenTables(mainData, contestData);
        }
        
        function renderLuyKeKPIs(kpis, daysUsed, daysInMonth, yearlyData, reportDate) {
            const progressPercentDate = (daysUsed / daysInMonth) * 100;
            document.getElementById('progress-fill-date').style.width = `${progressPercentDate}%`;
            document.getElementById('progress-text-date').textContent = `ƒê√£ qua ${daysUsed}/${daysInMonth} ng√†y`;
            document.getElementById('progress-summary-date').textContent = `${formatNumber(progressPercentDate, 1)}%`;
            
            const progressPercentTarget = kpis.htTarget > 100 ? 100 : kpis.htTarget;
            const htTargetColor = getColor(kpis.htTarget);
            const progressFillTarget = document.getElementById('progress-fill-target');
            progressFillTarget.style.width = `${progressPercentTarget}%`;
            progressFillTarget.style.backgroundColor = htTargetColor;
            document.getElementById('progress-text-target').textContent = `${formatNumber(kpis.htTarget, 1)}%`;
            document.getElementById('progress-summary-target').textContent = `${formatNumber(kpis.luyKe)} / ${formatNumber(kpis.target)}`;
            
            const kpiContainer = document.getElementById('kpi-group-container');
            const today = new Date();
            const currentMonth = reportDate.getMonth() + 1;
            const dayOfWeek = today.getDay();

            const doanhThuConLai = kpis.target - kpis.luyKe;
            const doanhThuConLaiDisplay = doanhThuConLai <= 0 ? 'üèÜ' : `${formatNumber(doanhThuConLai, 0)} Tri·ªáu`;
            const doanhThuConLaiColor = doanhThuConLai <= 0 ? 'var(--success-color)' : 'var(--text-primary)';
            const iconDoanhThuConLai = doanhThuConLai <= 0 
                ? '<path fill="currentColor" d="M19.5,2H4.5A2.5,2.5 0 0,0 2,4.5V7H4V18A4,4 0 0,0 8,22H16A4,4 0 0,0 20,18V7H22V4.5A2.5,2.5 0 0,0 19.5,2M18,7V18A2,2 0 0,1 16,20H8A2,2 0 0,1 6,18V7Z"/>' 
                : '<path fill="currentColor" d="M13,9H11V4H13V9M12,13.5A1.5,1.5 0 0,1 10.5,12A1.5,1.5 0 0,1 12,10.5A1.5,1.5 0 0,1 13.5,12A1.5,1.5 0 0,1 12,13.5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12C22,6.48 17.5,2 12,2Z"/>';

            const yearlyTargetTotal = yearlyData
                .filter(row => parseInt(row['Th√°ng']) <= currentMonth)
                .reduce((sum, row) => sum + (row['Target th√°ng'] || 0), 0);
            const pastMonthsActual = yearlyData
                .filter(row => parseInt(row['Th√°ng']) < currentMonth)
                .reduce((sum, row) => sum + (row['Doanh thu th√°ng'] || 0), 0);
            const yearlyActualTotal = pastMonthsActual + kpis.dtDuKien;
            const yearlyPercent = yearlyTargetTotal > 0 ? (yearlyActualTotal / yearlyTargetTotal * 100) : 0;
            const yearlyRemaining = yearlyTargetTotal - yearlyActualTotal;
            
            const daysRemainingInMonth = daysInMonth - today.getDate() + 1;
            const mucTieuTraNoNgay = daysRemainingInMonth > 0 ? Math.max(0, (kpis.dtDuKien + yearlyRemaining - kpis.luyKe) / daysRemainingInMonth) : 0;
            
            const mucTieuKyVongThang = kpis.target / daysInMonth;
            let mucTieuNgayKyVong = Math.max(mucTieuKyVongThang, kpis.mucTieuNgay);
            
            let kyVongLabel = "M·ª•c ti√™u ng√†y k·ª≥ v·ªçng";
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                mucTieuNgayKyVong *= 2;
                kyVongLabel += " (x2 T7/CN)";
            }

            kpiContainer.innerHTML = `
                <div class="kpi-group-card">
                    <div class="kpi-group-header blue"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>TI·∫æN ƒê·ªò TH√ÅNG</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v-2h-2z"/></svg>Target th√°ng</span><span class="kpi-value">${formatNumber(kpis.target, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M4 18h16v-2H4v2zm0-5h16v-2H4v2zm0-5h16V6H4v2z"/></svg>Lu·ªπ k·∫ø</span><span class="kpi-value">${formatNumber(kpis.luyKe, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>% Th·ª±c hi·ªán</span><span class="kpi-value">${formatNumber(kpis.htTarget, 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>DT d·ª± ki·∫øn</span><span class="kpi-value">${formatNumber(kpis.dtDuKien, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>% HT d·ª± ki·∫øn</span><span class="kpi-value" style="color: ${getColor(kpis.htDuKien)}">${formatNumber(kpis.htDuKien, 2)}%</span></div>
                    </div>
                </div>
                <div class="kpi-group-card">
                    <div class="kpi-group-header orange"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 2v9h9a9 9 0 00-9-9zm2 1.08a7 7 0 016.92 6.92H13V3.08zM4 12a8 8 0 018-8v8H4zm9 8a8 8 0 01-8-8h8v8z"/></svg>PH√ÇN T√çCH CHI TI·∫æT</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,9L8,13H11V17H13V13H16L12,9Z"/></svg>M·ª•c ti√™u ng√†y</span><span class="kpi-value">${formatNumber(kpis.mucTieuNgay, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24">${iconDoanhThuConLai}</svg>Doanh thu c√≤n l·∫°i</span><span class="kpi-value" style="color: ${doanhThuConLaiColor}; font-size: ${doanhThuConLai <= 0 ? '1.8em' : '1.15em'}">${doanhThuConLaiDisplay}</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>% TƒÉng tr∆∞·ªüng</span><span class="kpi-value" style="color: ${kpis.growthRate >= 0 ? '#06D7A0' : '#F04770'}">${kpis.growthRate >= 0 ? '‚ñ≤' : '‚ñº'} ${formatNumber(Math.abs(kpis.growthRate), 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>¬± DT c√πng k·ª≥</span><span class="kpi-value" style="color: ${kpis.chenhLech >= 0 ? '#06D7A0' : '#F04770'}">${kpis.chenhLech >= 0 ? '‚ñ≤' : '‚ñº'} ${formatNumber(Math.abs(kpis.chenhLech), 0)}</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M21,11H12.42A3,3 0 0,1 12,11.58V13.42A3,3 0 0,1 12.42,14H21V16H12.42A3,3 0 0,1 10,18.42V20H8V18.42A3,3 0 0,1 5.58,16H3V14H5.58A3,3 0 0,1 8,11.58V10H10V11.58A3,3 0 0,1 12.42,14H15V12H12.42A3,3 0 0,1 10,9.58V8H8V9.58A3,3 0 0,1 5.58,12H3V10H5.58A3,3 0 0,1 8,7.58V6H10V7.58A3,3 0 0,1 12.42,10H21V11Z"/></svg>T·ª∑ tr·ªçng tr·∫£ g√≥p</span><span class="kpi-value" style="color: ${kpis.tyTrongTraGop < 20 ? '#F04770' : '#06D7A0'}">${formatNumber(kpis.tyTrongTraGop, 1)}%</span></div>
                    </div>
                </div>
                <div class="kpi-group-card">
                    <div class="kpi-group-header red"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20H4V8h6m0 12V8H4a2 2 0 00-2 2v8a2 2 0 002 2h6m8-14h-4a2 2 0 00-2 2v10a2 2 0 002 2h4a2 2 0 002-2V8a2 2 0 00-2-2m-4 12V8h4v10h-4z"/></svg>N·ª¢ & M·ª§C TI√äU N·ª¢</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.5 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/></svg>DT N·ª£ nƒÉm</span><span class="kpi-value">${formatNumber(yearlyRemaining, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>% HT nƒÉm</span><span class="kpi-value" style="color: ${getColor(yearlyPercent)}">${formatNumber(yearlyPercent, 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 13h-2V7h2m0 10h-2v-2h2M12 2A10 10 0 1 0 22 12 10 10 0 0 0 12 2Z"/></svg>M·ª•c ti√™u tr·∫£ n·ª£/ng√†y</span><span class="kpi-value">${formatNumber(mucTieuTraNoNgay, 0)} Tri·ªáu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,12.5A1.5,1.5 0 0,1 10.5,11A1.5,1.5 0 0,1 12,9.5A1.5,1.5 0 0,1 13.5,11A1.5,1.5 0 0,1 12,12.5M12,7.2C9.9,7.2 8.2,8.9 8.2,11C8.2,14 12,17.5 12,17.5C12,17.5 15.8,14 15.8,11C15.8,8.9 14.1,7.2 12,7.2M12,2A9,9 0 0,0 3,11C3,15.55 10.04,21.86 11.23,22.77C11.5,23 11.75,23.06 12,23.06C12.25,23.06 12.5,23 12.77,22.77C13.96,21.86 21,15.55 21,11A9,9 0 0,0 12,2Z"/></svg>${kyVongLabel}</span><span class="kpi-value" style="color: var(--danger-color); font-weight: bold;">${formatNumber(mucTieuNgayKyVong, 0)} Tri·ªáu</span></div>
                    </div>
                </div>
            `;
        }
        
        function renderLuyKeCharts(data) {
            const chartData = data.filter(row => row["DTQƒê"] > 0);
            const growthData = data.filter(r => r.DTQƒê !== 0 || (r["+/- DTCK Th√°ng (Qƒê)"] !== 0 && r["+/- DTCK Th√°ng (Qƒê)"] !== -100));
            
            const contributionWrapper = document.getElementById('contribution-chart-wrapper');
            contributionWrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M11 2v9h9a9 9 0 00-9-9zm2 1.08a7 7 0 016.92 6.92H13V3.08zM4 12a8 8 0 018-8v8H4zm9 8a8 8 0 01-8-8h8v8z"/></svg>T·ª∑ tr·ªçng Doanh thu</h2><div class="chart-container" style="height: 300px;"><canvas id="contributionChart"></canvas></div>`;
            const growthWrapper = document.getElementById('growth-chart-wrapper');
            growthWrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M22,21H2V3H4V19H22V21M18,17V9H20V17H18M14,17V12H16V17H14M10,17V5H12V17H10M6,17V14H8V17H6Z"/></svg>TƒÉng/Gi·∫£m C√πng k·ª≥</h2><div class="chart-container" style="height: 300px;"><canvas id="growthDriverChart"></canvas></div>`;
            
            const sortedDataByDT = [...chartData].sort((a, b) => b.DTQƒê - a.DTQƒê);
            const top6 = sortedDataByDT.slice(0, 6);
            const othersValue = sortedDataByDT.slice(6).reduce((s, r) => s + r.DTQƒê, 0);
            if (othersValue > 0) {
                top6.push({ "Nh√≥m ng√†nh h√†ng": "Ng√†nh h√†ng kh√°c", "DTQƒê": othersValue });
            }

            const contributionLabels = top6.map(d => d["Nh√≥m ng√†nh h√†ng"]);
            const contributionValues = top6.map(d => d.DTQƒê);
            
            const contributionChart = new Chart('contributionChart', { 
                type: 'doughnut', 
                data: { 
                    labels: contributionLabels, 
                    datasets: [{ 
                        data: contributionValues, 
                        backgroundColor: VIBRANT_PALETTE 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            formatter: (v, ctx) => { 
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); 
                                const p = (v * 100 / total).toFixed(0) + '%'; 
                                const l = ctx.chart.data.labels[ctx.dataIndex]; 
                                return `${l}\n${formatNumber(v, 0)}\n(${p})`;
                            }, 
                            color: '#fff', 
                            font: { weight: 'bold', size: 12 }, 
                            textStrokeColor: 'rgba(0,0,0,0.5)', 
                            textStrokeWidth: 2 
                        } 
                    } 
                } 
            });
            allChartsLuyKe.push(contributionChart);

            const calcData = growthData.map(r => ({ name: r["Nh√≥m ng√†nh h√†ng"], diff: r.DTQƒê - ((1 + r["+/- DTCK Th√°ng (Qƒê)"] / 100) !== 0 ? r.DTQƒê / (1 + r["+/- DTCK Th√°ng (Qƒê)"] / 100) : 0) })).filter(d => d.diff !== 0).sort((a, b) => a.diff - b.diff);
            const growthDriverChart = new Chart('growthDriverChart', { type: 'bar', data: { labels: calcData.map(d => d.name), datasets: [{ data: calcData.map(d => d.diff), backgroundColor: VIBRANT_PALETTE }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold', size: 12 }, textStrokeColor: 'rgba(0,0,0,0.5)', textStrokeWidth: 2, formatter: (v) => formatNumber(v), anchor: 'center', align: 'center' } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } } });
            allChartsLuyKe.push(growthDriverChart);
        }
        
        function renderLuyKeContestTable(processedContest) {
            const wrapper = document.getElementById('contest-table-luyke-wrapper');
            if (!processedContest.all || processedContest.all.length === 0) {
                wrapper.innerHTML = '<h2>B·∫£ng chi ti·∫øt Thi ƒëua</h2><p>Kh√¥ng c√≥ d·ªØ li·ªáu thi ƒëua.</p>';
                return;
            }

            const completedItems = processedContest.onTrack.length;
            const totalItems = processedContest.all.length;
            const progressPercentContest = totalItems > 0 ? (completedItems / totalItems * 100) : 0;
            const contestProgressColor = getColor(progressPercentContest, 50, 80);
            const progressBarHtml = `
                <div class="progress-bar-container" style="padding: 0 0 25px 0;">
                    <div class="progress-labels">
                        <span>Ti·∫øn ƒë·ªô V·ªÅ ƒê√≠ch (D·ª± ki·∫øn)</span>
                        <span>${completedItems} / ${totalItems} Nh√≥m</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${progressPercentContest}%; background-color: ${contestProgressColor};"></div>
                    </div>
                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(progressPercentContest, 1)}%</span></div>
                </div>`;

            const topPerformers = processedContest.all.filter(p => p.percentProjected >= 70);
            const needsImprovement = processedContest.all.filter(p => p.percentProjected < 70);

            const createProgressBar = (percent) => {
                const color = getColor(percent);
                const displayPercent = Math.min(percent, 120);
                return `
                    <div class="bar-wrapper">
                        <span class="bar-percent-text" style="color: ${color};">${formatNumber(percent, 1)}%</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width: ${displayPercent}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
            };

            const createContestDetailTable = (data, title, titleClass, isTopPerformer = false) => {
                if (data.length === 0) return '';
                
                let tableRows = data.map((item, index) => {
                    const rank = index + 1;
                    const icon = isTopPerformer && rank === 1 ? 'üèÜ' : (item.percentProjected >= 100 ? 'üöÄ' : '');
                    const tooltipText = item.percentProjected < 50 ? "C·∫ßn t·∫≠p trung cao ƒë·ªô!" : item.percentProjected < 70 ? "C·∫ßn c·∫£i thi·ªán th√™m!" : "Duy tr√¨ phong ƒë·ªô t·ªët!";
                    
                    const remainingCell = item.remaining <= 0
                        ? `<td style="color: var(--success-color); font-weight: bold;">Ho√†n th√†nh</td>`
                        : `<td class="col-negative">${formatNumber(item.remaining, 1)}</td>`;

                    return `
                        <tr data-category-name="${item.name.toLowerCase()}">
                            <td class="col-rank">${icon} ${rank}</td>
                            <td class="col-category">
                                <div class="tooltip">${item.name}<span class="tooltiptext">${tooltipText}</span></div>
                            </td>
                            <td>${formatNumber(item.dailyTarget, 1)}</td>
                            <td>${formatNumber(item.target)}</td>
                            <td>${formatNumber(item.actual)}</td>
                            ${remainingCell}
                            <td class="progress-bar-cell">${createProgressBar(item.percentActual)}</td>
                            <td class="progress-bar-cell">${createProgressBar(item.percentProjected)}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="contest-group">
                        <h3 class="contest-group-title ${titleClass}">
                            ${isTopPerformer ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.34,9.32l-1.4-4.29A2,2,0,0,0,17.09,4H6.91a2,2,0,0,0-1.85,1L3.66,9.32a1,1,0,0,0,.37,1.1l.49,.35-.16,1.8-3.2,3.2A1,1,0,0,0,2,17v3a1,1,0,0,0,1,1H21a1,1,0,0,0,1-1V17a1,1,0,0,0-.78-1.23l-3.2-3.2.16-1.8.49-.35a1,1,0,0,0,.37-1.1ZM12,6a3,3,0,1,1-3,3A3,3,0,0,1,12,6Z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12,6a3.91,3.91,0,0,0-4,4,3.91,3.91,0,0,0,4,4,3.91,3.91,0,0,0,4-4,3.91,3.91,0,0,0-4-4Zm0,6a1.94,1.94,0,0,1-2-2,1.94,1.94,0,0,1,2-2,1.94,1.94,0,0,1,2,2,1.94,1.94,0,0,1-2,2Zm8.72,2.72L18,11.85V7a1,1,0,0,0-1-1H7A1,1,0,0,0,6,7v4.85L3.28,14.72A2,2,0,0,0,3,16.15V19a2,2,0,0,0,2,2H19a2,2,0,0,0,2-2v-2.85a2,2,0,0,0-.28-1.43ZM19,19H5V16.15l3-3V7H16v6.15l3,3Z"/></svg>'}
                            ${title} (${data.length})
                        </h3>
                        <div class="table-responsive">
                            <table class="contest-detail-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">#</th>
                                        <th class="col-category">Ng√†nh h√†ng</th>
                                        <th>MT Ng√†y</th>
                                        <th>Target</th>
                                        <th>L≈©y k·∫ø</th>
                                        <th>C√≤n l·∫°i</th>
                                        <th>% HT</th>
                                        <th>% HT D·ª± ki·∫øn</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };
            
            const finalHtml = `
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" /></svg>B·∫£ng Chi Ti·∫øt Thi ƒêua Ng√†nh H√†ng</h2>
                ${progressBarHtml}
                <div class="contest-split-layout">
                    ${createContestDetailTable(topPerformers, 'Ng√†nh H√†ng Hi·ªáu Qu·∫£', 'top-performers', true)}
                    ${createContestDetailTable(needsImprovement, 'Ng√†nh H√†ng C·∫ßn C·∫£i Thi·ªán', 'needs-improvement')}
                </div>
            `;
            
            wrapper.innerHTML = finalHtml;
        }
        
        function renderYearlyRevenueChart(yearlyData, kpis, reportDate) {
            const wrapper = document.getElementById('yearly-revenue-chart-wrapper');
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3H6V1H8V3H16V1H18V3H19M19,19V8H5V19H19Z"/></svg>Doanh thu NƒÉm</h2><div class="chart-container" style="height: 300px;"><canvas id="yearlyRevenueChart"></canvas></div>`;
            
            const currentMonth = reportDate.getMonth() + 1;
            const labels = yearlyData.map(d => `Th ${d['Th√°ng']}`);
            const targets = yearlyData.map(d => d['Target th√°ng']);
            const actuals = yearlyData.map(d => {
                return parseInt(d['Th√°ng']) === currentMonth ? kpis.dtDuKien : d['Doanh thu th√°ng'];
            });

            const yearlyChart = new Chart('yearlyRevenueChart', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Target th√°ng',
                            data: targets,
                            backgroundColor: VIBRANT_PALETTE[4],
                            borderColor: VIBRANT_PALETTE[4],
                            borderWidth: 1,
                            datalabels: {
                                color: 'var(--text-muted)',
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value > 0 ? formatNumber(value) : '',
                            }
                        },
                        {
                            label: 'Doanh thu th·ª±c hi·ªán',
                            data: actuals,
                            backgroundColor: VIBRANT_PALETTE[0],
                            borderColor: VIBRANT_PALETTE[0],
                            borderWidth: 1,
                            datalabels: {
                                color: 'var(--text-primary)',
                                anchor: 'end',
                                align: 'top',
                                offset: -5,
                                font: { weight: 'bold' },
                                formatter: (value, context) => {
                                    if (!value || value === 0) return '';
                                    const targetValue = context.chart.data.datasets[0].data[context.dataIndex];
                                    const percentage = targetValue > 0 ? `(${(value / targetValue * 100).toFixed(0)}%)` : '';
                                    return `${formatNumber(value)}\n${percentage}`;
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false 
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false 
                            }
                        }
                    }
                }
            });
            allChartsLuyKe.push(yearlyChart);
        }

        function renderDailyComparisonChart(dailyData, yearlyData, kpis, reportDate, daysInMonth) {
            const wrapper = document.getElementById('daily-comparison-chart-wrapper');
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H18V1M17,12H12V17H17V12Z"/></svg>So s√°nh Doanh thu Ng√†y</h2><div class="chart-container" style="height: 300px;"><canvas id="dailyComparisonChart"></canvas></div>`;
            
            const currentMonth = reportDate.getMonth() + 1;
            const monthTargetData = yearlyData.find(row => parseInt(row['Th√°ng']) === currentMonth);
            const monthTarget = monthTargetData ? (monthTargetData['Target th√°ng'] || 0) : 0;
            const dailyTarget = monthTarget > 0 && daysInMonth > 0 ? monthTarget / daysInMonth : (kpis.target > 0 && daysInMonth > 0 ? kpis.target / daysInMonth : 0);

            const labels = Array.from({ length: daysInMonth }, (_, i) => `Ng√†y ${i + 1}`);

            const thisMonthRevenue = new Array(daysInMonth).fill(null);
            const lastMonthRevenue = new Array(daysInMonth).fill(null);
            
            const currentDay = reportDate.getDate();
            dailyData.forEach(d => {
                const dayIndex = parseInt(d['Ng√†y']) - 1;
                if (dayIndex >= 0 && dayIndex < daysInMonth) {
                    if (d['DT Th√°ng n√†y'] > 0 && (dayIndex + 1) <= currentDay) {
                        thisMonthRevenue[dayIndex] = d['DT Th√°ng n√†y'];
                    }
                    if (d['DT Th√°ng tr∆∞·ªõc'] > 0) {
                        lastMonthRevenue[dayIndex] = d['DT Th√°ng tr∆∞·ªõc'];
                    }
                }
            });

            const weekendColorCallback = (context) => {
                const day = context.dataIndex + 1;
                const date = new Date(reportDate.getFullYear(), reportDate.getMonth(), day);
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6 ? '#F04770' : '#108AB1';
            };

            const dailyChart = new Chart('dailyComparisonChart', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hi·ªán t·∫°i',
                            data: thisMonthRevenue,
                            backgroundColor: weekendColorCallback,
                            order: 2,
                            datalabels: {
                                display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null,
                                formatter: (value) => formatNumber(value, 0),
                                color: (ctx) => weekendColorCallback(ctx),
                                align: 'top',
                                anchor: 'end',
                                offset: -5,
                                font: { weight: 'bold' }
                            }
                        },
                        {
                            type: 'line',
                            label: 'Th√°ng tr∆∞·ªõc',
                            data: lastMonthRevenue,
                            borderColor: '#5A7A84', 
                            backgroundColor: '#5A7A84',
                            pointBackgroundColor: (context) => {
                                if (context.dataIndex === null || context.dataIndex >= daysInMonth) return '#5A7A84';
                                const day = context.dataIndex + 1;
                                const prevMonthDate = new Date(reportDate.getFullYear(), reportDate.getMonth() - 1, day);
                                const dayOfWeek = prevMonthDate.getDay();
                                return dayOfWeek === 0 || dayOfWeek === 6 ? '#F04770' : '#5A7A84';
                            },
                            borderDash: [5, 5],
                            pointRadius: 4,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            order: 1,
                            datalabels: {
                                display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null,
                                formatter: (value) => formatNumber(value, 0),
                                color: '#5A7A84',
                                align: 'bottom',
                                font: { size: 10 }
                            }
                        },
                        {
                            type: 'line',
                            label: 'Target',
                            data: Array(daysInMonth).fill(dailyTarget),
                            borderColor: '#FFD167', 
                            backgroundColor: '#FFD167',
                            borderDash: [10, 5], 
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            order: 0,
                            datalabels: {
                                display: true,
                                color: '#FFD167',
                                align: 'end',
                                anchor: 'end',
                                formatter: (value, context) => context.dataIndex === Math.floor(daysInMonth / 2) ? formatNumber(value, 0) : '',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                             labels: {
                                usePointStyle: true,
                            }
                        },
                        datalabels: {
                            display: true,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: {
                                callback: (value) => formatNumber(value, 0)
                            }
                        },
                        x: {
                             grid: { display: false },
                             ticks: {
                                 callback: function(val) {
                                     return this.getLabelForValue(val).replace('Ng√†y ','');
                                 },
                                 autoSkip: false,
                                 maxRotation: 0,
                                 minRotation: 0
                             }
                        }
                    }
                }
            });
            allChartsLuyKe.push(dailyChart);
        }


        function renderLuyKeCategoryTables(data) {
            const categoryContainer = document.getElementById('category-table-container');
            const categoryData = data.filter(d => d["DTQƒê"] > 0).sort((a,b) => b.DTQƒê - a.DTQƒê);

            if (categoryData.length === 0) {
                categoryContainer.innerHTML = '<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>B·∫£ng Chi ti·∫øt Ng√†nh h√†ng</h2><p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
                return;
            }

            const midpoint = Math.ceil(categoryData.length / 2);
            const leftData = categoryData.slice(0, midpoint);
            const rightData = categoryData.slice(midpoint);

            const createTableHtml = (data) => {
                let tableHtml = '<table><thead><tr><th>Ng√†nh h√†ng</th><th>Doanh thu</th><th>Target</th><th>%HT</th></tr></thead><tbody>';
                data.forEach(row => { 
                    tableHtml += `<tr><td>${row["Nh√≥m ng√†nh h√†ng"]}</td><td>${formatNumber(row["DTQƒê"])}</td><td>${formatNumber(row["Target (Qƒê)"])}</td><td style="color: ${getColor(row["% HT Target (Qƒê)"])}">${formatNumber(row["% HT Target (Qƒê)"], 1)}%</td></tr>`; 
                });
                tableHtml += '</tbody></table>';
                return tableHtml;
            };

            categoryContainer.innerHTML = `
                <h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>B·∫£ng Chi ti·∫øt Ng√†nh h√†ng</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
                    <div>${createTableHtml(leftData)}</div>
                    <div>${rightData.length > 0 ? createTableHtml(rightData) : ''}</div>
                </div>
            `;
        }
        
        function renderLuyKeSummary(kpis, contest, reportDate) {
            const container = document.getElementById('summary-report-wrapper-luyke');
            container.style.display = 'block';
            if (!kpis) { container.innerHTML = ''; return; }
            
            const dateToUse = reportDate || new Date();
            const dateString = `ng√†y ${dateToUse.getDate()}/${dateToUse.getMonth() + 1}/${dateToUse.getFullYear()}`;
            const growthText = kpis.chenhLech >= 0 ? 'TƒÉng' : 'Gi·∫£m';

            const createSubListWithActual = (items, showDailyTarget = false) => {
                if (!items || items.length === 0) return '';
                return items.map(item =>
                    `  - ${item.name} (${formatNumber(item.percentActual, 1)}%)` +
                    (showDailyTarget && item.dailyTarget > 0 ? `: c·∫ßn ${formatNumber(item.dailyTarget, 1)}/ng√†y` : '')
                ).join('\n');
            };

            const onTrackCount = contest.onTrack.length;
            const totalCount = contest.all.length;
            
            let contestSummarySections = [];
            if (contest.veDich_actual.length > 0) {
                contestSummarySections.push(`‚úÖ ƒê√É V·ªÄ ƒê√çCH (${contest.veDich_actual.length} nh√≥m):\n${createSubListWithActual(contest.veDich_actual)}`);
            }
            if (contest.canCoGang_actual.length > 0) {
                contestSummarySections.push(`üí™ C·∫¶N C·ªê G·∫ÆNG (${contest.canCoGang_actual.length} nh√≥m - HT >80%):\n${createSubListWithActual(contest.canCoGang_actual, true)}`);
            }
            if (contest.canTapTrung_actual.length > 0) {
                contestSummarySections.push(`üéØ C·∫¶N T·∫¨P TRUNG (${contest.canTapTrung_actual.length} nh√≥m - HT >50%):\n${createSubListWithActual(contest.canTapTrung_actual, true)}`);
            }
            if (contest.baoDong_actual.length > 0) {
                const baoDongList = contest.baoDong_actual.map(item => `${item.name} (${formatNumber(item.percentActual, 1)}%)`).join(', ');
                contestSummarySections.push(`üö® B√ÅO ƒê·ªòNG (${contest.baoDong_actual.length} nh√≥m - HT <50%): ${baoDongList}`);
            }

            const summaryText = `üìä B√ÅO C√ÅO S·ª®C KHO·∫∫ SI√äU TH·ªä - ${dateString} üìä
-------------------
- üéØ Target Th√°ng: ${formatNumber(kpis.target)}
- üìà Lu·ªπ k·∫ø ƒë·∫°t: ${formatNumber(kpis.luyKe)} (${formatNumber(kpis.htTarget, 1)}%)
- üìâ DT c√≤n l·∫°i: ${formatNumber(kpis.target - kpis.luyKe)}
- üöÄ D·ª± ki·∫øn ƒë·∫°t: ${formatNumber(kpis.dtDuKien)} (${formatNumber(kpis.htDuKien, 1)}%)
- üíπ So v·ªõi c√πng k·ª≥: ${growthText} ${formatNumber(Math.abs(kpis.chenhLech))} (${kpis.growthRate}%)
- üí≥ T·ª∑ tr·ªçng tr·∫£ g√≥p: ${formatNumber(kpis.tyTrongTraGop, 2)}%
- üíµ Doanh thu tr·∫£ g√≥p: ${formatNumber(kpis.doanhThuTraGop)}
- üí∞ M·ª•c ti√™u ng√†y: ${formatNumber(kpis.mucTieuNgay > 0 ? kpis.mucTieuNgay : 0)}
- üèÜ S·ªë ng√†nh h√†ng thi ƒëua d·ª± ki·∫øn ƒë·∫°t: ${onTrackCount}/${totalCount}
-------------------
${contestSummarySections.join('\n\n')}`.trim();

            const html = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z" /></svg>Nh·∫≠n x√©t (D·∫°ng vƒÉn b·∫£n)</h2>
                                 <textarea class="summary-textarea" readonly>${summaryText}</textarea>
                                 <button class="action-btn copySummaryBtn" style="width: 100%; max-width: 400px; margin: 15px auto 0 auto;">
                                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                                     Sao ch√©p Nh·∫≠n x√©t
                                 </button>`;
            container.innerHTML = html;
            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = e.currentTarget.previousElementSibling;
                textarea.select();
                document.execCommand('copy');
                showToast('ƒê√£ sao ch√©p nh·∫≠n x√©t!');
            });
        }

        function displayLuyKeHiddenTables(mainData, contestData) { 
            const mainWrapper = document.getElementById('main-table-wrapper'); mainWrapper.innerHTML = '<h2>B·∫£ng 1: D·ªØ li·ªáu Kinh doanh</h2><table id="main-data-table"></table>'; const mainTable = document.getElementById('main-data-table'); const mainHeaders = Object.keys(mainData[0]); const mainThead = mainTable.createTHead(); mainThead.insertRow().innerHTML = mainHeaders.map(h => `<th>${h}</th>`).join(''); const mainTbody = mainTable.createTBody(); mainData.forEach(rowData => { const row = mainTbody.insertRow(); row.innerHTML = mainHeaders.map(header => { let value = rowData[header]; let cellContent = typeof value === 'number' ? formatNumber(value,2) : value; if (header.includes('%') || header.includes('T·ª∑ Tr·ªçng')) cellContent += '%'; return `<td>${cellContent}</td>`; }).join(''); }); 
            const compWrapper = document.getElementById('comparison-table-wrapper'); compWrapper.innerHTML = '<h2>B·∫£ng 2: So s√°nh C√πng k·ª≥</h2><table id="comparison-table"></table>'; const compTable = document.getElementById('comparison-table'); const compHeaders = ["Nh√≥m ng√†nh h√†ng", "DT Th√°ng n√†y (Qƒê)", "DT Th√°ng tr∆∞·ªõc (∆Ø·ªõc t√≠nh)", "+/- C√πng k·ª≥", "Ch√™nh l·ªách (Qƒê)"]; const compThead = compTable.createTHead(); compThead.insertRow().innerHTML = compHeaders.map(h => `<th>${h}</th>`).join(''); const compTbody = compTable.createTBody(); mainData.filter(r => r["DTQƒê"] > 0 || r["+/- DTCK Th√°ng (Qƒê)"] !== 0).forEach(rowData => { const dtThis = rowData["DTQƒê"], growth = rowData["+/- DTCK Th√°ng (Qƒê)"]; const dtLast = (1 + growth / 100) !== 0 ? dtThis / (1 + growth / 100) : 0; const diff = dtThis - dtLast; const row = compTbody.insertRow(); const diffClass = diff > 0 ? 'text-green' : diff < 0 ? 'text-red' : ''; row.innerHTML = `<td>${rowData["Nh√≥m ng√†nh h√†ng"]}</td><td>${formatNumber(dtThis)}</td><td>${formatNumber(dtLast)}</td><td>${growth}%</td><td class="${diffClass}">${formatNumber(diff)}</td>`; });
            const contestWrapper = document.getElementById('contest-tables-wrapper'); contestWrapper.innerHTML = ""; if(contestData && contestData.length > 0) { contestData.forEach((contest, idx) => { const tableContainer = document.createElement('div'); tableContainer.className = 'table-container'; tableContainer.innerHTML = `<h2 style="margin-top: 25px;">B·∫£ng ${3+idx}: Thi ƒëua - ${contest.headers[0]}</h2><table class="contest-data-table"></table>`; const table = tableContainer.querySelector('.contest-data-table'); const thead = table.createTHead(); thead.insertRow().innerHTML = contest.headers.map(h => `<th>${h}</th>`).join(''); const tbody = table.createTBody(); contest.rows.forEach(rowData => { const row = tbody.insertRow(); row.innerHTML = rowData.map(cell => `<td>${cell}</td>`).join(''); }); contestWrapper.appendChild(tableContainer); }); }
        }
    }
	</script>
</body>
</html>