<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Real-time - v218.47 (Fixed)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-accent: #108AB1;
            --success-color: #06D7A0;
            --warning-color: #FFD167;
            --danger-color: #F04770;
            --secondary-accent: #F78C6A;
            --text-primary: #073A4B;
            --text-on-dark: #FFFFFF;
            --text-muted: #5A7A84;
            --bg-main: #F4F7F9; 
            --border-main: #DDE3E7;
            --shadow-main: 
                0px 2.8px 2.2px rgba(7, 58, 75, 0.02),
                0px 6.7px 5.3px rgba(7, 58, 75, 0.028),
                0px 12.5px 10px rgba(7, 58, 75, 0.035),
                0px 22.3px 17.9px rgba(7, 58, 75, 0.042),
                0px 41.8px 33.4px rgba(7, 58, 75, 0.05),
                0px 100px 80px rgba(7, 58, 75, 0.07);
        }
        .capture-mode .card,
        .capture-mode .input-section,
        .capture-mode .action-btn,
        .capture-mode .sub-kpi-card {
            box-shadow: none !important;
            transform: none !important;
            transition: none !important;
        }
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--bg-main); 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            color: var(--text-primary); 
        }
        .container { 
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }
        header { text-align: center; margin-bottom: 10px; }
        header h1 { color: var(--text-primary); margin: 0; font-size: 2.5em; font-weight: 700; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .input-section, .card { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid var(--border-main); 
            box-shadow: var(--shadow-main);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .input-section h4 { margin-top: 0; color: var(--text-muted); }
        .input-section h4 a { color: inherit; text-decoration: none; transition: color 0.2s; }
        .input-section h4 a:hover { color: var(--primary-accent); }
        textarea { width: 100%; padding: 10px; border: 1px solid var(--border-main); background: #f8f9fa; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; }
        .mainDataInput, .contestDataInput { height: 120px; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; width: 100%; margin-top: 25px; }
        .input-wrapper { display: flex; flex-direction: column; }
        .paste-btn-container { display: flex; justify-content: flex-end; padding-top: 8px; }
        .paste-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.2s;
        }
        .paste-btn:hover {
            opacity: 1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(16, 138, 177, 0.4);
        }
        .action-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            padding: 15px; 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--text-on-dark); 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.2);
            flex-grow: 1;
            max-width: 300px;
        }
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 10px rgba(0,0,0,0.15), inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.15), inset 0 1px 0 rgba(0,0,0,0.2);
        }
        .action-btn svg { width: 20px; height: 20px; }
        .analyzeBtn { background: var(--primary-accent); }
        .captureBtn { background: linear-gradient(45deg, var(--success-color), #05B386); }
        .copySummaryBtn { background: linear-gradient(45deg, var(--primary-accent), #0d6c8b); }
        .dashboard-body { display: none; margin-top: 15px; }
        .report-title { text-align: center; font-size: 1.8em; font-weight: 700; margin: 10px 0 0 0; color: var(--text-primary); }
        #capture-area-rt > * + * { margin-top: 25px; }
        #capture-content-rt > * + * { margin-top: 25px; }
        .progress-bar-container { padding: 15px 25px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 1em; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); }
        .progress-track { width: 100%; height: 18px; background-color: #e9ecef; border-radius: 9px; overflow: hidden; border: 1px solid #ddd; }
        .progress-fill { height: 100%; background: var(--primary-accent); border-radius: 9px; transition: width 0.8s ease-out; }
        .progress-text-wrapper {
            text-align: center;
            margin-top: 4px;
            font-size: 0.9em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        .kpi-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
        }
        .sub-kpi-card {
            background: #ffffff;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 8px;
            padding: 20px 10px;
            min-height: 160px;
            border-radius: 15px;
            border: 1px solid var(--border-main);
            box-shadow: var(--shadow-main);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.2s ease-in-out;
        }
        .sub-kpi-card:hover {
            transform: translateY(-5px);
        }
        .sub-kpi-card:not(.kpi-installment-card):hover {
            background-color: #f8f9fa;
        }
        .sub-kpi-card h4 { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.2em; margin: 0; color: var(--text-primary); font-weight: 700; }
        .sub-kpi-card h4 svg { width: 24px; height: 24px; flex-shrink: 0; transition: transform 0.3s ease; }
        .sub-kpi-card:hover h4 svg { transform: scale(1.1); }
        .sub-kpi-card .value { font-size: 4em; font-weight: 700; margin: 0; color: var(--primary-accent); line-height: 1; }
        .sub-kpi-card .sub-text {
            font-size: 1em;
            color: var(--text-primary);
            font-weight: 600;
            margin: 0;
        }
        .kpi-installment-card { justify-content: center; gap: 10px; }
        .kpi-installment-card .text-content { text-align: center; }
        .kpi-installment-card .chart-content { width: 100px; height: 100px; position: relative; margin: 0 auto; }
        .kpi-installment-card .chart-content .chart-inner-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8em; font-weight: 700; color: var(--text-primary); }
        .dashboard-layout-grid { display: grid; gap: 25px; align-items: flex-start; }
        .charts-column { display: flex; flex-direction: column; gap: 25px; }
        .chart-wrapper, .report-section { padding: 25px; min-width: 0; } 
        .report-section h2, .chart-wrapper h2 { font-size: 1.8em; color: var(--primary-accent); text-align: center; margin-top:0; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .chart-wrapper h2 svg, .report-section h2 svg { width: 24px !important; height: 24px !important; flex-shrink: 0; }
        .chart-container { position: relative; width: 100%; }
        .summary-textarea { height: 500px; background-color: #f8f9fa; border: 1px solid var(--border-main); }
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 16px 30px; border-radius: 8px; z-index: 1001; font-size: 1.1em; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: bottom 0.5s ease-in-out; }
        .toast-notification.show { bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }
        .details-toggle { text-align: center; margin-top: 25px; }
        .details-toggle button { font-size: 0.9em; font-weight: 600; background: #6c757d; color: var(--text-on-dark); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .details-toggle button:hover { background-color: #5a6268; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .rt-styled-table {
            width: 100%;
            border-collapse: collapse;
        }
        .rt-styled-table tbody tr {
            border-bottom: 1px solid var(--border-main);
        }
        .rt-styled-table tbody tr:last-of-type {
            border-bottom: none;
        }
        .rt-styled-table th, .rt-styled-table td {
            text-align: center !important;
            vertical-align: middle;
            padding: 10px 8px;
            border-right: 1px solid var(--border-main);
        }
        .rt-styled-table th:last-child, .rt-styled-table td:last-child {
            border-right: none;
        }
        .rt-styled-table td:first-child, .rt-styled-table th:first-child {
            text-align: left !important;
        }
        .rt-styled-table thead th {
            background-color: #f8f9fa;
            color: var(--text-primary);
            font-weight: 600;
        }
        .no-revenue-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px dashed var(--border-main);
            border-radius: 8px;
        }
        .no-revenue-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: var(--text-muted);
            font-size: 1.1em;
            font-weight: 600;
        }
        .no-revenue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px 15px;
            font-size: 0.9em;
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .no-revenue-grid li {
            color: var(--text-primary);
        }
        @media (max-width: 1200px) {
            .kpi-panel { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
            .input-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 992px) {
            .dashboard-layout-grid {grid-template-columns: 1fr !important;}
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            header h1 { font-size: 1.8em; }
            .card { padding: 15px; }
            .report-section h2, .chart-wrapper h2 { font-size: 1.5em; }
            .kpi-panel { grid-template-columns: repeat(2, 1fr); }
            .kpi-installment-card { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header><h1>BI SI√äU TH·ªä ƒêMX SAVICO (REAL-TIME)</h1></header>
        
        <div id="realtimeInputGrid" class="input-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
            <div class="input-section">
                <h4><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnh&rt=1&dm=1" target="_blank" rel="noopener noreferrer">D·ªØ li·ªáu Realtime Ng√†nh h√†ng</a></h4>
                <div class="input-wrapper">
                    <textarea id="realtimeDataInput" class="mainDataInput" placeholder="D√°n d·ªØ li·ªáu ng√†nh h√†ng..."></textarea>
                    <div class="paste-btn-container">
                        <button class="paste-btn" data-target="realtimeDataInput">D√°n Th√¥ng Minh</button>
                    </div>
                </div>
            </div>
            <div class="input-section">
                <h4><a href="https://bi.thegioididong.com/thi-dua-st?id=16753&tab=1&rt=1&dm=2&mt=1" target="_blank" rel="noopener noreferrer">D·ªØ li·ªáu Realtime Thi ƒëua</a></h4>
                <div class="input-wrapper">
                    <textarea id="realtimeContestDataInput" class="contestDataInput" placeholder="D√°n d·ªØ li·ªáu thi ƒëua..."></textarea>
                    <div class="paste-btn-container">
                        <button class="paste-btn" data-target="realtimeContestDataInput">D√°n Th√¥ng Minh</button>
                    </div>
                </div>
            </div>
            <div class="input-section">
                <h4>Doanh thu Nh√¢n vi√™n (D√°n)</h4>
                <div class="input-wrapper">
                    <textarea id="employeeSalesDataInput" class="mainDataInput" placeholder="D√°n d·ªØ li·ªáu doanh thu nh√¢n vi√™n v√†o ƒë√¢y..."></textarea>
                    <div class="paste-btn-container">
                        <button class="paste-btn" data-target="employeeSalesDataInput">D√°n Th√¥ng Minh</button>
                    </div>
                </div>
            </div>
         </div>
         <div class="button-container">
            <button id="analyzeBtn-rt" class="action-btn analyzeBtn">T·∫†O DASHBOARD REAL-TIME</button>
            <button id="showInputsBtnRt" class="action-btn" style="display: none; background: #6c757d;">Ch·ªânh s·ª≠a D·ªØ li·ªáu</button>
            <button id="captureBtnRt" class="action-btn captureBtn">
               <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
               Ch·ª•p ·∫£nh B√°o c√°o
            </button>
        </div>
        <div id="dashboard-body-rt" class="dashboard-body">
            <div id="capture-area-rt">
                <div id="capture-content-rt">
                    <div id="reportTitleRt" class="report-title"></div>
                    <div class="progress-bar-container card">
                        <div class="progress-labels"><span>Ti·∫øn ƒë·ªô Th·ªùi gian l√†m vi·ªác (8h-22h)</span><span id="progress-summary-time">0%</span></div>
                        <div class="progress-track"><div class="progress-fill" id="progress-fill-time"></div></div>
                        <div class="progress-text-wrapper"><span id="progress-text-time"></span></div>
                    </div>
                    <div class="progress-bar-container card">
                        <div class="progress-labels"><span>Ti·∫øn ƒë·ªô Target Ng√†y</span><span id="progress-summary-target-rt"></span></div>
                        <div class="progress-track"><div class="progress-fill" id="progress-fill-target-rt"></div></div>
                        <div class="progress-text-wrapper"><span id="progress-text-target-rt"></span></div>
                    </div>
                    <div id="kpi-panel-rt" class="kpi-panel"></div>
                    <div id="employee-sales-chart-wrapper" class="card chart-wrapper" style="display: none; padding: 25px;"></div>
                    <div class="dashboard-layout-grid" style="grid-template-columns: 1fr 1fr; align-items: start; gap: 25px;">
                        <div id="contest-table-rt-wrapper" class="report-section card"></div>
                        <div id="category-table-rt-wrapper" class="report-section card"></div>
                    </div>
                </div>
            </div>
            <div id="summary-report-wrapper-rt" class="report-section card" style="display:none;"></div>
            <div id="summary-report-wrapper-rt-employee" class="report-section card" style="display:none; margin-top: 25px;"></div>
        </div>
    </div>
	
	<script>
    /****************************************************************************
     * SMART PASTE FUNCTIONS
     ****************************************************************************/
    function extractData(fullText, regex) {
        const match = fullText.match(regex);
        return (match && match[1]) ? match[1].trim() : '';
    }

    async function handleSmartPaste(targetId) {
        const targetTextarea = document.getElementById(targetId);
        if (!targetTextarea) return;

        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                showToast('Clipboard r·ªóng!', true);
                return;
            }
            
            let extractedData = '';
            switch (targetId) {
                case 'realtimeDataInput':
                    extractedData = extractData(text, /(Nh√≥m ng√†nh h√†ng\tSL Realtime[\s\S]+?)H·ªó tr·ª£ BI/);
                    break;
                case 'realtimeContestDataInput':
                    extractedData = extractData(text, /(Ng√†nh h√†ng\tDT Realtime \(Qƒê\)[\s\S]+?)H·ªó tr·ª£ BI/);
                    break;
                case 'employeeSalesDataInput':
                    extractedData = extractData(text, /(Nh√¢n vi√™n\s+SL\s+DT[\s\S]+)/);
                    break;
                default:
                    extractedData = text;
            }

            targetTextarea.value = extractedData || text;
            showToast('ƒê√£ d√°n v√† l·ªçc d·ªØ li·ªáu th√¥ng minh!');

        } catch (err) {
            console.error('L·ªói khi d√°n: ', err);
            showToast('Kh√¥ng th·ªÉ truy c·∫≠p clipboard. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p c·ªßa tr√¨nh duy·ªát.', true);
        }
    }

    function setupSmartPasteButtons() {
        document.querySelectorAll('.paste-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-target');
                handleSmartPaste(targetId);
            });
        });
    }

    /****************************************************************************
     * SHARED UTILITY & SETUP FUNCTIONS
     ****************************************************************************/
    var VIBRANT_PALETTE = ['#108AB1', '#06D7A0', '#FFD167', '#F78C6A', '#F04770', '#073A4B', '#5A7A84', '#6654A2', '#D65E9A'];
    var formatNumber = (num, decimals = 0) => {
        const number = parseFloat(num);
        if (isNaN(number)) {
            return ''; 
        }
        return number.toLocaleString('vi-VN', { maximumFractionDigits: decimals });
    };
    var getColor = (value, threshold1 = 50, threshold2 = 100) => value < threshold1 ? '#F04770' : value < threshold2 ? '#F78C6A' : '#06D7A0';
    
    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (isError) toast.classList.add('error');
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.parentNode && toast.parentNode.removeChild(toast), 500);
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
        Chart.register(ChartDataLabels);
        Chart.defaults.color = 'var(--text-muted)';
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.font.weight = '600';

        setupRealtimeTab();
        setupSmartPasteButtons();
        
        try {
            document.getElementById('realtimeDataInput').value = localStorage.getItem('realtimeMainData') || '';
            document.getElementById('realtimeContestDataInput').value = localStorage.getItem('realtimeContestData') || '';
            document.getElementById('employeeSalesDataInput').value = localStorage.getItem('employeeSalesData') || '';
        } catch (e) {
            console.error("Could not access localStorage. Data will not be saved.", e);
            showToast("Kh√¥ng th·ªÉ truy c·∫≠p b·ªô nh·ªõ c·ª•c b·ªô. D·ªØ li·ªáu s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.", true);
        }
    });

    /****************************************************************************
     * TAB 2: REAL-TIME LOGIC                                     *
     ****************************************************************************/
    function setupRealtimeTab() {
        let timeInterval;
        let employeeChart = null;
        let installmentChart = null;
        let lastEmployeeData = [];

        document.getElementById('analyzeBtn-rt').addEventListener('click', () => { 
            const mainDataRaw = document.getElementById('realtimeDataInput').value; 
            const contestDataRaw = document.getElementById('realtimeContestDataInput').value; 
            const employeeDataRaw = document.getElementById('employeeSalesDataInput').value;
            
            try {
                localStorage.setItem('realtimeMainData', mainDataRaw);
                localStorage.setItem('realtimeContestData', contestDataRaw);
                localStorage.setItem('employeeSalesData', employeeDataRaw);
            } catch(e) {
                console.error("Could not access localStorage. Data will not be saved.", e);
            }

            if (!mainDataRaw.trim()) { showToast('Vui l√≤ng d√°n d·ªØ li·ªáu Realtime Ng√†nh h√†ng.', true); return; } 
            try { 
                const mainParsedData = parseRealtimeData(mainDataRaw); 
                const contestParsedData = contestDataRaw.trim() ? parseRealtimeData(contestDataRaw) : []; 
                const employeeParsedData = employeeDataRaw.trim() ? parseEmployeeSalesData(employeeDataRaw) : [];

                lastEmployeeData = employeeParsedData;

                document.getElementById('realtimeInputGrid').style.display = 'none';
                document.getElementById('showInputsBtnRt').style.display = 'inline-flex';

                displayRealtimeDashboard(mainParsedData, contestParsedData, employeeParsedData); 
            } catch (error) { 
                showToast("L·ªói x·ª≠ l√Ω d·ªØ li·ªáu Realtime: " + error.message, true); 
                console.error(error); 
            } 
        });

        document.getElementById('showInputsBtnRt').addEventListener('click', function() {
            const inputGrid = document.getElementById('realtimeInputGrid');
            const isHidden = inputGrid.style.display === 'none';
            inputGrid.style.display = isHidden ? 'grid' : 'none';
            this.textContent = isHidden ? '·∫®n M·ª•c Nh·∫≠p Li·ªáu' : 'Ch·ªânh s·ª≠a D·ªØ li·ªáu';
        });
        
        document.getElementById('captureBtnRt').addEventListener('click', () => {
            const dashboardBody = document.getElementById('dashboard-body-rt');
            if (dashboardBody.style.display === 'none') {
                showToast('Ch∆∞a c√≥ d·ªØ li·ªáu Realtime ƒë·ªÉ ch·ª•p ·∫£nh.', true);
                return;
            }
            
            const captureElement = document.getElementById('capture-content-rt');

            const mainContainer = document.querySelector('body');
            mainContainer.classList.add('capture-mode');
            
            setTimeout(() => {
                html2canvas(captureElement, { 
                    useCORS: true, 
                    backgroundColor: '#F4F7F9',
                    scale: 2.5 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `b√°o c√°o realtime ${new Date().toLocaleTimeString('vi-VN')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => { 
                    showToast('L·ªói khi ch·ª•p ·∫£nh. H√£y th·ª≠ l·∫°i.', true);
                    console.error(err);
                }).finally(() => {
                    mainContainer.classList.remove('capture-mode');
                });
            }, 100);
        });

        function parseRealtimeData(text) {
            const lines = text.trim().split('\n').filter(l => l.trim() !== '');
            if (lines.length < 1) {
                return []; 
            }
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            
            const nameIndex = headers.findIndex(h => h.includes("ng√†nh h√†ng"));
            const actualIndex = headers.findIndex(h => h.includes("dt realtime") || h.includes('th·ª±c hi·ªán') || h.includes('dtqƒë') || h.includes('sllk') || h.includes('dtlk'));
            const targetIndex = headers.findIndex(h => h.includes("target ng√†y") || h.includes('target'));
            const percentIndex = headers.findIndex(h => h.includes("% ht target ng√†y") || h.includes('% ht'));
            const installmentIndex = headers.findIndex(h => h.includes("dt tr·∫£ g√≥p"));
            const installmentPercentIndex = headers.findIndex(h => h.includes("t·ª∑ tr·ªçng tr·∫£ g√≥p"));
            const quantityIndex = headers.findIndex(h => h.includes("sl realtime") || h.includes("s·ªë l∆∞·ª£ng"));

            if (nameIndex === -1 || actualIndex === -1 || targetIndex === -1) {
                throw new Error("D·ªØ li·ªáu Realtime thi·∫øu c√°c c·ªôt b·∫Øt bu·ªôc. Vui l√≤ng ki·ªÉm tra l·∫°i ti√™u ƒë·ªÅ c√°c c·ªôt, c·∫ßn c√≥: 'Ng√†nh h√†ng', 'Th·ª±c hi·ªán' (ho·∫∑c 'DT Realtime'), v√† 'Target' (ho·∫∑c 'Target Ng√†y').");
            }

            const dataRows = lines.slice(1);
            return dataRows.map(line => {
                const values = line.split('\t');
                
                const getFloatValue = (index) => {
                    if (index === -1 || index >= values.length || !values[index]) return 0;
                    const cleanedValueStr = values[index].replace(/,/g, '').replace(/%/, '');
                    return parseFloat(cleanedValueStr) || 0;
                }
                
                return {
                    "Nh√≥m ng√†nh h√†ng": values[nameIndex] || '',
                    "DT Realtime (Qƒê)": getFloatValue(actualIndex),
                    "Target Ng√†y (Qƒê)": getFloatValue(targetIndex),
                    "% HT Target Ng√†y (Qƒê)": getFloatValue(percentIndex),
                    "DT Tr·∫£ G√≥p": getFloatValue(installmentIndex),
                    "T·ª∑ tr·ªçng tr·∫£ g√≥p": getFloatValue(installmentPercentIndex),
                    "S·ªë l∆∞·ª£ng": getFloatValue(quantityIndex)
                };
            });
        }
        
        function parseEmployeeSalesData(text) {
            const lines = text.trim().split('\n');
            const data = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || 
                    line.toLowerCase().startsWith('nh√¢n vi√™n') || 
                    line.toLowerCase().startsWith('t·ªïng') ||
                    line.toLowerCase().includes('online')) {
                    return;
                }
                
                const regex = /^(\d+)\s*-\s*(.+?)\s+\d+\s+(-?[\d,.]+)$/;
                const match = line.match(regex);

                if (match) {
                    const id = match[1].trim();
                    const name = match[2].trim();
                    const revenueStr = match[3] || '0'; 
                    const revenue = parseFloat(revenueStr.replace(/,/g, '')) || 0;
                    data.push({ id, name, revenue });
                }
            });
            
            return data;
        }
        
        function displayRealtimeDashboard(mainData, contestData, employeeData) {
            document.getElementById('dashboard-body-rt').style.display = 'block';
            if(timeInterval) clearInterval(timeInterval);
            if(employeeChart) employeeChart.destroy();
            if(installmentChart) installmentChart.destroy();

            renderTimeProgressBar();
            timeInterval = setInterval(renderTimeProgressBar, 60000);

            const totalRow = mainData.find(row => row["Nh√≥m ng√†nh h√†ng"].toLowerCase() === "t·ªïng");
            if (!totalRow) throw new Error("Kh√¥ng t√¨m th·∫•y d√≤ng 'T·ªïng' trong d·ªØ li·ªáu Realtime.");
            
            const processedContestData = processRealtimeContestData(contestData); 

            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute:'2-digit' });
            const currentHour = now.getHours();

            let timeIcon = '';
            if (currentHour < 12) {
                timeIcon = '‚òÄÔ∏è ';
            } else if (currentHour < 18) {
                timeIcon = 'üåá ';
            } else {
                timeIcon = 'üåô ';
            }
            document.getElementById('reportTitleRt').textContent = `${timeIcon}B√°o c√°o doanh thu si√™u th·ªã ƒë·∫øn ${timeString}`;
            
            renderRealtimeKPIs(totalRow, processedContestData);
            renderRealtimeTargetProgress(totalRow);
            renderEmployeeSalesChart(employeeData);
            renderRealtimeContestTable(processedContestData);
            renderRealtimeCategoryTable(mainData);
            
            renderRealtimeSummary(totalRow, processedContestData);
            renderEmployeeSummary(employeeData);
        }

        function getTimePassedFraction() {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0);
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 22, 0, 0);
            if (now <= start) return 0.001; 
            if (now >= end) return 1;
            const totalMinutes = (end - start) / 60000;
            const elapsedMinutes = (now - start) / 60000;
            return elapsedMinutes / totalMinutes;
        }

        function processRealtimeContestData(contestData) {
            if (!contestData || contestData.length === 0) return { all: [], onTrack: [], behind: [], veDich_actual: [], canCoGang_actual: [], canTapTrung_actual: [], baoDong_actual: [] };
            const timeFraction = getTimePassedFraction();
            
            const items = contestData
                .filter(row => row["Nh√≥m ng√†nh h√†ng"].toLowerCase() !== 't·ªïng' && row["Nh√≥m ng√†nh h√†ng"].toLowerCase() !== 'ng√†nh h√†ng')
                .map(row => {
                    const actual = row['DT Realtime (Qƒê)'];
                    const target = row['Target Ng√†y (Qƒê)'];
                    const projectedSales = timeFraction > 0 && timeFraction < 1 ? (actual / timeFraction) : actual;
                    const percentProjected = target > 0 ? (projectedSales / target * 100) : 0;
                    return {
                        name: row['Nh√≥m ng√†nh h√†ng'],
                        actual: actual,
                        target: target,
                        remaining: target - actual,
                        percentProjected: percentProjected,
                        percentActual: row['% HT Target Ng√†y (Qƒê)']
                    };
                })
                .sort((a,b) => b.percentProjected - a.percentProjected);

            return {
                all: items,
                onTrack: items.filter(p => p.percentProjected >= 100),
                behind: items.filter(p => p.percentProjected < 100),
                veDich_actual: items.filter(p => p.percentActual >= 100),
                canCoGang_actual: items.filter(p => p.percentActual >= 80 && p.percentActual < 100),
                canTapTrung_actual: items.filter(p => p.percentActual >= 50 && p.percentActual < 80),
                baoDong_actual: items.filter(p => p.percentActual < 50)
            };
        }

        function renderTimeProgressBar() {
            const percent = getTimePassedFraction() * 100;
            const now = new Date();
            document.getElementById('progress-fill-time').style.width = `${percent}%`;
            document.getElementById('progress-text-time').textContent = `ƒê√£ qua ${formatNumber(percent,1)}% th·ªùi gian (${now.toLocaleTimeString('vi-VN')})`;
            document.getElementById('progress-summary-time').textContent = now.toLocaleTimeString('vi-VN');
        }

        function renderRealtimeTargetProgress(totalRow) {
            const htThuc = totalRow['% HT Target Ng√†y (Qƒê)'];
            const progressFill = document.getElementById('progress-fill-target-rt');
            progressFill.style.width = `${htThuc > 100 ? 100 : htThuc}%`;
            progressFill.style.backgroundColor = getColor(htThuc);
            document.getElementById('progress-text-target-rt').textContent = `Th·ª±c t·∫ø ${formatNumber(htThuc, 1)}%`;
            document.getElementById('progress-summary-target-rt').textContent = `${formatNumber(totalRow['DT Realtime (Qƒê)'])} / ${formatNumber(totalRow['Target Ng√†y (Qƒê)'])}`;
        }

        function renderRealtimeKPIs(totalRow, contestData) {
            const kpiPanel = document.getElementById('kpi-panel-rt');
            const ht = totalRow['% HT Target Ng√†y (Qƒê)'];
            const timeFraction = getTimePassedFraction();
            const projectedSales = timeFraction > 0 && timeFraction < 1 ? (totalRow['DT Realtime (Qƒê)'] / timeFraction) : totalRow['DT Realtime (Qƒê)'];
            const projectedHt = totalRow['Target Ng√†y (Qƒê)'] > 0 ? (projectedSales / totalRow['Target Ng√†y (Qƒê)'] * 100) : 0;
            const onTrackCount = contestData.onTrack.length;
            const totalCount = contestData.all.length;
            const remainingRevenue = totalRow['Target Ng√†y (Qƒê)'] - totalRow['DT Realtime (Qƒê)'];
            const installmentPercent = totalRow['T·ª∑ tr·ªçng tr·∫£ g√≥p'];

            const getInstallmentColor = (percent) => {
                if (percent < 20) return '#F04770';
                if (percent < 30) return '#F78C6A';
                return '#06D7A0';
            };

            const kpis = [
                { id: 'kpi-target', title: 'Target Ng√†y', value: formatNumber(totalRow['Target Ng√†y (Qƒê)']), subtext: 'M·ª•c ti√™u h√¥m nay', icon: '<path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z"/>', iconColor: 'var(--primary-accent)' },
                { id: 'kpi-realtime', title: 'DT Realtime', value: formatNumber(totalRow['DT Realtime (Qƒê)']), subtext: `${formatNumber(ht,1)}% HT`, color: getColor(ht), icon: '<path fill="currentColor" d="M9 14.5A2.5 2.5 0 0 1 6.5 12A2.5 2.5 0 0 1 9 9.5V14.5M9 16.5A4.5 4.5 0 0 0 13.5 12A4.5 4.5 0 0 0 9 7.5V16.5M22 12l-4-4v3H3v2h15v3l4-4Z"/>', iconColor: 'var(--success-color)' },
                { id: 'kpi-remaining', title: 'DT C√≤n l·∫°i', value: remainingRevenue <= 0 ? 'üèÜ' : formatNumber(remainingRevenue), subtext: remainingRevenue <= 0 ? 'ƒê√£ ho√†n th√†nh!' : 'C·∫ßn ƒë·∫°t th√™m', color: remainingRevenue <= 0 ? '#06D7A0' : '#F04770', icon: '<path fill="currentColor" d="M12,6A6,6 0 0,1 18,12C18,14.21 16.84,16.21 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.16,16.21 6,14.21 6,12A6,6 0 0,1 12,6M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/>', iconColor: remainingRevenue <= 0 ? 'var(--warning-color)' : 'var(--danger-color)' },
                { id: 'kpi-projected', title: 'D·ª± ki·∫øn ƒë·∫°t', value: formatNumber(projectedSales), subtext: `${formatNumber(projectedHt, 1)}%`, color: getColor(projectedHt), icon: '<path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/>', iconColor: 'var(--secondary-accent)' },
                { id: 'kpi-contest', title: 'Thi ƒëua ƒë·∫°t', value: `${onTrackCount}/${totalCount}`, subtext: 'Ch∆∞∆°ng tr√¨nh V·ªÅ ƒê√≠ch', icon: '<path fill="currentColor" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>', iconColor: '#6654A2' },
                { id: 'kpi-installment', title: 'T·ª∑ tr·ªçng Tr·∫£ g√≥p', value: `${formatNumber(installmentPercent, 2)}%`, subtext: "DT: " + formatNumber(totalRow['DT Tr·∫£ G√≥p']), icon: '<path fill="currentColor" d="M21,11H12.42A3,3 0 0,1 12,11.58V13.42A3,3 0 0,1 12.42,14H21V16H12.42A3,3 0 0,1 10,18.42V20H8V18.42A3,3 0 0,1 5.58,16H3V14H5.58A3,3 0 0,1 8,11.58V10H10V11.58A3,3 0 0,1 12.42,14H15V12H12.42A3,3 0 0,1 10,9.58V8H8V9.58A3,3 0 0,1 5.58,12H3V10H5.58A3,3 0 0,1 8,7.58V6H10V7.58A3,3 0 0,1 12.42,10H21V11Z"/>', iconColor: '#D65E9A' },
            ];
            
            kpiPanel.innerHTML = kpis.map(kpi => {
                if (kpi.id === 'kpi-installment') {
                    return `<div class="sub-kpi-card kpi-installment-card">
                                <div class="text-content">
                                    <h4><svg class="title-icon" viewBox="0 0 24 24" style="color:${kpi.iconColor};">${kpi.icon}</svg>${kpi.title}</h4>
                                    <p class="sub-text">${kpi.subtext}</p>
                                </div>
                                <div class="chart-content">
                                    <canvas id="installment-pie-chart-rt"></canvas>
                                    <div id="installment-pie-text" class="chart-inner-text"></div>
                                </div>
                            </div>`;
                }
                
                if (kpi.id === 'kpi-remaining' && remainingRevenue <= 0) {
                     kpi.icon = '<path fill="currentColor" d="M20.5,11H19V7A1,1 0 0,0 18,6H16A1,1 0 0,0 15,7V11H9V7A1,1 0 0,0 8,6H6A1,1 0 0,0 5,7V11H3.5A1.5,1.5 0 0,0 2,12.5A1.5,1.5 0 0,0 3.5,14H5V18A3,3 0 0,0 8,21H16A3,3 0 0,0 19,18V14H20.5A1.5,1.5 0 0,0 22,12.5A1.5,1.5 0 0,0 20.5,11M17,11H16V8H17V11M7,11H8V8H7V11Z"/>';
                }

                return `<div class="sub-kpi-card">
                            <h4><svg class="title-icon" viewBox="0 0 24 24" style="color: ${kpi.iconColor};">${kpi.icon}</svg>${kpi.title}</h4>
                            <p class="value" style="color: ${kpi.color || 'var(--primary-accent)'}">${kpi.value}</p>
                            <p class="sub-text">${kpi.subtext}</p>
                        </div>`;
            }).join('');

            const installmentCtx = document.getElementById('installment-pie-chart-rt').getContext('2d');
            document.getElementById('installment-pie-text').textContent = `${formatNumber(installmentPercent, 1)}%`;

            installmentChart = new Chart(installmentCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [installmentPercent, 100 - installmentPercent],
                        backgroundColor: [getInstallmentColor(installmentPercent), '#e9ecef'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: { display: false }
                    }
                }
            });
        }
        
        function renderEmployeeSalesChart(data) {
            const wrapper = document.getElementById('employee-sales-chart-wrapper');
            if (!data || data.length === 0) {
                wrapper.style.display = 'none';
                return;
            }
            wrapper.style.display = 'block';
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>X·∫øp h·∫°ng Doanh thu Nh√¢n vi√™n</h2><div class="chart-container" style="min-height: 450px;"><canvas id="employeeSalesChart"></canvas></div>`;

            const canvas = document.getElementById('employeeSalesChart');
            const ctx = canvas.getContext('2d');
            
            const sortedData = data.sort((a, b) => b.revenue - a.revenue);
            const positiveData = sortedData.filter(d => d.revenue > 0);
            const totalRevenue = positiveData.reduce((sum, item) => sum + item.revenue, 0);

            const labels = sortedData.map(d => {
                const percentage = totalRevenue > 0 && d.revenue > 0 ? (d.revenue / totalRevenue * 100).toFixed(1) : 0;
                return d.revenue > 0 ? [d.name, `(${percentage}% ƒë√≥ng g√≥p)`] : [d.name, ''];
            });
            
            const revenues = sortedData.map(d => d.revenue);

            const positiveRevenues = revenues.filter(r => r > 0);
            const maxRevenue = positiveRevenues.length > 0 ? Math.max(...positiveRevenues) : 0;
            const minRevenue = positiveRevenues.length > 0 ? Math.min(...positiveRevenues) : 0;
            
            const highColor = { r: 6, g: 215, b: 160 };
            const midColor = { r: 255, g: 209, b: 103 };
            const lowColor = { r: 240, g: 71, b: 112 };

            function interpolateColor(color1, color2, factor) {
                let result = { ...color1 };
                for (let i in result) {
                    result[i] = Math.round(result[i] + factor * (color2[i] - result[i]));
                }
                return `rgb(${result.r}, ${result.g}, ${result.b})`;
            }

            function getRevenueColor(value) {
                if (value <= 0) return `rgb(${lowColor.r}, ${lowColor.g}, ${lowColor.b})`;
                if (maxRevenue === minRevenue) return `rgb(${highColor.r}, ${highColor.g}, ${highColor.b})`;
                const percentage = (value - minRevenue) / (maxRevenue - minRevenue);
                return percentage >= 0.5 ? interpolateColor(midColor, highColor, (percentage - 0.5) * 2) : interpolateColor(lowColor, midColor, percentage * 2);
            }

            employeeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: revenues,
                        backgroundColor: (context) => getRevenueColor(context.raw),
                        borderColor: 'rgba(7, 58, 75, 0.4)',
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)', borderDash: [2, 4] },
                            ticks: { callback: (value) => formatNumber(value / 1000000, 1) + 'tr' },
                            suggestedMax: maxRevenue > 0 ? maxRevenue * 1.2 : 0
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 12, weight: '600' },
                                color: '#073A4B'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             enabled: true,
                             backgroundColor: 'rgba(7, 58, 75, 0.9)',
                             callbacks: {
                                 label: (context) => ` Doanh thu: ${formatNumber(context.raw)} VNƒê`
                             }
                        },
                        datalabels: {
                            anchor: (context) => context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start',
                            align: (context) => context.dataset.data[context.dataIndex] >= 0 ? 'end' : 'start',
                            rotation: 0,
                            color: 'var(--text-primary)',
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => value !== 0 ? formatNumber(value / 1000000, 1) + 'tr' : '',
                            offset: 4
                        }
                    }
                }
            });
        }
        
        function renderRealtimeContestTable(processedContest) {
            const wrapper = document.getElementById('contest-table-rt-wrapper');
            if (!processedContest.all || processedContest.all.length === 0) {
                wrapper.innerHTML = '<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M5,4H19A2,2 0 0,1 21,6V18A2,2 0 0,1 19,20H5A2,2 0 0,1 3,18V6A2,2 0 0,1 5,4M5,8V12H11V8H5M13,8V12H19V8H13M5,14V18H11V14H5M13,14V18H19V14H13Z" /></svg>B·∫£ng chi ti·∫øt Thi ƒëua Real-time</h2><p>Kh√¥ng c√≥ d·ªØ li·ªáu thi ƒëua.</p>';
                return;
            }
            wrapper.style.display = 'block';

            const itemsWithRevenue = processedContest.all.filter(item => item.actual > 0);
            const itemsWithoutRevenue = processedContest.all.filter(item => item.actual <= 0);

            const completedItems = processedContest.onTrack.length;
            const totalItems = processedContest.all.length;
            const progressPercentContest = totalItems > 0 ? (completedItems / totalItems * 100) : 0;
            const contestProgressColor = getColor(progressPercentContest);
            const progressBarHtml = `
                <div class="progress-bar-container" style="padding: 0 0 20px 0;">
                    <div class="progress-labels">
                        <span>Ti·∫øn ƒë·ªô V·ªÅ ƒê√≠ch</span>
                        <span>${completedItems} / ${totalItems} Nh√≥m</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${progressPercentContest}%; background-color: ${contestProgressColor};"></div>
                    </div>
                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(progressPercentContest, 1)}%</span></div>
                </div>`;
            
            let tableHtml = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M5,4H19A2,2 0 0,1 21,6V18A2,2 0 0,1 19,20H5A2,2 0 0,1 3,18V6A2,2 0 0,1 5,4M5,8V12H11V8H5M13,8V12H19V8H13M5,14V18H11V14H5M13,14V18H19V14H13Z" /></svg>B·∫£ng chi ti·∫øt Thi ƒëua Real-time</h2>
                                 ${progressBarHtml}
                                 <table class="rt-styled-table">
                                     <thead>
                                         <tr><th>#</th><th>Ng√†nh h√†ng</th><th>DT Realtime</th><th>C√≤n l·∫°i</th><th>Target Ng√†y</th><th>% HT</th><th>% HT D·ª± ki·∫øn</th></tr>
                                     </thead>
                                     <tbody>`;

            itemsWithRevenue.forEach((item, index) => {
                const remainingCell = item.remaining <= 0 ? `<td style="color: var(--success-color); font-weight: bold; font-size: 1.5em;">üèÜ</td>` : `<td style="color: var(--danger-color); font-weight: bold;">${formatNumber(item.remaining, 1)}</td>`;
                const icon = item.percentProjected >= 100 ? ' <span title="D·ª± ki·∫øn ho√†n th√†nh!">üöÄ</span>' : '';
                tableHtml += `<tr>
                    <td>${index + 1}${icon}</td>
                    <td style="text-align: left !important;">${item.name}</td>
                    <td>${formatNumber(item.actual)}</td>
                    ${remainingCell}
                    <td>${formatNumber(item.target)}</td>
                    <td style="color: ${getColor(item.percentActual)}; font-weight: bold;">${formatNumber(item.percentActual, 1)}%</td>
                    <td style="color: ${getColor(item.percentProjected)}; font-weight: bold;">${formatNumber(item.percentProjected, 1)}%</td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            wrapper.innerHTML = tableHtml;

            if (itemsWithoutRevenue.length > 0) {
                 const noRevenueHtml = `<div id="contest-no-revenue-section" class="no-revenue-section" style="display:none;">
                                     <h4>Nh√≥m ch∆∞a ph√°t sinh doanh thu (${itemsWithoutRevenue.length}):</h4>
                                     <ul class="no-revenue-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                                         ${itemsWithoutRevenue.map((item, index) => `<li>${index + 1}. ${item.name}</li>`).join('')}
                                     </ul>
                                   </div>`;
                const buttonHtml = `<div class="details-toggle" style="margin-top: 15px;">
                                    <button id="toggle-contest-no-revenue-btn">
                                        Hi·ªán ${itemsWithoutRevenue.length} nh√≥m ch∆∞a c√≥ DT
                                    </button>
                                </div>`;
                
                wrapper.insertAdjacentHTML('beforeend', buttonHtml + noRevenueHtml);

                const toggleBtn = document.getElementById('toggle-contest-no-revenue-btn');
                const noRevenueSection = document.getElementById('contest-no-revenue-section');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = noRevenueSection.style.display === 'none';
                    noRevenueSection.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? `·∫®n ${itemsWithoutRevenue.length} nh√≥m ch∆∞a c√≥ DT` : `Hi·ªán ${itemsWithoutRevenue.length} nh√≥m ch∆∞a c√≥ DT`;
                });
            }
        }
        
        function renderRealtimeCategoryTable(mainData) {
            const wrapper = document.getElementById('category-table-rt-wrapper');
            if (!mainData || mainData.length === 0) {
                wrapper.style.display = 'none';
                return;
            }
            wrapper.style.display = 'block';

            const totalRow = mainData.find(row => row["Nh√≥m ng√†nh h√†ng"].toLowerCase() === "t·ªïng");
            const categoryData = mainData.filter(row => 
                row["Nh√≥m ng√†nh h√†ng"].toLowerCase() !== "t·ªïng" && 
                row["Target Ng√†y (Qƒê)"] > 0
            );
            
            const categoriesWithRevenue = categoryData.filter(row => row["DT Realtime (Qƒê)"] > 0).sort((a,b) => b["DT Realtime (Qƒê)"] - a["DT Realtime (Qƒê)"]);
            const categoriesWithoutRevenue = categoryData.filter(row => row["DT Realtime (Qƒê)"] <= 0);

            let mainProgressBarHtml = '';
            if (totalRow) {
                const htThuc = totalRow['% HT Target Ng√†y (Qƒê)'];
                mainProgressBarHtml = `<div class="progress-bar-container" style="padding: 0 0 20px 0;">
                                    <div class="progress-labels"><span>Ti·∫øn ƒë·ªô Target Ng√†y (T·ªïng)</span><span>${formatNumber(totalRow['DT Realtime (Qƒê)'])} / ${formatNumber(totalRow['Target Ng√†y (Qƒê)'])}</span></div>
                                    <div class="progress-track"><div class="progress-fill" style="width: ${htThuc > 100 ? 100 : htThuc}%; background-color: ${getColor(htThuc)};"></div></div>
                                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(htThuc, 1)}%</span></div>
                                </div>`;
            }

            let tableHtml = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>B·∫£ng chi ti·∫øt Ng√†nh h√†ng</h2>
                                 ${mainProgressBarHtml}
                                 <table class="rt-styled-table">
                                     <thead><tr><th>Ng√†nh h√†ng</th><th>SL</th><th>DT Realtime</th><th>Target Ng√†y</th><th>% HT</th><th>% Tr·∫£ G√≥p</th></tr></thead>
                                     <tbody>`;
            if (totalRow) {
                 tableHtml += `<tr style="font-weight:bold; background-color: #e9ecef;">
                                     <td style="text-align: left !important;">${totalRow["Nh√≥m ng√†nh h√†ng"]}</td><td>${formatNumber(totalRow["S·ªë l∆∞·ª£ng"])}</td><td>${formatNumber(totalRow["DT Realtime (Qƒê)"])}</td><td>${formatNumber(totalRow["Target Ng√†y (Qƒê)"])}</td><td style="color: ${getColor(totalRow["% HT Target Ng√†y (Qƒê)"])};">${formatNumber(totalRow["% HT Target Ng√†y (Qƒê)"], 1)}%</td><td>${formatNumber(totalRow["T·ª∑ tr·ªçng tr·∫£ g√≥p"], 2)}%</td>
                                 </tr>`;
            }
            categoriesWithRevenue.forEach(row => { 
                tableHtml += `<tr><td style="text-align: left !important;">${row["Nh√≥m ng√†nh h√†ng"]}</td><td>${formatNumber(row["S·ªë l∆∞·ª£ng"])}</td><td>${formatNumber(row["DT Realtime (Qƒê)"])}</td><td>${formatNumber(row["Target Ng√†y (Qƒê)"])}</td><td style="color: ${getColor(row["% HT Target Ng√†y (Qƒê)"])}; font-weight: bold;">${formatNumber(row["% HT Target Ng√†y (Qƒê)"], 1)}%</td><td>${formatNumber(row["T·ª∑ tr·ªçng tr·∫£ g√≥p"], 2)}%</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            wrapper.innerHTML = tableHtml;

            if (categoriesWithoutRevenue.length > 0) {
                const noRevenueHtml = `<div id="category-no-revenue-section" class="no-revenue-section" style="display:none;">
                                     <h4>Ng√†nh h√†ng ch∆∞a ph√°t sinh doanh thu (${categoriesWithoutRevenue.length}):</h4>
                                     <ul class="no-revenue-grid">
                                         ${categoriesWithoutRevenue.map((item, index) => `<li>${index + 1}. ${item["Nh√≥m ng√†nh h√†ng"]}</li>`).join('')}
                                     </ul>
                                   </div>`;

                const buttonHtml = `<div class="details-toggle" style="margin-top: 15px;">
                                    <button id="toggle-category-no-revenue-btn">
                                        Hi·ªán ${categoriesWithoutRevenue.length} ng√†nh h√†ng ch∆∞a c√≥ DT
                                    </button>
                                </div>`;
                
                wrapper.insertAdjacentHTML('beforeend', buttonHtml + noRevenueHtml);

                const toggleBtn = document.getElementById('toggle-category-no-revenue-btn');
                const noRevenueSection = document.getElementById('category-no-revenue-section');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = noRevenueSection.style.display === 'none';
                    noRevenueSection.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? `·∫®n ${categoriesWithoutRevenue.length} ng√†nh h√†ng ch∆∞a c√≥ DT` : `Hi·ªán ${categoriesWithoutRevenue.length} ng√†nh h√†ng ch∆∞a c√≥ DT`;
                });
            }
        }

        function renderRealtimeSummary(totalRow, contestData) {
            const container = document.getElementById('summary-report-wrapper-rt');
            container.style.display = 'block';
            if (!totalRow) { container.innerHTML = ''; return; }
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            const ht = totalRow['% HT Target Ng√†y (Qƒê)'];
            const timeFraction = getTimePassedFraction();
            const projectedSales = timeFraction > 0 && timeFraction < 1 ? (totalRow['DT Realtime (Qƒê)'] / timeFraction) : totalRow['DT Realtime (Qƒê)'];
            const projectedHt = totalRow['Target Ng√†y (Qƒê)'] > 0 ? (projectedSales / totalRow['Target Ng√†y (Qƒê)'] * 100) : 0;
            const onTrackCount = contestData.onTrack.length;
            const totalCount = contestData.all.length;
            const remaining = totalRow['Target Ng√†y (Qƒê)'] - totalRow['DT Realtime (Qƒê)'];

            const createSubListWithActual = (items) => {
                if (!items || items.length === 0) return '';
                return items.map(item => `  - ${item.name} (${formatNumber(item.percentActual, 1)}%)`).join('\n');
            };

            let contestSummarySections = [];
            if(contestData.all.length > 0) {
                contestSummarySections.push(`\n-------------------\nüèÅ T√åNH H√åNH THI ƒêUA (TH·ª∞C T·∫æ) üèÅ`);
                if (contestData.veDich_actual.length > 0) {
                    contestSummarySections.push(`‚úÖ ƒê√É V·ªÄ ƒê√çCH (${contestData.veDich_actual.length} nh√≥m):\n${createSubListWithActual(contestData.veDich_actual)}`);
                }
                if (contestData.canCoGang_actual.length > 0) {
                    const list = contestData.canCoGang_actual.map(item => `${item.name} (${formatNumber(item.percentActual, 1)}%)`).join(', ');
                    contestSummarySections.push(`üí™ C·∫¶N C·ªê G·∫ÆNG (${contestData.canCoGang_actual.length} nh√≥m - HT >80%): ${list}`);
                }
                if (contestData.canTapTrung_actual.length > 0) {
                     const list = contestData.canTapTrung_actual.map(item => `${item.name} (${formatNumber(item.percentActual, 1)}%)`).join(', ');
                    contestSummarySections.push(`üéØ C·∫¶N T·∫¨P TRUNG (${contestData.canTapTrung_actual.length} nh√≥m - HT >50%): ${list}`);
                }
                 if (contestData.baoDong_actual.length > 0) {
                    const list = contestData.baoDong_actual.map(item => `${item.name} (${formatNumber(item.percentActual, 1)}%)`).join(', ');
                    contestSummarySections.push(`üö® B√ÅO ƒê·ªòNG (${contestData.baoDong_actual.length} nh√≥m - HT <50%): ${list}`);
                }
            }

            const summaryText = `üìä B√ÅO C√ÅO NHANH REAL-TIME - ${timeString} üìä
-------------------
- üéØ Target Ng√†y: ${formatNumber(totalRow['Target Ng√†y (Qƒê)'])}
- üìà Realtime: ${formatNumber(totalRow['DT Realtime (Qƒê)'])} (${formatNumber(ht, 1)}%)
- üìâ C√≤n l·∫°i: ${formatNumber(remaining)}
- üöÄ D·ª± ki·∫øn: ${formatNumber(projectedSales)} (${formatNumber(projectedHt, 1)}%)
- üèÜ Thi ƒëua d·ª± ki·∫øn ƒë·∫°t: ${onTrackCount}/${totalCount}
-------------------
- üí≥ DT Tr·∫£ g√≥p: ${formatNumber(totalRow['DT Tr·∫£ G√≥p'])} (${formatNumber(totalRow['T·ª∑ tr·ªçng tr·∫£ g√≥p'], 1)}%)
- üì± S·ªë l∆∞·ª£ng b√°n: ${formatNumber(totalRow['S·ªë l∆∞·ª£ng'])}
${contestSummarySections.join('\n\n')}`.trim();

            const html = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z" /></svg>Nh·∫≠n x√©t Real-time (T·ªïng)</h2>
                                 <textarea class="summary-textarea" readonly>${summaryText}</textarea>
                                 <button class="action-btn copySummaryBtn" style="width: 100%; max-width: 400px; margin: 15px auto 0 auto;">
                                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                                     Sao ch√©p Nh·∫≠n x√©t
                                 </button>`;
            container.innerHTML = html;
            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = e.currentTarget.previousElementSibling;
                textarea.select();
                document.execCommand('copy');
                showToast('ƒê√£ sao ch√©p nh·∫≠n x√©t!');
            });
        }
        
        async function generateEmployeeComment(employeeData) {
            const apiKey = "AIzaSyAZjf8J81puHXTJypnLvzw9PtBjIVvT4eg"; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "B·∫°n l√† m·ªôt qu·∫£n l√Ω si√™u th·ªã kinh nghi·ªám, chuy√™n nghi·ªáp v√† c√≥ kh·∫£ nƒÉng th√∫c ƒë·∫©y tinh th·∫ßn nh√¢n vi√™n. Nhi·ªám v·ª• c·ªßa b·∫°n l√† vi·∫øt nh·∫≠n x√©t v·ªÅ hi·ªáu su·∫•t b√°n h√†ng d·ª±a tr√™n d·ªØ li·ªáu v√† th·ªùi gian th·ª±c t·∫ø. L·ªùi vƒÉn c·∫ßn r√µ r√†ng, mang t√≠nh x√¢y d·ª±ng, t·∫≠p trung v√†o k·∫øt qu·∫£ kinh doanh v√† m·ª•c ti√™u chung c·ªßa c·ª≠a h√†ng.";

            // --- Time-based logic ---
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const isEndOfDay = currentHour > 21 || (currentHour === 21 && currentMinute >= 30);
            
            let userQuery = '';
            const dataString = employeeData
                .map(e => {
                    const firstName = e.name.split(' ').pop(); // Get first name
                    return `- ${firstName}: ${formatNumber(e.revenue / 1000000, 2)} tri·ªáu`;
                })
                .join('\n');

            if (isEndOfDay) {
                // End-of-day summary prompt
                userQuery = `B√¢y gi·ªù l√† ${now.toLocaleTimeString('vi-VN')}, ƒë√£ k·∫øt th√∫c gi·ªù l√†m vi·ªác.
D·ªØ li·ªáu doanh thu t·ªïng k·∫øt c·ªßa nh√¢n vi√™n ng√†y h√¥m nay:
${dataString}

V·ªõi vai tr√≤ l√† qu·∫£n l√Ω, h√£y vi·∫øt m·ªôt nh·∫≠n x√©t t·ªïng k·∫øt NG·∫ÆN G·ªåN v·ªÅ hi·ªáu su·∫•t l√†m vi·ªác c·ªßa c·∫£ ƒë·ªôi:
1.  **M·ªü ƒë·∫ßu:** C·∫£m ∆°n c·∫£ ƒë·ªôi ƒë√£ n·ªó l·ª±c trong ng√†y l√†m vi·ªác.
2.  **N·ªôi dung ch√≠nh:**
    * Vinh danh nh·ªØng c√° nh√¢n xu·∫•t s·∫Øc nh·∫•t ng√†y (top 1-3).
    * ƒê∆∞a ra nh·∫≠n x√©t chung v·ªÅ k·∫øt qu·∫£ c·ªßa c·∫£ ƒë·ªôi.
    * Nh·∫Øc nh·ªü nh·ªØng b·∫°n c·∫ßn c·ªë g·∫Øng h∆°n v√†o ng√†y mai.
3.  **K·∫øt lu·∫≠n:** Ch√∫c c·∫£ ƒë·ªôi ngh·ªâ ng∆°i v√† chu·∫©n b·ªã t·ªët cho ng√†y l√†m vi·ªác ti·∫øp theo.
4.  **L∆∞u √Ω:** Ch·ªâ s·ª≠ d·ª•ng T√äN c·ªßa nh√¢n vi√™n. L·ªùi vƒÉn chuy√™n nghi·ªáp, s√∫c t√≠ch, mang t√≠nh t·ªïng k·∫øt.`;

            } else {
                // Mid-day motivational prompt
                const shift = currentHour < 15 ? "s√°ng" : "chi·ªÅu";
                userQuery = `B√¢y gi·ªù l√† ${now.toLocaleTimeString('vi-VN')}. Ca l√†m vi·ªác ${shift} ƒëang di·ªÖn ra.
D·ªØ li·ªáu doanh thu nh√¢n vi√™n ƒë·∫øn th·ªùi ƒëi·ªÉm hi·ªán t·∫°i:
${dataString}

V·ªõi vai tr√≤ l√† qu·∫£n l√Ω, h√£y vi·∫øt m·ªôt nh·∫≠n x√©t NG·∫ÆN G·ªåN ƒë·ªÉ th√∫c ƒë·∫©y tinh th·∫ßn nh√¢n vi√™n:
1.  **M·ªü ƒë·∫ßu:** Nh·∫Øc nh·ªü chung v·ªÅ vi·ªác t·∫≠p trung, ch·∫Øt chiu t·ª´ng l∆∞·ª£t kh√°ch trong th·ªùi gian c√≤n l·∫°i c·ªßa ca ${shift}.
2.  **N·ªôi dung:**
    * Tuy√™n d∆∞∆°ng c√°c b·∫°n ƒëang l√†m t·ªët, d·∫´n ƒë·∫ßu v·ªÅ doanh s·ªë ƒë·ªÉ t·∫°o ƒë·ªông l·ª±c.
    * ƒê·ªông vi√™n c√°c b·∫°n c√≤n l·∫°i c·∫ßn n·ªó l·ª±c h∆°n ƒë·ªÉ b·ª©t ph√°.
    * Nh·∫Øc nh·ªü nh·∫π nh√†ng nh·ªØng b·∫°n ch∆∞a c√≥ doanh s·ªë c·∫ßn kh·∫©n tr∆∞∆°ng h∆°n.
3.  **K·∫øt lu·∫≠n:** K√™u g·ªçi c·∫£ team c√πng nhau ƒëo√†n k·∫øt, c·ªë g·∫Øng ho√†n th√†nh m·ª•c ti√™u ng√†y.
4.  **L∆∞u √Ω:** Ch·ªâ s·ª≠ d·ª•ng T√äN c·ªßa nh√¢n vi√™n. L·ªùi vƒÉn qu·∫£n l√Ω, chuy√™n nghi·ªáp, kh√¥ng ƒë√πa c·ª£t qu√° tr·ªõn.`;
            }
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let retries = 3;
            while (retries > 0) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                         throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung h·ª£p l·ªá t·ª´ API.");
                    }
                } catch (error) {
                    console.error('L·ªói g·ªçi API Gemini:', error);
                    retries--;
                    if (retries === 0) {
                        return "R·∫•t ti·∫øc, AI t·∫°m th·ªùi kh√¥ng th·ªÉ ƒë∆∞a ra nh·∫≠n x√©t. Vui l√≤ng th·ª≠ l·∫°i sau.";
                    }
                    await new Promise(res => setTimeout(res, 1000 * (3 - retries))); // Exponential backoff
                }
            }
        }

        async function updateEmployeeComment(data) {
            const textarea = document.getElementById('employeeSummaryTextarea');
            const regenerateBtn = document.getElementById('regenerateEmployeeCommentBtn');
            
            if (!textarea) return; 

            const originalBtnHTML = regenerateBtn ? regenerateBtn.innerHTML : '';
            
            textarea.value = 'AI ƒëang vi·∫øt nh·∫≠n x√©t m·ªõi... ü§ñ';
            if(regenerateBtn) {
                regenerateBtn.disabled = true;
                regenerateBtn.innerHTML = `
                    <svg class="animate-spin" style="width:20px; height:20px;" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg> ƒêang t·∫°o...`;
                regenerateBtn.style.opacity = 0.7;
                regenerateBtn.style.cursor = 'not-allowed';
            }
            
            try {
                const sortedData = [...data].sort((a, b) => b.revenue - a.revenue);
                const comment = await generateEmployeeComment(sortedData);
                textarea.value = comment;
            } catch (error) {
                textarea.value = "ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o nh·∫≠n x√©t. Vui l√≤ng th·ª≠ l·∫°i.";
                console.error("L·ªói khi t·∫°o nh·∫≠n x√©t nh√¢n vi√™n:", error);
            } finally {
                if(regenerateBtn) {
                    regenerateBtn.disabled = false;
                    regenerateBtn.innerHTML = originalBtnHTML;
                    regenerateBtn.style.opacity = 1;
                    regenerateBtn.style.cursor = 'pointer';
                }
            }
        }


        async function renderEmployeeSummary(data) {
            const container = document.getElementById('summary-report-wrapper-rt-employee');
            if (!data || data.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const html = `
                <h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>Nh·∫≠n x√©t Doanh thu Nh√¢n vi√™n (AI)</h2>
                <textarea id="employeeSummaryTextarea" class="summary-textarea" readonly>AI ƒëang vi·∫øt nh·∫≠n x√©t... Vui l√≤ng ch·ªù trong gi√¢y l√°t ‚ú®</textarea>
                <div class="button-container" style="flex-wrap: nowrap; max-width: 500px; margin: 15px auto 0 auto;">
                    <button id="regenerateEmployeeCommentBtn" class="action-btn" style="background-color: var(--secondary-accent); flex-grow: 1;">
                        <svg fill="currentColor" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"></path></svg>
                        T·∫°o l·∫°i
                    </button>
                    <button class="action-btn copySummaryBtn" style="flex-grow: 1;">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                        Sao ch√©p Nh·∫≠n x√©t
                    </button>
                </div>`;
            container.innerHTML = html;
            
            updateEmployeeComment(data);

            document.getElementById('regenerateEmployeeCommentBtn').addEventListener('click', () => {
                updateEmployeeComment(lastEmployeeData);
            });

            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = document.getElementById('employeeSummaryTextarea');
                textarea.select();
                document.execCommand('copy');
                showToast('ƒê√£ sao ch√©p nh·∫≠n x√©t nh√¢n vi√™n!');
            });
        }
    }
	</script>
</body>
</html>
