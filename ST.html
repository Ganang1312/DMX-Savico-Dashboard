<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Tổng hợp - v218.42 (Cập nhật Realtime)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /*
         * BẢNG MÀU MỚI DỰA TRÊN YÊU CẦU CỦA BẠN
         * --primary-accent: #108AB1 (Xanh dương)
         * --success-color: #06D7A0 (Xanh lá)
         * --warning-color: #FFD167 (Vàng)
         * --danger-color: #F04770 (Hồng/Đỏ)
         * --secondary-accent: #F78C6A (Cam)
         * --text-primary: #073A4B (Xanh đen - cho văn bản chính)
         * --text-on-dark: #FFFFFF (Trắng - cho văn bản trên nền tối)
         * --text-muted: #5A7A84 (Xám xanh - cho văn bản phụ)
         * --bg-main: #F4F7F9 (Nền chính - xám rất nhạt)
         * --border-main: #DDE3E7 (Màu viền)
         * --shadow-main: 0 4px 12px rgba(7, 58, 75, 0.08) (Đổ bóng)
         */
        :root {
            --primary-accent: #108AB1;
            --success-color: #06D7A0;
            --warning-color: #FFD167;
            --danger-color: #F04770;
            --secondary-accent: #F78C6A;
            --text-primary: #073A4B;
            --text-on-dark: #FFFFFF;
            --text-muted: #5A7A84;
            --bg-main: #F4F7F9; 
            --border-main: #DDE3E7;
            /* CẬP NHẬT: Hiệu ứng shadow 3D nổi khối */
            --shadow-main: 
                0px 2.8px 2.2px rgba(7, 58, 75, 0.02),
                0px 6.7px 5.3px rgba(7, 58, 75, 0.028),
                0px 12.5px 10px rgba(7, 58, 75, 0.035),
                0px 22.3px 17.9px rgba(7, 58, 75, 0.042),
                0px 41.8px 33.4px rgba(7, 58, 75, 0.05),
                0px 100px 80px rgba(7, 58, 75, 0.07);
        }
        /* CSS DÀNH RIÊNG CHO CHẾ ĐỘ CHỤP ẢNH */
        .capture-mode .card,
        .capture-mode .input-section,
        .capture-mode .action-btn {
            box-shadow: none !important;
            transform: none !important;
            transition: none !important;
        }
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            background-color: var(--bg-main); 
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            color: var(--text-primary); 
        }
        .container { 
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
        }
        header { text-align: center; margin-bottom: 10px; }
        header h1 { color: var(--text-primary); margin: 0; font-size: 2.5em; font-weight: 700; }
        
        .tab-buttons { display: flex; gap: 10px; border-bottom: 2px solid var(--border-main); margin-bottom: 25px; flex-wrap: wrap; }
        .tab-button { padding: 10px 20px; cursor: pointer; border: none; background-color: transparent; font-size: 1.1em; font-weight: 600; color: var(--text-muted); border-bottom: 3px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-button.active { color: var(--primary-accent); border-bottom-color: var(--primary-accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        /* CẬP NHẬT: Thêm transition cho shadow để hiệu ứng mượt hơn */
        .input-section, .card { 
            background: #ffffff; 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid var(--border-main); 
            box-shadow: var(--shadow-main);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .input-section h4 { margin-top: 0; color: var(--text-muted); }
        .input-section h4 a { color: inherit; text-decoration: none; transition: color 0.2s; }
        .input-section h4 a:hover { color: var(--primary-accent); }
        textarea { width: 100%; padding: 10px; border: 1px solid var(--border-main); background: #f8f9fa; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical; }
        .mainDataInput, .contestDataInput { height: 120px; }
        .button-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; width: 100%; margin-top: 25px; }
        
        .input-wrapper { display: flex; flex-direction: column; }
        .paste-btn-container { display: flex; justify-content: flex-end; padding-top: 8px; }
        .paste-btn {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            background-color: var(--primary-accent);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            opacity: 0.9;
            transition: all 0.2s;
        }
        .paste-btn:hover {
            opacity: 1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(16, 138, 177, 0.4);
        }

        .input-header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .input-header-flex h4 { margin: 0; }
        
        .interactive-table-wrapper { height: 200px; overflow-y: auto; border: 1px solid var(--border-main); border-radius: 8px; }
        .interactive-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .interactive-table thead th { position: sticky; top: 0; background-color: #f8f9fa; color: var(--text-primary); font-weight: 600; padding: 5px; text-align: center; border-bottom: 1px solid var(--border-main); z-index: 1; vertical-align: top; }
        .interactive-table tbody td { padding: 8px 10px; border-bottom: 1px solid #f1f1f1; text-align: right; }
        .interactive-table tbody td:first-child { text-align: center; font-weight: 500; background-color: #f8f9fa; }
        .interactive-table tbody td[contenteditable="true"] { background-color: #fff; transition: background-color 0.2s; }
        .interactive-table tbody td[contenteditable="true"]:focus { background-color: #e6f7ff; outline: 2px solid var(--primary-accent); outline-offset: -2px; }
        .interactive-table tbody tr:last-child td { border-bottom: none; }

        .th-content { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding-top: 5px; }
        .col-actions { display: flex; gap: 8px; }
        .col-action-btn { background: none; border: none; cursor: pointer; padding: 2px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; transition: background-color 0.2s; }
        .col-action-btn:hover { background-color: #ddd; }
        .col-action-btn svg { width: 16px; height: 16px; }
        .col-action-btn.copy svg { color: var(--success-color); }
        .col-action-btn.paste svg { color: var(--primary-accent); }
        .col-action-btn.clear svg { color: var(--danger-color); }

        /* CẬP NHẬT: Hiệu ứng shadow 3D cho nút */
        .action-btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            padding: 15px; 
            font-size: 18px; 
            font-weight: 600; 
            color: var(--text-on-dark); 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.2);
            flex-grow: 1;
            max-width: 300px;
        }
        .action-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 10px rgba(0,0,0,0.15), inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        .action-btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.15), inset 0 1px 0 rgba(0,0,0,0.2);
        }
        .action-btn svg { width: 20px; height: 20px; }
        .analyzeBtn { background: var(--primary-accent); }
        .captureBtn { background: linear-gradient(45deg, var(--success-color), #05B386); }
        .copySummaryBtn { background: linear-gradient(45deg, var(--primary-accent), #0d6c8b); }

        .dashboard-body { display: none; margin-top: 15px; }
        .report-title { text-align: center; font-size: 1.8em; font-weight: 700; margin: 10px 0 0 0; color: var(--text-primary); }
        #capture-area-luyke > * + *, #capture-area-rt > * + * { margin-top: 25px; }
        #capture-content-luyke > * + *, #capture-content-rt > * + * { margin-top: 25px; }

        .progress-bar-container { padding: 15px 25px; }
        .progress-labels { display: flex; justify-content: space-between; font-size: 1em; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); }
        .progress-track { width: 100%; height: 18px; background-color: #e9ecef; border-radius: 9px; overflow: hidden; border: 1px solid #ddd; }
        .progress-fill { height: 100%; background: var(--primary-accent); border-radius: 9px; transition: width 0.8s ease-out; }
        /* CẬP NHẬT: Chuyển vị trí chữ ra ngoài thanh tiến độ */
        .progress-text-wrapper {
            text-align: center;
            margin-top: 4px;
            font-size: 0.9em; 
            font-weight: bold; 
            color: var(--text-primary);
        }
        
        .kpi-group-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; }
        .kpi-group-card { background-color: #fff; border-radius: 15px; box-shadow: var(--shadow-main); overflow: hidden; border: 1px solid var(--border-main); }
        .kpi-group-header { color: white; padding: 12px 20px; font-size: 1.2em; font-weight: 700; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        /* CẬP NHẬT: Chỉnh lại kích thước icon KPI */
        .kpi-group-header svg { width: 24px; height: 24px; }
        .kpi-group-header.blue { background-color: var(--primary-accent); }
        .kpi-group-header.orange { background-color: var(--secondary-accent); }
        .kpi-group-header.red { background-color: var(--danger-color); }
        .kpi-group-body { padding: 15px 20px; display: flex; flex-direction: column; gap: 12px; }
        .kpi-item { display: flex; justify-content: space-between; align-items: center; font-size: 1.1em; padding: 5px 0; border-bottom: 1px solid #f0f0f0; }
        .kpi-item:last-child { border-bottom: none; }
        .kpi-label { display: flex; align-items: center; gap: 10px; color: var(--text-primary); font-weight: 600; }
        .kpi-label svg { width: 20px; height: 20px; flex-shrink: 0; }
        .kpi-value { font-weight: 700; color: var(--text-primary); font-size: 1.15em; }
        .kpi-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .sub-kpi-card { text-align: center; display: flex; flex-direction: column; justify-content: space-between; padding: 15px 10px; min-height: 160px; }
        .sub-kpi-card h4 { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1.2em; margin: 0; color: var(--text-primary); font-weight: 700; }
        .sub-kpi-card h4 svg { width: 24px; height: 24px; flex-shrink: 0; }
        .sub-kpi-card .value { font-size: 4em; font-weight: 700; margin: 0; color: var(--primary-accent); line-height: 1; }
        .sub-kpi-card .sub-text { font-size: 1em; color: var(--text-muted); margin: 0; }
        .kpi-installment-card { justify-content: center; gap: 10px; }
        .kpi-installment-card .text-content { text-align: center; }
        .kpi-installment-card .chart-content { width: 100px; height: 100px; position: relative; margin: 0 auto; }
        .kpi-installment-card .chart-content .chart-inner-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.8em; font-weight: 700; color: var(--text-primary); }

        .dashboard-layout-grid { display: grid; gap: 25px; align-items: flex-start; }
        .charts-column { display: flex; flex-direction: column; gap: 25px; }
        .chart-wrapper, .report-section { padding: 25px; min-width: 0; } 
        .report-section h2, .chart-wrapper h2 { font-size: 1.8em; color: var(--primary-accent); text-align: center; margin-top:0; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .chart-wrapper h2 svg, .report-section h2 svg { width: 24px !important; height: 24px !important; flex-shrink: 0; }
        .chart-container { position: relative; width: 100%; }
        
        .contest-results-container .card-content { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .contest-column-visual { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px; border: 1px solid var(--border-main); border-radius: 15px; }
        .status-icon-wrapper { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
        .status-icon-wrapper.green { background-color: #d4edda; border: 3px solid var(--success-color); }
        .status-icon-wrapper.red { background-color: #f8d7da; border: 3px solid var(--danger-color); }
        .status-icon-wrapper svg { width: 50%; height: 50%; }
        .status-icon-wrapper.green svg { color: var(--success-color); }
        .status-icon-wrapper.red svg { color: var(--danger-color); }
        .contest-column-visual h4 { font-size: 1.3em; font-weight: 700; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .contest-column-visual h4.on-track { color: var(--success-color); }
        .contest-column-visual h4.behind { color: var(--danger-color); }
        .contest-list-new { width: 100%; }
        .contest-item-new { padding: 12px 0; border-bottom: 1px solid var(--border-main); }
        .contest-item-new:last-child { border-bottom: none; }
        .contest-main-info { display: flex; justify-content: space-between; align-items: baseline; gap: 10px; flex-wrap: wrap; }
        .contest-main-info .name-rank { font-weight: 700; font-size: 1.1em; flex-grow: 1; text-align: left; }
        .contest-main-info .stats { font-size: 0.9em; color: var(--text-muted); text-align: right; white-space: normal; flex-shrink: 1; }
        .contest-main-info .stats strong { color: var(--text-primary); font-weight: 700; }
        .contest-progress-track { width: 100%; height: 10px; background-color: #e9ecef; border-radius: 5px; overflow: hidden; margin-top: 8px; }
        .contest-progress-fill { height: 100%; border-radius: 5px; transition: width 0.8s ease-out; }
        
        .summary-textarea { height: 500px; background-color: #f8f9fa; border: 1px solid var(--border-main); }
        
        .toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 16px 30px; border-radius: 8px; z-index: 1001; font-size: 1.1em; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transition: bottom 0.5s ease-in-out; }
        .toast-notification.show { bottom: 30px; }
        .toast-notification.error { background-color: var(--danger-color); }

        .details-toggle { text-align: center; margin-top: 25px; }
        .details-toggle button { font-size: 0.9em; font-weight: 600; background: #6c757d; color: var(--text-on-dark); padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; transition: background-color 0.3s, box-shadow 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .details-toggle button:hover { background-color: #5a6268; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        .tables-container { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .tables-container.show { max-height: 5000px; margin-top: 25px; }
        #specificTablesContainer.show, #specificTablesContainer-rt.show { max-height: 5000px; margin-top: 25px; }
        .table-container { margin-bottom:25px; overflow-x: auto; } 
        .table-container h2 { margin-top: 0; font-size: 1.5em; color: var(--primary-accent); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-main); }
        thead th { background-color: var(--primary-accent); color: var(--text-on-dark); text-transform: uppercase; font-size: 0.9em; }
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9ecef; }
        
        #contest-table-luyke-wrapper { padding: 25px; }
        #contest-table-luyke-wrapper h2 { text-align: center; font-size: 2em; margin-bottom: 25px; }
        .contest-split-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: flex-start; }
        .contest-group { background: #fff; border-radius: 15px; padding: 20px; border: 1px solid var(--border-main); box-shadow: var(--shadow-main); }
        .contest-group-title { font-size: 1.5em; font-weight: 700; margin: 0 0 15px 0; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .contest-group-title.top-performers { color: var(--success-color); }
        .contest-group-title.needs-improvement { color: var(--danger-color); }

        .contest-detail-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .contest-detail-table th, .contest-detail-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border-main); border-right: 1px solid var(--border-main); vertical-align: middle; }
        .contest-detail-table th:last-child, .contest-detail-table td:last-child { border-right: none; }
        .contest-detail-table thead th { background-color: #f8f9fa; color: var(--text-primary); font-weight: 600; text-align: center; font-size: 0.9em; text-transform: uppercase; }
        .contest-detail-table tbody tr:last-child td { border-bottom: none; }
        .contest-detail-table tbody tr:hover { background-color: #e9ecef; }
        .contest-detail-table td { font-weight: 500; }
        .contest-detail-table th:not(:nth-child(2)), .contest-detail-table td:not(:nth-child(2)) { text-align: center; }
        .contest-detail-table .col-category { text-align: left; font-weight: 700; width: 30%; }
        .contest-detail-table .col-rank { width: 40px; }
        .col-negative { color: var(--danger-color); font-weight: bold; }

        .progress-bar-cell { min-width: 100px; }
        .bar-wrapper { display: flex; align-items: center; gap: 8px; }
        .bar-track { flex-grow: 1; height: 12px; background-color: #e9ecef; border-radius: 6px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 6px; transition: width 0.5s ease-out; }
        .bar-percent-text { font-weight: 700; font-size: 1.1em; width: 50px; text-align: right; }
        .tooltip { position: relative; display: inline-block; cursor: pointer; }
        .tooltip .tooltiptext { visibility: hidden; width: 160px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity 0.3s; }
        .tooltip .tooltiptext::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #555 transparent transparent transparent; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        
        .rt-styled-table {
            width: 100%;
            border-collapse: collapse;
        }
        .rt-styled-table th, .rt-styled-table td {
            text-align: center !important;
            vertical-align: middle;
            padding: 10px 8px;
            border-right: 1px solid var(--border-main);
        }
        .rt-styled-table th:last-child, .rt-styled-table td:last-child {
            border-right: none;
        }
        .rt-styled-table td:first-child, .rt-styled-table th:first-child {
            text-align: left !important;
        }
        .rt-styled-table thead th {
            background-color: #f8f9fa;
            color: var(--text-primary);
            font-weight: 600;
        }

        /* NEW STYLES for no-revenue lists */
        .no-revenue-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px dashed var(--border-main);
            border-radius: 8px;
        }
        .no-revenue-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            text-align: center;
            color: var(--text-muted);
            font-size: 1.1em;
            font-weight: 600;
        }
        .no-revenue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 5px 15px;
            font-size: 0.9em;
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .no-revenue-grid li {
            color: var(--text-primary);
        }

        /* CẬP NHẬT: Thêm style cho nút import/export */
        .table-io-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 10px;
        }
        .action-btn-small {
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.9;
        }
        .action-btn-small.import { background-color: var(--success-color); }
        .action-btn-small.export { background-color: var(--secondary-accent); }
        .action-btn-small:hover { 
            opacity: 1;
            transform: translateY(-1px); 
        }

        @media (max-width: 1200px) {
            .kpi-group-container { grid-template-columns: 1fr; }
            .kpi-panel { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
            .input-grid { grid-template-columns: 1fr; }
            .contest-split-layout { grid-template-columns: 1fr; }
        }
        @media (max-width: 992px) {
            .dashboard-layout-grid {grid-template-columns: 1fr !important;}
            .charts-column { grid-row: 1; }
            .contest-results-container .card-content { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 10px; }
            header h1 { font-size: 1.8em; }
            .card { padding: 15px; }
            .report-section h2, .chart-wrapper h2 { font-size: 1.5em; }
            .kpi-panel { grid-template-columns: repeat(2, 1fr); }
            .kpi-installment-card { flex-direction: column; }
            .contest-detail-table { font-size: 12px; }
            .contest-detail-table th, .contest-detail-table td { padding: 8px 4px; }
        }

    </style>
</head>
<body>
    <div class="container">
    </div>

    <script>
    /****************************************************************************
     * SMART PASTE FUNCTIONS
     ****************************************************************************/
    function extractData(fullText, regex) {
        const match = fullText.match(regex);
        return (match && match[1]) ? match[1].trim() : '';
    }

    async function handleSmartPaste(targetId) {
        const targetTextarea = document.getElementById(targetId);
        if (!targetTextarea) return;

        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                showToast('Clipboard rỗng!', true);
                return;
            }
            
            let extractedData = '';
            switch (targetId) {
                case 'mainDataInput':
                    extractedData = extractData(text, /(Nhóm ngành hàng\tSố lượng\tDTQĐ[\s\S]+?)Hỗ trợ BI/);
                    break;
                case 'contestDataInput':
                    extractedData = extractData(text, /(Ngành hàng\tDTQĐ\tTarget[\s\S]+?)Hỗ trợ BI/);
                    break;
                case 'realtimeDataInput':
                    extractedData = extractData(text, /(Nhóm ngành hàng\tSL Realtime[\s\S]+?)Hỗ trợ BI/);
                    break;
                case 'realtimeContestDataInput':
                    extractedData = extractData(text, /(Ngành hàng\tDT Realtime \(QĐ\)[\s\S]+?)Hỗ trợ BI/);
                    break;
                case 'employeeSalesDataInput':
                    extractedData = extractData(text, /(Nhân viên\s+SL\s+DT[\s\S]+)/);
                    break;
                default:
                    extractedData = text;
            }

            targetTextarea.value = extractedData || text;
            showToast('Đã dán và lọc dữ liệu thông minh!');

        } catch (err) {
            console.error('Lỗi khi dán: ', err);
            showToast('Không thể truy cập clipboard. Vui lòng kiểm tra quyền truy cập của trình duyệt.', true);
        }
    }

    function setupSmartPasteButtons() {
        document.querySelectorAll('.paste-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-target');
                handleSmartPaste(targetId);
            });
        });
    }


    /****************************************************************************
     * INTERACTIVE TABLE FUNCTIONS
     ****************************************************************************/
    
    async function copyColumnData(tableId, colIndex) {
        const table = document.getElementById(tableId);
        if (!table) return;
        let dataString = '';
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].cells[colIndex];
            if (cell) {
                dataString += cell.innerText.trim() + '\n';
            }
        }
        
        const textarea = document.createElement('textarea');
        textarea.value = dataString.trim();
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showToast('Đã sao chép dữ liệu cột!');
        } catch (err) {
            console.error('Lỗi sao chép cột: ', err);
            showToast('Lỗi khi sao chép dữ liệu.', true);
        }
        document.body.removeChild(textarea);
    }

    async function pasteColumnData(tableId, colIndex) {
        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                showToast('Clipboard rỗng!', true);
                return;
            }
            const table = document.getElementById(tableId);
            if (!table) return;

            const pastedRows = text.split(/\r?\n/).filter(row => row.trim() !== '');
            const tableRows = table.tBodies[0].rows;

            pastedRows.forEach((cellData, i) => {
                if (i >= tableRows.length) return;
                const targetCell = tableRows[i].cells[colIndex];
                if (targetCell && targetCell.isContentEditable) {
                    targetCell.innerText = cellData.trim();
                }
            });

            saveTableData(tableId);
            showToast(`Đã dán dữ liệu vào cột!`);
        } catch (err) {
            console.error('Lỗi khi dán cột: ', err);
            showToast('Không thể truy cập clipboard.', true);
        }
    }

    function clearColumnData(tableId, colIndex) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cell = rows[i].cells[colIndex];
            if (cell && cell.isContentEditable) {
                cell.innerText = '';
            }
        }
        saveTableData(tableId);
        showToast('Đã xoá dữ liệu cột!');
    }

    function handleTablePaste(event, table) {
        event.preventDefault();
        const clipboardData = event.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text/plain');
        const rows = pastedData.split(/\r?\n/).filter(row => row.trim() !== '');

        const startCell = event.target;
        if (startCell.tagName !== 'TD') return;

        const startRowIndex = startCell.parentElement.rowIndex - 1; 
        const startColIndex = startCell.cellIndex;
        
        rows.forEach((rowData, i) => {
            const currentRowIndex = startRowIndex + i;
            const targetRow = table.tBodies[0].rows[currentRowIndex];
            if (!targetRow) return;

            const cellsToPaste = rowData.split('\t');
            cellsToPaste.forEach((cellData, j) => {
                const currentColIndex = startColIndex + j;
                const targetCell = targetRow.cells[currentColIndex];
                if (targetCell && targetCell.isContentEditable) {
                    targetCell.innerText = cellData.trim();
                }
            });
        });
        
        saveTableData(table.id);
        showToast('Đã dán và lưu dữ liệu!');
    }

    function handleTableKeyDown(event) {
        if (event.key !== 'Enter' || !event.target.isContentEditable) {
            return;
        }
        event.preventDefault();
        const currentCell = event.target;
        const currentRow = currentCell.parentElement;
        const cellIndex = currentCell.cellIndex;
        const nextRow = currentRow.nextElementSibling;
        if (nextRow) {
            const nextCell = nextRow.cells[cellIndex];
            if (nextCell && nextCell.isContentEditable) {
                nextCell.focus();
            }
        }
    }

    function saveTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const data = [];
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            const rowData = [];
            for (let j = 1; j < cells.length; j++) {
                rowData.push(cells[j].innerText);
            }
            data.push(rowData);
        }
        try {
            localStorage.setItem(tableId, JSON.stringify(data));
        } catch (e) {
            console.error("Lỗi khi lưu vào localStorage:", e);
        }
    }

    // CẬP NHẬT: Hàm tải dữ liệu nâng cao, ưu tiên file JSON, sau đó đến localStorage
    async function loadTableDataAdvanced(tableId, defaultData = {}, fromButtonClick = false) {
        const fileName = `${tableId}_data.json`;
        try {
            // Thêm cache-busting để đảm bảo luôn lấy file mới nhất khi bấm nút
            const response = await fetch(fileName, { cache: "no-store" }); 
            if (!response.ok) {
                throw new Error(`File ${fileName} not found, falling back to localStorage.`);
            }
            const dataToLoad = await response.json();
            if (!Array.isArray(dataToLoad)) {
                 throw new Error('Định dạng JSON không hợp lệ.');
            }
            
            const table = document.getElementById(tableId);
            if (!table) return;

            const tableRows = table.tBodies[0].rows;
            for (let i = 0; i < dataToLoad.length && i < tableRows.length; i++) {
                const rowData = dataToLoad[i];
                if (!Array.isArray(rowData)) continue;
                const cells = tableRows[i].cells;
                for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                    if (cells[j + 1] && cells[j + 1].isContentEditable) {
                        cells[j + 1].innerText = rowData[j];
                    }
                }
            }
            saveTableData(tableId); // Lưu lại vào localStorage để đồng bộ
            const tableName = tableId.includes('yearly') ? 'Năm' : 'So sánh Ngày';
            if(fromButtonClick) {
                showToast(`Đã tải dữ liệu cho bảng ${tableName} từ file!`, false);
            }
            console.log(`Đã tải thành công dữ liệu từ ${fileName}`);

        } catch (error) {
            console.warn(error.message);
            // Fallback: Tải từ localStorage hoặc dữ liệu mặc định
            if (fromButtonClick) { // Chỉ thông báo lỗi nếu người dùng chủ động bấm nút
                 showToast(`Không tìm thấy file ${fileName}. Đang dùng dữ liệu đã lưu.`, true);
            }
            loadTableDataFromStorage(tableId, defaultData);
        }
    }

    function loadTableDataFromStorage(tableId, defaultData = {}) {
        const table = document.getElementById(tableId);
        if (!table) return;
        
        let dataToLoad = defaultData[tableId] || [];
        try {
            const savedData = localStorage.getItem(tableId);
            if (savedData) {
                const parsedSavedData = JSON.parse(savedData);
                // Chỉ sử dụng dữ liệu đã lưu nếu nó không rỗng
                if (Array.isArray(parsedSavedData) && parsedSavedData.some(row => Array.isArray(row) && row.some(cell => cell && cell.trim() !== ''))) {
                    dataToLoad = parsedSavedData;
                }
            }
        } catch (e) {
            console.error("Lỗi khi tải từ localStorage:", e);
            dataToLoad = defaultData[tableId] || [];
        }

        const rows = table.tBodies[0].rows;
        for (let i = 0; i < dataToLoad.length && i < rows.length; i++) {
            const rowData = dataToLoad[i];
            const cells = rows[i].cells;
            for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                cells[j + 1].innerText = rowData[j];
            }
        }
    }

    function getStructuredTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) {
            console.error(`Table with id ${tableId} not found.`);
            return [];
        }

        const data = [];
        const keys = tableId === 'yearlyDataTable' 
            ? ['Tháng', 'Doanh thu tháng', 'Target tháng'] 
            : ['Ngày', 'DT Tháng này', 'DT Tháng trước'];

        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            if (!cells || cells.length < 2) continue;

            const rowObject = {};
            let hasData = false;

            rowObject[keys[0]] = cells[0] ? cells[0].innerText.trim() : '';

            const val1_str = cells[1] ? cells[1].innerText.trim().replace(/,/g, '') : '0';
            const val1 = parseFloat(val1_str);
            rowObject[keys[1]] = isNaN(val1) ? 0 : val1;
            if (!isNaN(val1) && val1 !== 0) hasData = true;
            
            if (keys.length > 2 && cells[2]) {
                 const val2_str = cells[2].innerText.trim().replace(/,/g, '');
                 const val2 = parseFloat(val2_str);
                 rowObject[keys[2]] = isNaN(val2) ? 0 : val2;
                 if (!isNaN(val2) && val2 !== 0) hasData = true;
            } else if (keys.length > 2) {
                rowObject[keys[2]] = 0;
            }

            if (hasData) {
                data.push(rowObject);
            }
        }
        return data;
    }
    
    function createYearlyDataTable() {
        const container = document.getElementById('yearlyDataInputContainer');
        let tableHTML = `
            <div class="interactive-table-wrapper">
                <table id="yearlyDataTable" class="interactive-table">
                    <thead>
                        <tr>
                            <th>Tháng</th>
                            <th>
                                <div class="th-content">
                                    <span>Doanh thu tháng</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="yearlyDataTable" data-col-index="1" title="Sao chép cột Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="yearlyDataTable" data-col-index="1" title="Dán vào cột Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="yearlyDataTable" data-col-index="1" title="Xoá dữ liệu cột Doanh thu"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <span>Target tháng</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="yearlyDataTable" data-col-index="2" title="Sao chép cột Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="yearlyDataTable" data-col-index="2" title="Dán vào cột Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="yearlyDataTable" data-col-index="2" title="Xoá dữ liệu cột Target"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>`;
        for (let i = 1; i <= 12; i++) {
            tableHTML += `<tr>
                                <td>${i}</td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                            </tr>`;
        }
        tableHTML += `</tbody></table></div>`;
        tableHTML += `
            <div class="table-io-actions">
                <button class="action-btn-small import" data-table-id="yearlyDataTable" title="Nhập dữ liệu từ file .json">Nhập Dữ liệu</button>
                <button class="action-btn-small export" data-table-id="yearlyDataTable" title="Xuất dữ liệu ra file .json">Xuất Dữ liệu</button>
            </div>
        `;
        container.innerHTML = tableHTML;

        const table = document.getElementById('yearlyDataTable');
        table.addEventListener('input', () => saveTableData('yearlyDataTable'));
        table.addEventListener('paste', (e) => handleTablePaste(e, table));
        table.addEventListener('keydown', handleTableKeyDown);
    }

    function createDailyComparisonTable() {
        const container = document.getElementById('dailyComparisonInputContainer');
        let tableHTML = `
            <div class="interactive-table-wrapper">
                <table id="dailyComparisonTable" class="interactive-table">
                    <thead>
                        <tr>
                            <th>Ngày</th>
                             <th>
                                <div class="th-content">
                                    <span>DT Tháng này</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="dailyComparisonTable" data-col-index="1" title="Sao chép cột DT Tháng này"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="dailyComparisonTable" data-col-index="1" title="Dán vào cột DT Tháng này"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="dailyComparisonTable" data-col-index="1" title="Xoá dữ liệu cột DT Tháng này"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                            <th>
                                <div class="th-content">
                                    <span>DT Tháng trước</span>
                                    <div class="col-actions">
                                        <button class="col-action-btn copy" data-table-id="dailyComparisonTable" data-col-index="2" title="Sao chép cột DT Tháng trước"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg></button>
                                        <button class="col-action-btn paste" data-table-id="dailyComparisonTable" data-col-index="2" title="Dán vào cột DT Tháng trước"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M17,1H4A2,2 0 0,0 2,3V17H4V3H17V1M21,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H21A2,2 0 0,0 23,21V7A2,2 0 0,0 21,5M11.5,17.5H10V14H11.5V17.5M15.5,17.5H14V14H15.5V17.5M19,12H9V9H19V12Z" /></svg></button>
                                        <button class="col-action-btn clear" data-table-id="dailyComparisonTable" data-col-index="2" title="Xoá dữ liệu cột DT Tháng trước"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" /></svg></button>
                                    </div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>`;
        for (let i = 1; i <= 31; i++) {
            tableHTML += `<tr>
                                <td>${i}</td>
                                <td contenteditable="true"></td>
                                <td contenteditable="true"></td>
                            </tr>`;
        }
        tableHTML += `</tbody></table></div>`;
        tableHTML += `
            <div class="table-io-actions">
                <button class="action-btn-small import" data-table-id="dailyComparisonTable" title="Nhập dữ liệu từ file .json">Nhập Dữ liệu</button>
                <button class="action-btn-small export" data-table-id="dailyComparisonTable" title="Xuất dữ liệu ra file .json">Xuất Dữ liệu</button>
            </div>
        `;
        container.innerHTML = tableHTML;

        const table = document.getElementById('dailyComparisonTable');
        table.addEventListener('input', () => saveTableData('dailyComparisonTable'));
        table.addEventListener('paste', (e) => handleTablePaste(e, table));
        table.addEventListener('keydown', handleTableKeyDown);
    }

    function exportTableData(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;
        const data = [];
        const rows = table.tBodies[0].rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;
            const rowData = [];
            for (let j = 1; j < cells.length; j++) {
                rowData.push(cells[j].innerText.trim());
            }
            data.push(rowData);
        }
        
        const jsonString = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${tableId}_data.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Đã xuất dữ liệu!');
    }

    function importTableData(tableId) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = readerEvent => {
                try {
                    const content = readerEvent.target.result;
                    const dataToLoad = JSON.parse(content);
                    
                    if (!Array.isArray(dataToLoad)) {
                        throw new Error('Định dạng JSON không hợp lệ.');
                    }

                    const table = document.getElementById(tableId);
                    if (!table) return;

                    const tableRows = table.tBodies[0].rows;
                    for (let i = 0; i < dataToLoad.length && i < tableRows.length; i++) {
                        const rowData = dataToLoad[i];
                        if (!Array.isArray(rowData)) continue;
                        const cells = tableRows[i].cells;
                        for (let j = 0; j < rowData.length && (j + 1) < cells.length; j++) {
                            if (cells[j + 1] && cells[j + 1].isContentEditable) {
                                cells[j + 1].innerText = rowData[j];
                            }
                        }
                    }
                    saveTableData(tableId);
                    showToast('Đã nhập dữ liệu thành công!');
                } catch (err) {
                    console.error('Lỗi khi nhập file:', err);
                    showToast(`Lỗi: ${err.message}`, true);
                }
            };
            reader.readAsText(file, 'UTF-8');
        };
        input.click();
    }

    /****************************************************************************
     * SHARED UTILITY & SETUP FUNCTIONS
     ****************************************************************************/
    var VIBRANT_PALETTE = ['#108AB1', '#06D7A0', '#FFD167', '#F78C6A', '#F04770', '#073A4B'];
    var formatNumber = (num, decimals = 0) => {
        const number = parseFloat(num);
        if (isNaN(number)) {
            return ''; 
        }
        return number.toLocaleString('vi-VN', { maximumFractionDigits: decimals });
    };
    var formatShortK = (num) => {
        if (isNaN(num) || num === 0) return '0';
        return (num / 1000).toLocaleString('vi-VN', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    };
    var getColor = (value, threshold1 = 50, threshold2 = 100) => value < threshold1 ? '#F04770' : value < threshold2 ? '#F78C6A' : '#06D7A0';
    
    function showToast(message, isError = false) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        if (isError) toast.classList.add('error');
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.parentNode && toast.parentNode.removeChild(toast), 500);
        }, 3000);
    }

    // CẬP NHẬT: Hàm cập nhật dữ liệu từ file JSON
    async function updateFromCloud() {
        showToast('Bắt đầu cập nhật dữ liệu từ cloud...');
        await loadTableDataAdvanced('yearlyDataTable', {}, true);
        await loadTableDataAdvanced('dailyComparisonTable', {}, true);
    }

    function openTab(evt, tabName) {
        Array.from(document.getElementsByClassName("tab-content")).forEach(tc => tc.style.display = "none");
        Array.from(document.getElementsByClassName("tab-button")).forEach(tb => tb.className = tb.className.replace(" active", ""));
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }
    
    function parseAllContestData(text) {
        const blocks = text.trim().split(/\n\s*\n/); 
        return blocks.map(block => parseSingleContestBlock(block)).filter(b => b.rows.length > 0); 
    }

    function parseSingleContestBlock(blockText) { 
        const lines = blockText.trim().split('\n').filter(l => l.trim() !== ''); 
        if (lines.length < 1) return { headers: [], rows: [] }; 
        const headers = lines[0].split('\t').map(h => h.trim()); 
        const rows = lines.slice(1).map(line => line.split('\t').map(cell => cell.trim())); 
        return { headers, rows }; 
    }

    function createContestItem(item, rank, isRealtime = false) {
        let statsHtml = `<strong>${formatNumber(item.actual)} / ${formatNumber(item.target)}</strong>`;
        if (item.remaining > 0) {
            statsHtml += ` | Còn lại: <strong>${formatNumber(item.remaining, 1)}</strong>`;
        }
        if (!isRealtime && item.dailyTarget > 0) {
            statsHtml += ` | MT Ngày: <strong>${formatNumber(item.dailyTarget, 1)}</strong>`;
        }
        statsHtml += ` | Dự kiến HT: <strong style="color: ${getColor(item.percentProjected)}">${formatNumber(item.percentProjected, 1)}%</strong>`;
        return `<div class="contest-item-new"><div class="contest-main-info"><span class="name-rank">#${rank} ${item.name}</span><span class="stats">${statsHtml}</span></div><div class="contest-progress-track"><div class="contest-progress-fill" style="width: ${item.percentProjected > 100 ? 100 : item.percentProjected}%; background-color: ${getColor(item.percentProjected)};"></div></div></div>`;
    }

    function processFullContestData(allContests, daysRemaining) {
        let processedItems = [];
        if (!allContests || allContests.length === 0) return { all: [], veDich:[], canCoGang:[], canTapTrung:[], baoDong:[], onTrack:[], behind:[] };
        allContests.forEach(contest => {
            const percentIndex = contest.headers.findIndex(h => h.toLowerCase().includes('% ht dự kiến') || h.toLowerCase().includes('%ht'));
            const actualIndex = contest.headers.findIndex(h => h.toLowerCase().includes('thực hiện') || h.toLowerCase().includes('dtqđ') || h.toLowerCase().includes('sllk') || h.toLowerCase().includes('dtlk'));
            const targetIndex = contest.headers.findIndex(h => h.toLowerCase().includes('target'));
            if (percentIndex === -1 || actualIndex === -1 || targetIndex === -1) {
                console.warn("Một bảng thi đua thiếu header cần thiết (target, thực hiện, %ht dự kiến), đã bỏ qua.");
                return;
            };
            const items = contest.rows.filter(row => row.length > 1 && row[0].toLowerCase() !== 'tổng' && row[0].toLowerCase() !== 'ngành hàng');
            items.forEach(row => {
                const actual = parseFloat(row[actualIndex].replace(/,/g, '')) || 0;
                const target = parseFloat(row[targetIndex].replace(/,/g, '')) || 0;
                const remaining = target - actual;
                processedItems.push({
                    name: row[0],
                    percentProjected: parseFloat(row[percentIndex]) || 0,
                    percentActual: target > 0 ? (actual / target * 100) : 0,
                    actual, target, remaining,
                    dailyTarget: remaining > 0 && daysRemaining > 0 ? remaining / daysRemaining : 0,
                });
            });
        });
        const sortedItems = processedItems.sort((a,b) => b.percentProjected - a.percentProjected);
        
        return {
            all: sortedItems,
            onTrack: sortedItems.filter(p => p.percentProjected >= 100),
            behind: sortedItems.filter(p => p.percentProjected < 100),
            veDich_actual: sortedItems.filter(p => p.percentActual >= 100),
            canCoGang_actual: sortedItems.filter(p => p.percentActual >= 80 && p.percentActual < 100),
            canTapTrung_actual: sortedItems.filter(p => p.percentActual >= 50 && p.percentActual < 80),
            baoDong_actual: sortedItems.filter(p => p.percentActual < 50)
        };
    }

    document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.container');
        container.innerHTML = `
            <header><h1>BI SIÊU THỊ ĐMX SAVICO</h1></header>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="openTab(event, 'luyKeTab')">Luỹ kế Siêu thị</button>
                <button class="tab-button" onclick="openTab(event, 'realtimeTab')">Real-time Siêu thị</button>
            </div>
            <div id="luyKeTab" class="tab-content active"></div>
            <div id="realtimeTab" class="tab-content"></div>
        `;
        
        document.getElementById('luyKeTab').innerHTML = `
            <div id="luyKeInputGrid" class="input-grid">
                <div class="input-section">
                    <div class="input-header-flex">
                        <h4><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnh&rt=2&dm=1" target="_blank" rel="noopener noreferrer">Dữ liệu Báo cáo Kinh doanh</a></h4>
                    </div>
                    <div class="input-wrapper">
                        <textarea id="mainDataInput" class="mainDataInput" placeholder="Dán dữ liệu từ BI vào đây..."></textarea>
                        <div class="paste-btn-container">
                            <button class="paste-btn" data-target="mainDataInput">Dán Thông Minh</button>
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <div class="input-header-flex">
                        <h4><a href="https://bi.thegioididong.com/thi-dua-st?id=16753&tab=1&rt=2&dm=2&mt=1" target="_blank" rel="noopener noreferrer">Dữ liệu Thi đua</a></h4>
                    </div>
                    <div class="input-wrapper">
                        <textarea id="contestDataInput" class="contestDataInput" placeholder="Dán dữ liệu thi đua vào đây..."></textarea>
                        <div class="paste-btn-container">
                            <button class="paste-btn" data-target="contestDataInput">Dán Thông Minh</button>
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <div class="input-header-flex">
                        <h4>Dữ liệu Năm (Bảng tương tác)</h4>
                    </div>
                    <div id="yearlyDataInputContainer"></div>
                </div>
                <div class="input-section">
                    <div class="input-header-flex">
                        <h4>Dữ liệu So sánh Ngày (Bảng tương tác)</h4>
                    </div>
                    <div id="dailyComparisonInputContainer"></div>
                </div>
            </div>
            <div class="button-container">
                 <button id="analyzeBtn" class="action-btn analyzeBtn">TẠO DASHBOARD LUỸ KẾ</button>
                 <button id="updateFromCloudBtn" class="action-btn" style="background: var(--secondary-accent);">
                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19.35,10.04C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.04C2.34,8.36 0,10.91 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.04M19,18H6A4,4 0 0,1 2,14C2,11.95 3.53,10.24 5.56,10.03L6.63,9.92L7.13,8.97C8.08,7.14 9.94,6 12,6C14.62,6 16.88,7.86 17.39,10.43L17.69,11.93L19.22,12.04C20.78,12.14 22,13.45 22,15A3,3 0 0,1 19,18M8,13H10.55V16H13.45V13H16L12,9L8,13Z" /></svg>
                     Cập nhật từ Cloud
                 </button>
                 <button id="showInputsBtnLuyKe" class="action-btn" style="display: none; background: #6c757d;">Chỉnh sửa Dữ liệu</button>
                 <button id="captureBtnLuyKe" class="action-btn captureBtn">
                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                     Chụp ảnh Báo cáo
                 </button>
            </div>
            <div id="dashboard-body-luyke" class="dashboard-body">
                <div id="capture-area-luyke">
                    <div id="capture-content-luyke">
                        <div id="reportTitleLuyKe" class="report-title"></div>
                        <div class="progress-bar-container card">
                            <div class="progress-labels"><span>Tiến độ Tháng</span><span id="progress-summary-date"></span></div>
                            <div class="progress-track"><div class="progress-fill" id="progress-fill-date"></div></div>
                            <div class="progress-text-wrapper"><span id="progress-text-date"></span></div>
                        </div>
                        <div class="progress-bar-container card">
                            <div class="progress-labels"><span>Tiến độ Target</span><span id="progress-summary-target"></span></div>
                            <div class="progress-track"><div class="progress-fill" id="progress-fill-target"></div></div>
                            <div class="progress-text-wrapper"><span id="progress-text-target"></span></div>
                        </div>
                        
                        <div id="kpi-group-container" class="kpi-group-container"></div>
                        
                        <div class="dashboard-layout-grid" style="grid-template-columns: 2fr 1fr;">
                            <div class="charts-column">
                                <div class="chart-wrapper card" id="yearly-revenue-chart-wrapper"></div>
                                <div class="chart-wrapper card" id="daily-comparison-chart-wrapper"></div>
                            </div>
                            <div class="charts-column">
                                <div class="chart-wrapper card" id="contribution-chart-wrapper"></div>
                                <div class="chart-wrapper card" id="growth-chart-wrapper"></div>
                            </div>
                        </div>

                        <div id="contest-table-luyke-wrapper" class="report-section card" style="grid-column: 1 / -1;"></div>

                    </div>
                    <div class="details-toggle">
                        <button id="toggleSpecificTablesBtn">📊 Ẩn/Hiện Bảng Chi tiết Ngành hàng</button>
                    </div>
                    <div id="specificTablesContainer" class="tables-container">
                        <div class="dashboard-layout-grid" style="gap: 25px;">
                            <div id="contest-results-container" class="report-section card contest-results-container" style="display:none;"></div>
                            <div class="report-section card" id="category-table-container"></div>
                        </div>
                    </div>
                </div>
                <div id="summary-report-wrapper-luyke" class="report-section card" style="display:none;"></div>
                <div class="details-toggle"><button id="toggleTablesBtn">🔍 Ẩn/Hiện Bảng Dữ liệu Đầy đủ</button></div>
                <div id="tablesContainer" class="tables-container">
                    <div id="main-table-wrapper" class="table-container card"></div>
                    <div id="comparison-table-wrapper" class="table-container card"></div>
                    <div id="contest-tables-wrapper" class="table-container card"></div>
                </div>
            </div>`;
        
        document.getElementById('realtimeTab').innerHTML = `
            <div id="realtimeInputGrid" class="input-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">
                <div class="input-section">
                    <h4><a href="https://bi.thegioididong.com/sieu-thi-con?id=16753&tab=bcdtnh&rt=1&dm=1" target="_blank" rel="noopener noreferrer">Dữ liệu Realtime Ngành hàng</a></h4>
                    <div class="input-wrapper">
                        <textarea id="realtimeDataInput" class="mainDataInput" placeholder="Dán dữ liệu ngành hàng..."></textarea>
                        <div class="paste-btn-container">
                            <button class="paste-btn" data-target="realtimeDataInput">Dán Thông Minh</button>
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <h4><a href="https://bi.thegioididong.com/thi-dua-st?id=16753&tab=1&rt=1&dm=2&mt=1" target="_blank" rel="noopener noreferrer">Dữ liệu Realtime Thi đua</a></h4>
                    <div class="input-wrapper">
                        <textarea id="realtimeContestDataInput" class="contestDataInput" placeholder="Dán dữ liệu thi đua..."></textarea>
                        <div class="paste-btn-container">
                            <button class="paste-btn" data-target="realtimeContestDataInput">Dán Thông Minh</button>
                        </div>
                    </div>
                </div>
                <div class="input-section">
                    <h4>Doanh thu Nhân viên (Dán)</h4>
                    <div class="input-wrapper">
                        <textarea id="employeeSalesDataInput" class="mainDataInput" placeholder="Dán dữ liệu doanh thu nhân viên vào đây..."></textarea>
                        <div class="paste-btn-container">
                            <button class="paste-btn" data-target="employeeSalesDataInput">Dán Thông Minh</button>
                        </div>
                    </div>
                </div>
             </div>
             <div class="button-container">
                <button id="analyzeBtn-rt" class="action-btn analyzeBtn">TẠO DASHBOARD REAL-TIME</button>
                <button id="showInputsBtnRt" class="action-btn" style="display: none; background: #6c757d;">Chỉnh sửa Dữ liệu</button>
                <button id="captureBtnRt" class="action-btn captureBtn">
                   <svg fill="currentColor" viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                   Chụp ảnh Báo cáo
                </button>
            </div>
            <div id="dashboard-body-rt" class="dashboard-body">
                <div id="capture-area-rt">
                    <div id="capture-content-rt">
                        <div id="reportTitleRt" class="report-title"></div>
                        <div class="progress-bar-container card">
                            <div class="progress-labels"><span>Tiến độ Thời gian làm việc (9h-22h)</span><span id="progress-summary-time">0%</span></div>
                            <div class="progress-track"><div class="progress-fill" id="progress-fill-time"></div></div>
                            <div class="progress-text-wrapper"><span id="progress-text-time"></span></div>
                        </div>
                        <div class="progress-bar-container card">
                            <div class="progress-labels"><span>Tiến độ Target Ngày</span><span id="progress-summary-target-rt"></span></div>
                            <div class="progress-track"><div class="progress-fill" id="progress-fill-target-rt"></div></div>
                            <div class="progress-text-wrapper"><span id="progress-text-target-rt"></span></div>
                        </div>
                        <div id="kpi-panel-rt" class="kpi-panel"></div>
                        <div id="employee-sales-chart-wrapper" class="card chart-wrapper" style="display: none; padding: 25px;"></div>
                        <div class="dashboard-layout-grid" style="grid-template-columns: 1fr 1fr; align-items: start; gap: 25px;">
                            <div id="contest-table-rt-wrapper" class="report-section card"></div>
                            <div id="category-table-rt-wrapper" class="report-section card"></div>
                        </div>
                    </div>
                </div>
                <div id="summary-report-wrapper-rt" class="report-section card" style="display:none;"></div>
                <div id="summary-report-wrapper-rt-employee" class="report-section card" style="display:none; margin-top: 25px;"></div>
            </div>`;

        Chart.register(ChartDataLabels);
        Chart.defaults.color = 'var(--text-muted)';
        Chart.defaults.font.family = 'system-ui, -apple-system, sans-serif';
        Chart.defaults.font.weight = '600';
        
        const defaultData = {
            yearlyDataTable: [
                ['11745', '11940'], ['7567', '7158'], ['7639', '7177'],
                ['9442', '6277'], ['8772', '7166'], ['9630', '7762'],
                ['6911', '8910'], [], [], [], [], []
            ],
            dailyComparisonTable: [
                ['116', '246'], ['114', '154'], ['116', '129'], ['','136'], ['','156'],
                ['','205'], ['','305'], ['','222'], ['','149'], ['','149'],
                ['','117'], ['','157'], ['','161'], ['','236'], ['','371'],
                ['','132'], ['','218'], ['','174'], ['','114'], ['','121'],
                ['','166'], ['','410'], ['','91'], ['','106'], ['','80'],
                ['','162'], ['','430'], ['','387'], ['','353'], ['','187'], []
            ]
        };

        createYearlyDataTable();
        createDailyComparisonTable();
        loadTableDataAdvanced('yearlyDataTable', defaultData);
        loadTableDataAdvanced('dailyComparisonTable', defaultData);

        setupLuyKeTab();
        setupRealtimeTab();
        
        setupSmartPasteButtons();
        
        document.getElementById('updateFromCloudBtn').addEventListener('click', updateFromCloud);

        document.body.addEventListener('click', function(e) {
            const colButton = e.target.closest('.col-action-btn');
            if (colButton) {
                const tableId = colButton.dataset.tableId;
                const colIndex = parseInt(colButton.dataset.colIndex, 10);

                if (colButton.classList.contains('copy')) {
                    copyColumnData(tableId, colIndex);
                } else if (colButton.classList.contains('paste')) {
                    pasteColumnData(tableId, colIndex);
                } else if (colButton.classList.contains('clear')) {
                    clearColumnData(tableId, colIndex);
                }
                return; 
            }

            const ioButton = e.target.closest('.action-btn-small');
            if (ioButton) {
                const tableId = ioButton.dataset.tableId;
                if (ioButton.classList.contains('import')) {
                    importTableData(tableId);
                } else if (ioButton.classList.contains('export')) {
                    exportTableData(tableId);
                }
                return;
            }
        });

        try {
            document.getElementById('mainDataInput').value = localStorage.getItem('luyKeMainData') || '';
            document.getElementById('contestDataInput').value = localStorage.getItem('luyKeContestData') || '';
            document.getElementById('realtimeDataInput').value = localStorage.getItem('realtimeMainData') || '';
            document.getElementById('realtimeContestDataInput').value = localStorage.getItem('realtimeContestData') || '';
            document.getElementById('employeeSalesDataInput').value = localStorage.getItem('employeeSalesData') || '';
        } catch (e) {
            console.error("Could not access localStorage. Data will not be saved.", e);
            showToast("Không thể truy cập bộ nhớ cục bộ. Dữ liệu sẽ không được lưu.", true);
        }
    });

    /****************************************************************************
     * TAB 1: LUỸ KẾ LOGIC                                     *
     ****************************************************************************/
    function setupLuyKeTab() {
        let allChartsLuyKe = [];
        const destroyAllChartsLuyKe = () => { allChartsLuyKe.forEach(chart => chart && chart.destroy()); allChartsLuyKe = []; };

        document.getElementById('analyzeBtn').addEventListener('click', () => { 
            const mainDataFromTextarea = document.getElementById('mainDataInput').value;
            const contestDataFromTextarea = document.getElementById('contestDataInput').value;
            try {
                localStorage.setItem('luyKeMainData', mainDataFromTextarea);
                localStorage.setItem('luyKeContestData', contestDataFromTextarea);
            } catch (e) { console.error("Could not save to localStorage", e); }

            const yearlyDataFromTable = getStructuredTableData('yearlyDataTable');
            const dailyDataFromTable = getStructuredTableData('dailyComparisonTable');

            if (!mainDataFromTextarea.trim()) { 
                showToast('Vui lòng dán dữ liệu Báo cáo Kinh doanh vào ô nhập liệu.', true); 
                return; 
            } 
            if (yearlyDataFromTable.length === 0 || dailyDataFromTable.length === 0) {
                showToast('Vui lòng nhập dữ liệu vào bảng Năm và So sánh Ngày.', true);
                return;
            }
            
            try { 
                const mainParsedData = parseLuyKeData(mainDataFromTextarea); 
                const contestParsedData = contestDataFromTextarea.trim() ? parseAllContestData(contestDataFromTextarea) : []; 
                
                document.getElementById('luyKeInputGrid').style.display = 'none';
                document.getElementById('showInputsBtnLuyKe').style.display = 'inline-flex';

                displayLuyKeDashboard(mainParsedData, contestParsedData, yearlyDataFromTable, dailyDataFromTable); 
            } catch (error) { 
                showToast("Lỗi xử lý dữ liệu Luỹ kế: " + error.message, true); 
                console.error(error); 
            } 
        });

        document.getElementById('showInputsBtnLuyKe').addEventListener('click', function() {
            const inputGrid = document.getElementById('luyKeInputGrid');
            const isHidden = inputGrid.style.display === 'none';
            inputGrid.style.display = isHidden ? 'grid' : 'none';
            this.textContent = isHidden ? 'Ẩn Mục Nhập Liệu' : 'Chỉnh sửa Dữ liệu';
        });
        
        document.getElementById('toggleSpecificTablesBtn').addEventListener('click', () => {
            document.getElementById('specificTablesContainer').classList.toggle('show');
        });

        document.getElementById('toggleTablesBtn').addEventListener('click', () => document.getElementById('tablesContainer').classList.toggle('show'));
        
        document.getElementById('captureBtnLuyKe').addEventListener('click', () => {
            const dashboardBody = document.getElementById('dashboard-body-luyke');
            if (dashboardBody.style.display === 'none') {
                showToast('Chưa có dữ liệu Luỹ kế để chụp ảnh.', true);
                return;
            }

            const specificTablesContainer = document.getElementById('specificTablesContainer');
            const tablesAreVisible = specificTablesContainer.classList.contains('show');
            
            const captureElement = tablesAreVisible 
                ? document.getElementById('capture-area-luyke') 
                : document.getElementById('capture-content-luyke');

            const mainContainer = document.querySelector('body');
            mainContainer.classList.add('capture-mode');
            
            setTimeout(() => {
                html2canvas(captureElement, { 
                    useCORS: true, 
                    backgroundColor: '#F4F7F9',
                    scale: 2.5 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `báo cáo luỹ kế ngày ${new Date().toLocaleDateString('vi-VN')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    showToast('Lỗi khi chụp ảnh. Hãy thử lại.', true);
                    console.error(err);
                }).finally(() => {
                    mainContainer.classList.remove('capture-mode');
                });
            }, 100);
        });

        function parseLuyKeData(text) { 
            const headers = [ "Nhóm ngành hàng", "Số lượng", "DTQĐ", "Target (QĐ)", "Lãi gộp QĐ", "% HT Target (QĐ)", "+/- DTCK Tháng (QĐ)", "Đơn giá", "DT Trả Góp", "Tỷ Trọng Trả Góp" ]; 
            const rawLines = text.trim().split('\n'); 
            const dataRows = rawLines[0].toLowerCase().includes('nhóm ngành hàng') ? rawLines.slice(1) : rawLines; 
            return dataRows.map(line => { 
                const values = line.split('\t'); 
                const rowObject = {}; 
                headers.forEach((header, index) => { 
                    const valueStr = values[index] || '0'; 
                    if (header === "Nhóm ngành hàng") {
                        rowObject[header] = valueStr.trim();
                    } else {
                        const cleanedValueStr = valueStr.replace(/,/g, '').replace(/%/, '');
                        rowObject[header] = parseFloat(cleanedValueStr) || 0; 
                    }
                }); 
                return rowObject; 
            }); 
        }
        
        function displayLuyKeDashboard(mainData, contestData, yearlyData, dailyData) {
            document.getElementById('dashboard-body-luyke').style.display = 'block';
            destroyAllChartsLuyKe();
            const totalRow = mainData.find(row => row["Nhóm ngành hàng"] === "Tổng");
            if (!totalRow) { throw new Error("Không tìm thấy dòng 'Tổng' trong dữ liệu Kinh doanh."); }
            
            let today = new Date();
            let reportDate = new Date(today);
            let daysUsed, daysInMonth, daysRemaining;

            if (today.getDate() === 1) {
                const prevMonthEndDate = new Date(today.getFullYear(), today.getMonth(), 0);
                daysInMonth = prevMonthEndDate.getDate();
                daysUsed = prevMonthEndDate.getDate();
                daysRemaining = 0;
                reportDate = prevMonthEndDate;
            } else {
                daysUsed = today.getDate() - 1;
                daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                daysRemaining = daysInMonth - daysUsed;
            }

            const categoryData = mainData.filter(row => row["Nhóm ngành hàng"] !== "Tổng");
            
            const luyKe = totalRow["DTQĐ"], target = totalRow["Target (QĐ)"], htTarget = luyKe > 0 && target > 0 ? (luyKe/target*100) : 0;
            const growthRate = totalRow["+/- DTCK Tháng (QĐ)"];
            const dtDuKien = (daysUsed > 0 ? (luyKe / daysUsed) : 0) * daysInMonth;
            const htDuKien = target > 0 ? (dtDuKien / target * 100) : 0;
            const chenhLech = luyKe - ((1 + growthRate / 100) !== 0 ? luyKe / (1 + growthRate / 100) : 0);
            const mucTieuNgay = daysRemaining > 0 ? (target - luyKe) / daysRemaining : 0;
            const mainKpis = { luyKe, target, htTarget, growthRate, dtDuKien, htDuKien, chenhLech, mucTieuNgay, tyTrongTraGop: totalRow["Tỷ Trọng Trả Góp"], doanhThuTraGop: totalRow["DT Trả Góp"] };

            const processedContestData = processFullContestData(contestData, daysRemaining);

            const dateString = `ngày ${reportDate.getDate()}/${reportDate.getMonth() + 1}/${reportDate.getFullYear()}`;
            document.getElementById('reportTitleLuyKe').textContent = `Báo cáo sức khoẻ siêu thị đến ${dateString}`;

            renderLuyKeKPIs(mainKpis, daysUsed, daysInMonth, yearlyData, reportDate);
            renderLuyKeCharts(categoryData);
            
            renderYearlyRevenueChart(yearlyData, mainKpis, reportDate);
            renderDailyComparisonChart(dailyData, yearlyData, mainKpis, reportDate, daysInMonth);

            renderLuyKeCategoryTables(categoryData);
            renderLuyKeContestTable(processedContestData);
            
            // CẬP NHẬT: Ẩn bảng kết quả thi đua và điều chỉnh layout
            document.getElementById('contest-results-container').style.display = 'none';
            const specificGrid = document.querySelector('#specificTablesContainer .dashboard-layout-grid');
            if (specificGrid) {
                specificGrid.style.gridTemplateColumns = '1fr';
            }
            // renderLuyKeContestResults(processedContestData); // Không render nữa

            renderLuyKeSummary(mainKpis, processedContestData, reportDate);
            displayLuyKeHiddenTables(mainData, contestData);
        }
        
        function renderLuyKeKPIs(kpis, daysUsed, daysInMonth, yearlyData, reportDate) {
            const progressPercentDate = (daysUsed / daysInMonth) * 100;
            document.getElementById('progress-fill-date').style.width = `${progressPercentDate}%`;
            document.getElementById('progress-text-date').textContent = `Đã qua ${daysUsed}/${daysInMonth} ngày`;
            document.getElementById('progress-summary-date').textContent = `${formatNumber(progressPercentDate, 1)}%`;
            
            const progressPercentTarget = kpis.htTarget > 100 ? 100 : kpis.htTarget;
            const htTargetColor = getColor(kpis.htTarget);
            const progressFillTarget = document.getElementById('progress-fill-target');
            progressFillTarget.style.width = `${progressPercentTarget}%`;
            progressFillTarget.style.backgroundColor = htTargetColor;
            document.getElementById('progress-text-target').textContent = `${formatNumber(kpis.htTarget, 1)}%`;
            document.getElementById('progress-summary-target').textContent = `${formatNumber(kpis.luyKe)} / ${formatNumber(kpis.target)}`;
            
            const kpiContainer = document.getElementById('kpi-group-container');
            const today = new Date();
            const currentMonth = reportDate.getMonth() + 1;
            const dayOfWeek = today.getDay();

            const doanhThuConLai = kpis.target - kpis.luyKe;
            const doanhThuConLaiDisplay = doanhThuConLai <= 0 ? '🏆' : `${formatNumber(doanhThuConLai, 0)} Triệu`;
            const doanhThuConLaiColor = doanhThuConLai <= 0 ? 'var(--success-color)' : 'var(--text-primary)';
            const iconDoanhThuConLai = doanhThuConLai <= 0 
                ? '<path fill="currentColor" d="M19.5,2H4.5A2.5,2.5 0 0,0 2,4.5V7H4V18A4,4 0 0,0 8,22H16A4,4 0 0,0 20,18V7H22V4.5A2.5,2.5 0 0,0 19.5,2M18,7V18A2,2 0 0,1 16,20H8A2,2 0 0,1 6,18V7Z"/>' 
                : '<path fill="currentColor" d="M13,9H11V4H13V9M12,13.5A1.5,1.5 0 0,1 10.5,12A1.5,1.5 0 0,1 12,10.5A1.5,1.5 0 0,1 13.5,12A1.5,1.5 0 0,1 12,13.5M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12C22,6.48 17.5,2 12,2Z"/>';

            const yearlyTargetTotal = yearlyData
                .filter(row => parseInt(row['Tháng']) <= currentMonth)
                .reduce((sum, row) => sum + (row['Target tháng'] || 0), 0);
            const pastMonthsActual = yearlyData
                .filter(row => parseInt(row['Tháng']) < currentMonth)
                .reduce((sum, row) => sum + (row['Doanh thu tháng'] || 0), 0);
            const yearlyActualTotal = pastMonthsActual + kpis.dtDuKien;
            const yearlyPercent = yearlyTargetTotal > 0 ? (yearlyActualTotal / yearlyTargetTotal * 100) : 0;
            const yearlyRemaining = yearlyTargetTotal - yearlyActualTotal;
            
            const daysRemainingInMonth = daysInMonth - today.getDate() + 1;
            const mucTieuTraNoNgay = daysRemainingInMonth > 0 ? (yearlyRemaining / daysRemainingInMonth) : 0;
            
            const mucTieuKyVongThang = kpis.target / daysInMonth;
            let mucTieuNgayKyVong = Math.max(mucTieuKyVongThang, kpis.mucTieuNgay);
            
            let kyVongLabel = "Mục tiêu ngày kỳ vọng";
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                mucTieuNgayKyVong *= 2;
                kyVongLabel += " (x2 T7/CN)";
            }

            kpiContainer.innerHTML = `
                <div class="kpi-group-card">
                    <div class="kpi-group-header blue"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>TIẾN ĐỘ THÁNG</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v-2h-2z"/></svg>Target tháng</span><span class="kpi-value">${formatNumber(kpis.target, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M4 18h16v-2H4v2zm0-5h16v-2H4v2zm0-5h16V6H4v2z"/></svg>Luỹ kế</span><span class="kpi-value">${formatNumber(kpis.luyKe, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>% Thực hiện</span><span class="kpi-value">${formatNumber(kpis.htTarget, 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>DT dự kiến</span><span class="kpi-value">${formatNumber(kpis.dtDuKien, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>% HT dự kiến</span><span class="kpi-value" style="color: ${getColor(kpis.htDuKien)}">${formatNumber(kpis.htDuKien, 2)}%</span></div>
                    </div>
                </div>
                <div class="kpi-group-card">
                    <div class="kpi-group-header orange"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M11 2v9h9a9 9 0 00-9-9zm2 1.08a7 7 0 016.92 6.92H13V3.08zM4 12a8 8 0 018-8v8H4zm9 8a8 8 0 01-8-8h8v8z"/></svg>PHÂN TÍCH CHI TIẾT</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,9L8,13H11V17H13V13H16L12,9Z"/></svg>Mục tiêu ngày</span><span class="kpi-value">${formatNumber(kpis.mucTieuNgay, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24">${iconDoanhThuConLai}</svg>Doanh thu còn lại</span><span class="kpi-value" style="color: ${doanhThuConLaiColor}; font-size: ${doanhThuConLai <= 0 ? '1.8em' : '1.15em'}">${doanhThuConLaiDisplay}</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>% Tăng trưởng</span><span class="kpi-value" style="color: ${kpis.growthRate >= 0 ? '#06D7A0' : '#F04770'}">${kpis.growthRate >= 0 ? '▲' : '▼'} ${formatNumber(Math.abs(kpis.growthRate), 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg>± DT cùng kỳ</span><span class="kpi-value" style="color: ${kpis.chenhLech >= 0 ? '#06D7A0' : '#F04770'}">${kpis.chenhLech >= 0 ? '▲' : '▼'} ${formatNumber(Math.abs(kpis.chenhLech), 0)}</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M21,11H12.42A3,3 0 0,1 12,11.58V13.42A3,3 0 0,1 12.42,14H21V16H12.42A3,3 0 0,1 10,18.42V20H8V18.42A3,3 0 0,1 5.58,16H3V14H5.58A3,3 0 0,1 8,11.58V10H10V11.58A3,3 0 0,1 12.42,14H15V12H12.42A3,3 0 0,1 10,9.58V8H8V9.58A3,3 0 0,1 5.58,12H3V10H5.58A3,3 0 0,1 8,7.58V6H10V7.58A3,3 0 0,1 12.42,10H21V11Z"/></svg>Tỷ trọng trả góp</span><span class="kpi-value" style="color: ${kpis.tyTrongTraGop < 20 ? '#F04770' : '#06D7A0'}">${formatNumber(kpis.tyTrongTraGop, 1)}%</span></div>
                    </div>
                </div>
                <div class="kpi-group-card">
                    <div class="kpi-group-header red"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M10 20H4V8h6m0 12V8H4a2 2 0 00-2 2v8a2 2 0 002 2h6m8-14h-4a2 2 0 00-2 2v10a2 2 0 002 2h4a2 2 0 002-2V8a2 2 0 00-2-2m-4 12V8h4v10h-4z"/></svg>NỢ & MỤC TIÊU NỢ</div>
                    <div class="kpi-group-body">
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.5 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5.5-2.5l7.51-3.49L17.5 6.5 9.99 9.99 6.5 17.5zm5.5-6.6c.61 0 1.1.49 1.1 1.1s-.49 1.1-1.1 1.1-1.1-.49-1.1-1.1.49-1.1 1.1-1.1z"/></svg>DT Nợ năm</span><span class="kpi-value">${formatNumber(yearlyRemaining, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>% HT năm</span><span class="kpi-value" style="color: ${getColor(yearlyPercent)}">${formatNumber(yearlyPercent, 2)}%</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M13 13h-2V7h2m0 10h-2v-2h2M12 2A10 10 0 1 0 22 12 10 10 0 0 0 12 2Z"/></svg>Mục tiêu trả nợ/ngày</span><span class="kpi-value">${formatNumber(mucTieuTraNoNgay, 0)} Triệu</span></div>
                        <div class="kpi-item"><span class="kpi-label"><svg fill="currentColor" viewBox="0 0 24 24"><path d="M12,12.5A1.5,1.5 0 0,1 10.5,11A1.5,1.5 0 0,1 12,9.5A1.5,1.5 0 0,1 13.5,11A1.5,1.5 0 0,1 12,12.5M12,7.2C9.9,7.2 8.2,8.9 8.2,11C8.2,14 12,17.5 12,17.5C12,17.5 15.8,14 15.8,11C15.8,8.9 14.1,7.2 12,7.2M12,2A9,9 0 0,0 3,11C3,15.55 10.04,21.86 11.23,22.77C11.5,23 11.75,23.06 12,23.06C12.25,23.06 12.5,23 12.77,22.77C13.96,21.86 21,15.55 21,11A9,9 0 0,0 12,2Z"/></svg>${kyVongLabel}</span><span class="kpi-value" style="color: var(--danger-color); font-weight: bold;">${formatNumber(mucTieuNgayKyVong, 0)} Triệu</span></div>
                    </div>
                </div>
            `;
        }
        
        function renderLuyKeCharts(data) {
            const chartData = data.filter(row => row["DTQĐ"] > 0);
            const growthData = data.filter(r => r.DTQĐ !== 0 || (r["+/- DTCK Tháng (QĐ)"] !== 0 && r["+/- DTCK Tháng (QĐ)"] !== -100));
            
            const contributionWrapper = document.getElementById('contribution-chart-wrapper');
            contributionWrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M11 2v9h9a9 9 0 00-9-9zm2 1.08a7 7 0 016.92 6.92H13V3.08zM4 12a8 8 0 018-8v8H4zm9 8a8 8 0 01-8-8h8v8z"/></svg>Tỷ trọng Doanh thu</h2><div class="chart-container" style="height: 300px;"><canvas id="contributionChart"></canvas></div>`;
            const growthWrapper = document.getElementById('growth-chart-wrapper');
            growthWrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M22,21H2V3H4V19H22V21M18,17V9H20V17H18M14,17V12H16V17H14M10,17V5H12V17H10M6,17V14H8V17H6Z"/></svg>Tăng/Giảm Cùng kỳ</h2><div class="chart-container" style="height: 300px;"><canvas id="growthDriverChart"></canvas></div>`;
            
            const sortedDataByDT = [...chartData].sort((a, b) => b.DTQĐ - a.DTQĐ);
            const top6 = sortedDataByDT.slice(0, 6);
            const othersValue = sortedDataByDT.slice(6).reduce((s, r) => s + r.DTQĐ, 0);
            if (othersValue > 0) {
                top6.push({ "Nhóm ngành hàng": "Ngành hàng khác", "DTQĐ": othersValue });
            }

            const contributionLabels = top6.map(d => d["Nhóm ngành hàng"]);
            const contributionValues = top6.map(d => d.DTQĐ);
            
            const contributionChart = new Chart('contributionChart', { 
                type: 'doughnut', 
                data: { 
                    labels: contributionLabels, 
                    datasets: [{ 
                        data: contributionValues, 
                        backgroundColor: VIBRANT_PALETTE 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            formatter: (v, ctx) => { 
                                const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0); 
                                const p = (v * 100 / total).toFixed(0) + '%'; 
                                const l = ctx.chart.data.labels[ctx.dataIndex]; 
                                return `${l}\n${formatNumber(v, 0)}\n(${p})`;
                            }, 
                            color: '#fff', 
                            font: { weight: 'bold', size: 12 }, 
                            textStrokeColor: 'rgba(0,0,0,0.5)', 
                            textStrokeWidth: 2 
                        } 
                    } 
                } 
            });
            allChartsLuyKe.push(contributionChart);

            const calcData = growthData.map(r => ({ name: r["Nhóm ngành hàng"], diff: r.DTQĐ - ((1 + r["+/- DTCK Tháng (QĐ)"] / 100) !== 0 ? r.DTQĐ / (1 + r["+/- DTCK Tháng (QĐ)"] / 100) : 0) })).filter(d => d.diff !== 0).sort((a, b) => a.diff - b.diff);
            const growthDriverChart = new Chart('growthDriverChart', { type: 'bar', data: { labels: calcData.map(d => d.name), datasets: [{ data: calcData.map(d => d.diff), backgroundColor: VIBRANT_PALETTE }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff', font: { weight: 'bold', size: 12 }, textStrokeColor: 'rgba(0,0,0,0.5)', textStrokeWidth: 2, formatter: (v) => formatNumber(v), anchor: 'center', align: 'center' } }, scales: { x: { grid: { display: false } }, y: { grid: { display: false } } } } });
            allChartsLuyKe.push(growthDriverChart);
        }
        
        function renderLuyKeContestTable(processedContest) {
            const wrapper = document.getElementById('contest-table-luyke-wrapper');
            if (!processedContest.all || processedContest.all.length === 0) {
                wrapper.innerHTML = '<h2>Bảng chi tiết Thi đua</h2><p>Không có dữ liệu thi đua.</p>';
                return;
            }

            const completedItems = processedContest.onTrack.length;
            const totalItems = processedContest.all.length;
            const progressPercentContest = totalItems > 0 ? (completedItems / totalItems * 100) : 0;
            const contestProgressColor = getColor(progressPercentContest, 50, 80);
            const progressBarHtml = `
                <div class="progress-bar-container" style="padding: 0 0 25px 0;">
                    <div class="progress-labels">
                        <span>Tiến độ Về Đích (Dự kiến)</span>
                        <span>${completedItems} / ${totalItems} Nhóm</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${progressPercentContest}%; background-color: ${contestProgressColor};"></div>
                    </div>
                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(progressPercentContest, 1)}%</span></div>
                </div>`;

            const topPerformers = processedContest.all.filter(p => p.percentProjected >= 70);
            const needsImprovement = processedContest.all.filter(p => p.percentProjected < 70);

            const createProgressBar = (percent) => {
                const color = getColor(percent);
                const displayPercent = Math.min(percent, 120);
                return `
                    <div class="bar-wrapper">
                        <span class="bar-percent-text" style="color: ${color};">${formatNumber(percent, 1)}%</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width: ${displayPercent}%; background-color: ${color};"></div>
                        </div>
                    </div>
                `;
            };

            const createContestDetailTable = (data, title, titleClass, isTopPerformer = false) => {
                if (data.length === 0) return '';
                
                let tableRows = data.map((item, index) => {
                    const rank = index + 1;
                    const icon = isTopPerformer && rank === 1 ? '🏆' : (item.percentProjected >= 100 ? '🚀' : '');
                    const tooltipText = item.percentProjected < 50 ? "Cần tập trung cao độ!" : item.percentProjected < 70 ? "Cần cải thiện thêm!" : "Duy trì phong độ tốt!";
                    
                    const remainingCell = item.remaining <= 0
                        ? `<td style="color: var(--success-color); font-weight: bold;">Hoàn thành</td>`
                        : `<td class="col-negative">${formatNumber(item.remaining, 1)}</td>`;

                    return `
                        <tr data-category-name="${item.name.toLowerCase()}">
                            <td class="col-rank">${icon} ${rank}</td>
                            <td class="col-category">
                                <div class="tooltip">${item.name}<span class="tooltiptext">${tooltipText}</span></div>
                            </td>
                            <td>${formatNumber(item.dailyTarget, 1)}</td>
                            <td>${formatNumber(item.target)}</td>
                            <td>${formatNumber(item.actual)}</td>
                            ${remainingCell}
                            <td class="progress-bar-cell">${createProgressBar(item.percentActual)}</td>
                            <td class="progress-bar-cell">${createProgressBar(item.percentProjected)}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div class="contest-group">
                        <h3 class="contest-group-title ${titleClass}">
                            ${isTopPerformer ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20.34,9.32l-1.4-4.29A2,2,0,0,0,17.09,4H6.91a2,2,0,0,0-1.85,1L3.66,9.32a1,1,0,0,0,.37,1.1l.49,.35-.16,1.8-3.2,3.2A1,1,0,0,0,2,17v3a1,1,0,0,0,1,1H21a1,1,0,0,0,1-1V17a1,1,0,0,0-.78-1.23l-3.2-3.2.16-1.8.49-.35a1,1,0,0,0,.37-1.1ZM12,6a3,3,0,1,1-3,3A3,3,0,0,1,12,6Z"/></svg>' : '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12,6a3.91,3.91,0,0,0-4,4,3.91,3.91,0,0,0,4,4,3.91,3.91,0,0,0,4-4,3.91,3.91,0,0,0-4-4Zm0,6a1.94,1.94,0,0,1-2-2,1.94,1.94,0,0,1,2-2,1.94,1.94,0,0,1,2,2,1.94,1.94,0,0,1-2,2Zm8.72,2.72L18,11.85V7a1,1,0,0,0-1-1H7A1,1,0,0,0,6,7v4.85L3.28,14.72A2,2,0,0,0,3,16.15V19a2,2,0,0,0,2,2H19a2,2,0,0,0,2-2v-2.85a2,2,0,0,0-.28-1.43ZM19,19H5V16.15l3-3V7H16v6.15l3,3Z"/></svg>'}
                            ${title} (${data.length})
                        </h3>
                        <div class="table-responsive">
                            <table class="contest-detail-table">
                                <thead>
                                    <tr>
                                        <th class="col-rank">#</th>
                                        <th class="col-category">Ngành hàng</th>
                                        <th>MT Ngày</th>
                                        <th>Target</th>
                                        <th>Lũy kế</th>
                                        <th>Còn lại</th>
                                        <th>% HT</th>
                                        <th>% HT Dự kiến</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };
            
            const finalHtml = `
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M13,9V3.5L18.5,9M6,2C4.89,2 4,2.89 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z" /></svg>Bảng Chi Tiết Thi Đua Ngành Hàng</h2>
                ${progressBarHtml}
                <div class="contest-split-layout">
                    ${createContestDetailTable(topPerformers, 'Ngành Hàng Hiệu Quả', 'top-performers', true)}
                    ${createContestDetailTable(needsImprovement, 'Ngành Hàng Cần Cải Thiện', 'needs-improvement')}
                </div>
            `;
            
            wrapper.innerHTML = finalHtml;
        }
        
        function renderYearlyRevenueChart(yearlyData, kpis, reportDate) {
            const wrapper = document.getElementById('yearly-revenue-chart-wrapper');
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3A2,2 0 0,1 21,5V19A2,2 0 0,1 19,21H5A2,2 0 0,1 3,19V5A2,2 0 0,1 5,3H6V1H8V3H16V1H18V3H19M19,19V8H5V19H19Z"/></svg>Doanh thu Năm</h2><div class="chart-container" style="height: 300px;"><canvas id="yearlyRevenueChart"></canvas></div>`;
            
            const currentMonth = reportDate.getMonth() + 1;
            const labels = yearlyData.map(d => `Th ${d['Tháng']}`);
            const targets = yearlyData.map(d => d['Target tháng']);
            const actuals = yearlyData.map(d => {
                return parseInt(d['Tháng']) === currentMonth ? kpis.dtDuKien : d['Doanh thu tháng'];
            });

            const yearlyChart = new Chart('yearlyRevenueChart', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Target tháng',
                            data: targets,
                            backgroundColor: VIBRANT_PALETTE[4],
                            borderColor: VIBRANT_PALETTE[4],
                            borderWidth: 1,
                            datalabels: {
                                color: 'var(--text-muted)',
                                anchor: 'end',
                                align: 'top',
                                formatter: (value) => value > 0 ? formatNumber(value) : '',
                            }
                        },
                        {
                            label: 'Doanh thu thực hiện',
                            data: actuals,
                            backgroundColor: VIBRANT_PALETTE[0],
                            borderColor: VIBRANT_PALETTE[0],
                            borderWidth: 1,
                            datalabels: {
                                color: 'var(--text-primary)',
                                anchor: 'end',
                                align: 'top',
                                offset: -5,
                                font: { weight: 'bold' },
                                formatter: (value, context) => {
                                    if (!value || value === 0) return '';
                                    const targetValue = context.chart.data.datasets[0].data[context.dataIndex];
                                    const percentage = targetValue > 0 ? `(${(value / targetValue * 100).toFixed(0)}%)` : '';
                                    return `${formatNumber(value)}\n${percentage}`;
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false 
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value);
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false 
                            }
                        }
                    }
                }
            });
            allChartsLuyKe.push(yearlyChart);
        }

        function renderDailyComparisonChart(dailyData, yearlyData, kpis, reportDate, daysInMonth) {
            const wrapper = document.getElementById('daily-comparison-chart-wrapper');
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H18V1M17,12H12V17H17V12Z"/></svg>So sánh Doanh thu Ngày</h2><div class="chart-container" style="height: 300px;"><canvas id="dailyComparisonChart"></canvas></div>`;
            
            const currentMonth = reportDate.getMonth() + 1;
            const monthTargetData = yearlyData.find(row => parseInt(row['Tháng']) === currentMonth);
            const monthTarget = monthTargetData ? (monthTargetData['Target tháng'] || 0) : 0;
            const dailyTarget = monthTarget > 0 && daysInMonth > 0 ? monthTarget / daysInMonth : (kpis.target > 0 && daysInMonth > 0 ? kpis.target / daysInMonth : 0);

            const labels = Array.from({ length: daysInMonth }, (_, i) => `Ngày ${i + 1}`);

            const thisMonthRevenue = new Array(daysInMonth).fill(null);
            const lastMonthRevenue = new Array(daysInMonth).fill(null);
            
            const currentDay = reportDate.getDate();
            dailyData.forEach(d => {
                const dayIndex = parseInt(d['Ngày']) - 1;
                if (dayIndex >= 0 && dayIndex < daysInMonth) {
                    if (d['DT Tháng này'] > 0 && (dayIndex + 1) <= currentDay) {
                        thisMonthRevenue[dayIndex] = d['DT Tháng này'];
                    }
                    if (d['DT Tháng trước'] > 0) {
                        lastMonthRevenue[dayIndex] = d['DT Tháng trước'];
                    }
                }
            });

            const weekendColorCallback = (context) => {
                const day = context.dataIndex + 1;
                const date = new Date(reportDate.getFullYear(), reportDate.getMonth(), day);
                const dayOfWeek = date.getDay();
                return dayOfWeek === 0 || dayOfWeek === 6 ? '#F04770' : '#108AB1';
            };

            const dailyChart = new Chart('dailyComparisonChart', {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hiện tại',
                            data: thisMonthRevenue,
                            backgroundColor: weekendColorCallback,
                            order: 2,
                            datalabels: {
                                display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null,
                                formatter: (value) => formatNumber(value, 0),
                                color: (ctx) => weekendColorCallback(ctx),
                                align: 'top',
                                anchor: 'end',
                                offset: -5,
                                font: { weight: 'bold' }
                            }
                        },
                        {
                            type: 'line',
                            label: 'Tháng trước',
                            data: lastMonthRevenue,
                            borderColor: '#5A7A84', 
                            backgroundColor: '#5A7A84',
                            pointBackgroundColor: (context) => {
                                if (context.dataIndex === null || context.dataIndex >= daysInMonth) return '#5A7A84';
                                const day = context.dataIndex + 1;
                                const prevMonthDate = new Date(reportDate.getFullYear(), reportDate.getMonth() - 1, day);
                                const dayOfWeek = prevMonthDate.getDay();
                                return dayOfWeek === 0 || dayOfWeek === 6 ? '#F04770' : '#5A7A84';
                            },
                            borderDash: [5, 5],
                            pointRadius: 4,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            order: 1,
                            datalabels: {
                                display: (ctx) => ctx.dataset.data[ctx.dataIndex] !== null,
                                formatter: (value) => formatNumber(value, 0),
                                color: '#5A7A84',
                                align: 'bottom',
                                font: { size: 10 }
                            }
                        },
                        {
                            type: 'line',
                            label: 'Target',
                            data: Array(daysInMonth).fill(dailyTarget),
                            borderColor: '#FFD167', 
                            backgroundColor: '#FFD167',
                            borderDash: [10, 5], 
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            order: 0,
                            datalabels: {
                                display: true,
                                color: '#FFD167',
                                align: 'end',
                                anchor: 'end',
                                formatter: (value, context) => context.dataIndex === Math.floor(daysInMonth / 2) ? formatNumber(value, 0) : '',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top',
                             labels: {
                                usePointStyle: true,
                            }
                        },
                        datalabels: {
                            display: true,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { display: false },
                            ticks: {
                                callback: (value) => formatNumber(value, 0)
                            }
                        },
                        x: {
                             grid: { display: false },
                             ticks: {
                                 callback: function(val) {
                                     return this.getLabelForValue(val).replace('Ngày ','');
                                 },
                                 autoSkip: false,
                                 maxRotation: 0,
                                 minRotation: 0
                             }
                        }
                    }
                }
            });
            allChartsLuyKe.push(dailyChart);
        }


        function renderLuyKeCategoryTables(data) {
            const categoryContainer = document.getElementById('category-table-container');
            const categoryData = data.filter(d => d["DTQĐ"] > 0).sort((a,b) => b.DTQĐ - a.DTQĐ);

            if (categoryData.length === 0) {
                categoryContainer.innerHTML = '<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>Bảng Chi tiết Ngành hàng</h2><p>Không có dữ liệu.</p>';
                return;
            }

            const midpoint = Math.ceil(categoryData.length / 2);
            const leftData = categoryData.slice(0, midpoint);
            const rightData = categoryData.slice(midpoint);

            const createTableHtml = (data) => {
                let tableHtml = '<table><thead><tr><th>Ngành hàng</th><th>Doanh thu</th><th>Target</th><th>%HT</th></tr></thead><tbody>';
                data.forEach(row => { 
                    tableHtml += `<tr><td>${row["Nhóm ngành hàng"]}</td><td>${formatNumber(row["DTQĐ"])}</td><td>${formatNumber(row["Target (QĐ)"])}</td><td style="color: ${getColor(row["% HT Target (QĐ)"])}">${formatNumber(row["% HT Target (QĐ)"], 1)}%</td></tr>`; 
                });
                tableHtml += '</tbody></table>';
                return tableHtml;
            };

            categoryContainer.innerHTML = `
                <h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>Bảng Chi tiết Ngành hàng</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
                    <div>${createTableHtml(leftData)}</div>
                    <div>${rightData.length > 0 ? createTableHtml(rightData) : ''}</div>
                </div>
            `;
        }
        
        // CẬP NHẬT: Hàm này không còn được gọi để hiển thị, chỉ để tham khảo logic
        function renderLuyKeContestResults(processedContest) {
            const container = document.getElementById('contest-results-container');
            container.innerHTML = ''; 
            
            if (!processedContest.all || processedContest.all.length === 0) { 
                container.style.display = 'none';
                return; 
            }
            container.style.display = 'block';

            const headerHtml = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/></svg>Kết Quả Thi Đua</h2>`;
            const contentGrid = document.createElement('div');
            contentGrid.className = 'card-content';

            const onTrackItems = processedContest.onTrack;
            const behindItems = processedContest.behind;

            if (onTrackItems.length > 0) {
                const onTrackCol = document.createElement('div');
                onTrackCol.className = 'contest-column-visual';
                let onTrackHtml = onTrackItems.map((item, index) => createContestItem(item, index + 1)).join('');
                onTrackCol.innerHTML = `
                    <div class="status-icon-wrapper green">
                        <svg fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                    </div>
                    <h4 class="on-track">Dự kiến Về Đích (${onTrackItems.length})</h4>
                    <div class="contest-list-new">${onTrackHtml}</div>
                `;
                contentGrid.appendChild(onTrackCol);
            }

            if (behindItems.length > 0) {
                const behindCol = document.createElement('div');
                behindCol.className = 'contest-column-visual';
                let behindHtml = behindItems.map((item, index) => createContestItem(item, index + 1)).join('');
                behindCol.innerHTML = `
                    <div class="status-icon-wrapper red">
                         <svg fill="currentColor" viewBox="0 0 24 24"><path d="M11,15H13V17H11V15M11,7H13V13H11V7M12,2C6.47,2 2,6.47 2,12C2,17.53 6.47,22 12,22C17.53,22 22,17.53 22,12C22,6.47 17.53,2 12,2Z"/></svg>
                    </div>
                    <h4 class="behind">Chậm Tiến Độ (${behindItems.length})</h4>
                    <div class="contest-list-new">${behindHtml}</div>
                `;
                contentGrid.appendChild(behindCol);
            }

            container.innerHTML = headerHtml;
            container.appendChild(contentGrid);
        }
        
        function renderLuyKeSummary(kpis, contest, reportDate) {
            const container = document.getElementById('summary-report-wrapper-luyke');
            container.style.display = 'block';
            if (!kpis) { container.innerHTML = ''; return; }
            
            const dateToUse = reportDate || new Date();
            const dateString = `ngày ${dateToUse.getDate()}/${dateToUse.getMonth() + 1}/${dateToUse.getFullYear()}`;
            const growthText = kpis.chenhLech >= 0 ? 'Tăng' : 'Giảm';

            const createSubListWithActual = (items, showDailyTarget = false) => {
                if (!items || items.length === 0) return '';
                return items.map(item =>
                    `  - ${item.name} (${formatNumber(item.percentActual, 1)}%)` +
                    (showDailyTarget && item.dailyTarget > 0 ? `: cần ${formatNumber(item.dailyTarget, 1)}/ngày` : '')
                ).join('\n');
            };

            const onTrackCount = contest.onTrack.length;
            const totalCount = contest.all.length;
            
            let contestSummarySections = [];
            if (contest.veDich_actual.length > 0) {
                contestSummarySections.push(`✅ ĐÃ VỀ ĐÍCH (${contest.veDich_actual.length} nhóm):\n${createSubListWithActual(contest.veDich_actual)}`);
            }
            if (contest.canCoGang_actual.length > 0) {
                contestSummarySections.push(`💪 CẦN CỐ GẮNG (${contest.canCoGang_actual.length} nhóm - HT >80%):\n${createSubListWithActual(contest.canCoGang_actual, true)}`);
            }
            if (contest.canTapTrung_actual.length > 0) {
                contestSummarySections.push(`🎯 CẦN TẬP TRUNG (${contest.canTapTrung_actual.length} nhóm - HT >50%):\n${createSubListWithActual(contest.canTapTrung_actual, true)}`);
            }
            if (contest.baoDong_actual.length > 0) {
                const baoDongList = contest.baoDong_actual.map(item => `${item.name} (${formatNumber(item.percentActual, 1)}%)`).join(', ');
                contestSummarySections.push(`🚨 BÁO ĐỘNG (${contest.baoDong_actual.length} nhóm - HT <50%): ${baoDongList}`);
            }

            const summaryText = `📊 BÁO CÁO SỨC KHOẺ SIÊU THỊ - ${dateString} 📊
-------------------
- 🎯 Target Tháng: ${formatNumber(kpis.target)}
- 📈 Luỹ kế đạt: ${formatNumber(kpis.luyKe)} (${formatNumber(kpis.htTarget, 1)}%)
- 📉 DT còn lại: ${formatNumber(kpis.target - kpis.luyKe)}
- 🚀 Dự kiến đạt: ${formatNumber(kpis.dtDuKien)} (${formatNumber(kpis.htDuKien, 1)}%)
- 💹 So với cùng kỳ: ${growthText} ${formatNumber(Math.abs(kpis.chenhLech))} (${kpis.growthRate}%)
- 💳 Tỷ trọng trả góp: ${formatNumber(kpis.tyTrongTraGop, 2)}%
- 💵 Doanh thu trả góp: ${formatNumber(kpis.doanhThuTraGop)}
- 💰 Mục tiêu ngày: ${formatNumber(kpis.mucTieuNgay > 0 ? kpis.mucTieuNgay : 0)}
- 🏆 Số ngành hàng thi đua dự kiến đạt: ${onTrackCount}/${totalCount}
-------------------
${contestSummarySections.join('\n\n')}`.trim();

            const html = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z" /></svg>Nhận xét (Dạng văn bản)</h2>
                                 <textarea class="summary-textarea" readonly>${summaryText}</textarea>
                                 <button class="action-btn copySummaryBtn" style="width: 100%; max-width: 400px; margin: 15px auto 0 auto;">
                                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                                     Sao chép Nhận xét
                                 </button>`;
            container.innerHTML = html;
            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = e.currentTarget.previousElementSibling;
                textarea.select();
                document.execCommand('copy');
                showToast('Đã sao chép nhận xét!');
            });
        }

        function displayLuyKeHiddenTables(mainData, contestData) { 
            const mainWrapper = document.getElementById('main-table-wrapper'); mainWrapper.innerHTML = '<h2>Bảng 1: Dữ liệu Kinh doanh</h2><table id="main-data-table"></table>'; const mainTable = document.getElementById('main-data-table'); const mainHeaders = Object.keys(mainData[0]); const mainThead = mainTable.createTHead(); mainThead.insertRow().innerHTML = mainHeaders.map(h => `<th>${h}</th>`).join(''); const mainTbody = mainTable.createTBody(); mainData.forEach(rowData => { const row = mainTbody.insertRow(); row.innerHTML = mainHeaders.map(header => { let value = rowData[header]; let cellContent = typeof value === 'number' ? formatNumber(value,2) : value; if (header.includes('%') || header.includes('Tỷ Trọng')) cellContent += '%'; return `<td>${cellContent}</td>`; }).join(''); }); 
            const compWrapper = document.getElementById('comparison-table-wrapper'); compWrapper.innerHTML = '<h2>Bảng 2: So sánh Cùng kỳ</h2><table id="comparison-table"></table>'; const compTable = document.getElementById('comparison-table'); const compHeaders = ["Nhóm ngành hàng", "DT Tháng này (QĐ)", "DT Tháng trước (Ước tính)", "+/- Cùng kỳ", "Chênh lệch (QĐ)"]; const compThead = compTable.createTHead(); compThead.insertRow().innerHTML = compHeaders.map(h => `<th>${h}</th>`).join(''); const compTbody = compTable.createTBody(); mainData.filter(r => r["DTQĐ"] > 0 || r["+/- DTCK Tháng (QĐ)"] !== 0).forEach(rowData => { const dtThis = rowData["DTQĐ"], growth = rowData["+/- DTCK Tháng (QĐ)"]; const dtLast = (1 + growth / 100) !== 0 ? dtThis / (1 + growth / 100) : 0; const diff = dtThis - dtLast; const row = compTbody.insertRow(); const diffClass = diff > 0 ? 'text-green' : diff < 0 ? 'text-red' : ''; row.innerHTML = `<td>${rowData["Nhóm ngành hàng"]}</td><td>${formatNumber(dtThis)}</td><td>${formatNumber(dtLast)}</td><td>${growth}%</td><td class="${diffClass}">${formatNumber(diff)}</td>`; });
            const contestWrapper = document.getElementById('contest-tables-wrapper'); contestWrapper.innerHTML = ""; if(contestData && contestData.length > 0) { contestData.forEach((contest, idx) => { const tableContainer = document.createElement('div'); tableContainer.className = 'table-container'; tableContainer.innerHTML = `<h2 style="margin-top: 25px;">Bảng ${3+idx}: Thi đua - ${contest.headers[0]}</h2><table class="contest-data-table"></table>`; const table = tableContainer.querySelector('.contest-data-table'); const thead = table.createTHead(); thead.insertRow().innerHTML = contest.headers.map(h => `<th>${h}</th>`).join(''); const tbody = table.createTBody(); contest.rows.forEach(rowData => { const row = tbody.insertRow(); row.innerHTML = rowData.map(cell => `<td>${cell}</td>`).join(''); }); contestWrapper.appendChild(tableContainer); }); }
        }
    }


    /****************************************************************************
     * TAB 2: REAL-TIME LOGIC                                     *
     ****************************************************************************/
    function setupRealtimeTab() {
        let timeInterval;
        let employeeChart = null;
        let installmentChart = null;
        let lastEmployeeData = [];

        document.getElementById('analyzeBtn-rt').addEventListener('click', () => { 
            const mainDataRaw = document.getElementById('realtimeDataInput').value; 
            const contestDataRaw = document.getElementById('realtimeContestDataInput').value; 
            const employeeDataRaw = document.getElementById('employeeSalesDataInput').value;
            
            try {
                localStorage.setItem('realtimeMainData', mainDataRaw);
                localStorage.setItem('realtimeContestData', contestDataRaw);
                localStorage.setItem('employeeSalesData', employeeDataRaw);
            } catch(e) {
                console.error("Could not access localStorage. Data will not be saved.", e);
            }

            if (!mainDataRaw.trim()) { showToast('Vui lòng dán dữ liệu Realtime Ngành hàng.', true); return; } 
            try { 
                const mainParsedData = parseRealtimeData(mainDataRaw); 
                const contestParsedData = contestDataRaw.trim() ? parseRealtimeData(contestDataRaw) : []; 
                const employeeParsedData = employeeDataRaw.trim() ? parseEmployeeSalesData(employeeDataRaw) : [];

                lastEmployeeData = employeeParsedData;

                document.getElementById('realtimeInputGrid').style.display = 'none';
                document.getElementById('showInputsBtnRt').style.display = 'inline-flex';

                displayRealtimeDashboard(mainParsedData, contestParsedData, employeeParsedData); 
            } catch (error) { 
                showToast("Lỗi xử lý dữ liệu Realtime: " + error.message, true); 
                console.error(error); 
            } 
        });

        document.getElementById('showInputsBtnRt').addEventListener('click', function() {
            const inputGrid = document.getElementById('realtimeInputGrid');
            const isHidden = inputGrid.style.display === 'none';
            inputGrid.style.display = isHidden ? 'grid' : 'none';
            this.textContent = isHidden ? 'Ẩn Mục Nhập Liệu' : 'Chỉnh sửa Dữ liệu';
        });
        
        document.getElementById('captureBtnRt').addEventListener('click', () => {
            const dashboardBody = document.getElementById('dashboard-body-rt');
            if (dashboardBody.style.display === 'none') {
                showToast('Chưa có dữ liệu Realtime để chụp ảnh.', true);
                return;
            }
            
            const captureElement = document.getElementById('capture-content-rt');

            const mainContainer = document.querySelector('body');
            mainContainer.classList.add('capture-mode');
            
            setTimeout(() => {
                html2canvas(captureElement, { 
                    useCORS: true, 
                    backgroundColor: '#F4F7F9',
                    scale: 2.5 
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `báo cáo realtime ${new Date().toLocaleTimeString('vi-VN')}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => { 
                    showToast('Lỗi khi chụp ảnh. Hãy thử lại.', true);
                    console.error(err);
                }).finally(() => {
                    mainContainer.classList.remove('capture-mode');
                });
            }, 100);
        });

        function parseRealtimeData(text) {
            const lines = text.trim().split('\n').filter(l => l.trim() !== '');
            if (lines.length < 1) {
                return []; 
            }
            const headers = lines[0].split('\t').map(h => h.trim().toLowerCase());
            
            const nameIndex = headers.findIndex(h => h.includes("ngành hàng"));
            const actualIndex = headers.findIndex(h => h.includes("dt realtime") || h.includes('thực hiện') || h.includes('dtqđ') || h.includes('sllk') || h.includes('dtlk'));
            const targetIndex = headers.findIndex(h => h.includes("target ngày") || h.includes('target'));
            const percentIndex = headers.findIndex(h => h.includes("% ht target ngày") || h.includes('% ht'));
            const installmentIndex = headers.findIndex(h => h.includes("dt trả góp"));
            const installmentPercentIndex = headers.findIndex(h => h.includes("tỷ trọng trả góp"));
            const quantityIndex = headers.findIndex(h => h.includes("sl realtime") || h.includes("số lượng"));

            if (nameIndex === -1 || actualIndex === -1 || targetIndex === -1) {
                throw new Error("Dữ liệu Realtime thiếu các cột bắt buộc. Vui lòng kiểm tra lại tiêu đề các cột, cần có: 'Ngành hàng', 'Thực hiện' (hoặc 'DT Realtime'), và 'Target' (hoặc 'Target Ngày').");
            }

            const dataRows = lines.slice(1);
            return dataRows.map(line => {
                const values = line.split('\t');
                
                const getFloatValue = (index) => {
                    if (index === -1 || index >= values.length || !values[index]) return 0;
                    const cleanedValueStr = values[index].replace(/,/g, '').replace(/%/, '');
                    return parseFloat(cleanedValueStr) || 0;
                }
                
                return {
                    "Nhóm ngành hàng": values[nameIndex] || '',
                    "DT Realtime (QĐ)": getFloatValue(actualIndex),
                    "Target Ngày (QĐ)": getFloatValue(targetIndex),
                    "% HT Target Ngày (QĐ)": getFloatValue(percentIndex),
                    "DT Trả Góp": getFloatValue(installmentIndex),
                    "Tỷ trọng trả góp": getFloatValue(installmentPercentIndex),
                    "Số lượng": getFloatValue(quantityIndex)
                };
            });
        }
        
        function parseEmployeeSalesData(text) {
            const lines = text.trim().split('\n');
            const data = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (!line || 
                    line.toLowerCase().startsWith('nhân viên') || 
                    line.toLowerCase().startsWith('tổng') ||
                    line.toLowerCase().includes('online')) {
                    return;
                }

                const regex = /^\d+\s*-\s*(.+?)\s+[\d-]+\s+(-?[\d,.]+)$/;
                const match = line.match(regex);

                if (match) {
                    const name = match[1].trim();
                    const revenueStr = match[2] || '0'; 
                    const revenue = parseFloat(revenueStr.replace(/,/g, '')) || 0;
                    data.push({ name, revenue });
                }
            });
            
            return data;
        }
        
        function displayRealtimeDashboard(mainData, contestData, employeeData) {
            document.getElementById('dashboard-body-rt').style.display = 'block';
            if(timeInterval) clearInterval(timeInterval);
            if(employeeChart) employeeChart.destroy();
            if(installmentChart) installmentChart.destroy();

            renderTimeProgressBar();
            timeInterval = setInterval(renderTimeProgressBar, 60000);

            const totalRow = mainData.find(row => row["Nhóm ngành hàng"].toLowerCase() === "tổng");
            if (!totalRow) throw new Error("Không tìm thấy dòng 'Tổng' trong dữ liệu Realtime.");
            
            const processedContestData = processRealtimeContestData(contestData); 

            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute:'2-digit' });
            document.getElementById('reportTitleRt').textContent = `Báo cáo doanh thu siêu thị đến ${timeString}`;
            
            renderRealtimeKPIs(totalRow, processedContestData);
            renderRealtimeTargetProgress(totalRow);
            renderEmployeeSalesChart(employeeData);
            renderRealtimeContestTable(processedContestData);
            renderRealtimeCategoryTable(mainData);
            
            renderRealtimeSummary(totalRow, processedContestData);
            renderEmployeeSummary(employeeData);
        }

        function getTimePassedFraction() {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 9, 0, 0);
            const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 22, 0, 0);
            if (now <= start) return 0.001; 
            if (now >= end) return 1;
            const totalMinutes = (end - start) / 60000;
            const elapsedMinutes = (now - start) / 60000;
            return elapsedMinutes / totalMinutes;
        }

        function processRealtimeContestData(contestData) {
            if (!contestData || contestData.length === 0) return { all: [], onTrack: [], behind: [], veDich_actual: [], canCoGang_actual: [], canTapTrung_actual: [] };
            const timeFraction = getTimePassedFraction();
            
            const items = contestData
                .filter(row => row["Nhóm ngành hàng"].toLowerCase() !== 'tổng' && row["Nhóm ngành hàng"].toLowerCase() !== 'ngành hàng')
                .map(row => {
                    const actual = row['DT Realtime (QĐ)'];
                    const target = row['Target Ngày (QĐ)'];
                    const projectedSales = timeFraction > 0 && timeFraction < 1 ? (actual / timeFraction) : actual;
                    const percentProjected = target > 0 ? (projectedSales / target * 100) : 0;
                    return {
                        name: row['Nhóm ngành hàng'],
                        actual: actual,
                        target: target,
                        remaining: target - actual,
                        percentProjected: percentProjected,
                        percentActual: row['% HT Target Ngày (QĐ)']
                    };
                })
                .sort((a,b) => b.percentProjected - a.percentProjected);

            return {
                all: items,
                onTrack: items.filter(p => p.percentProjected >= 100),
                behind: items.filter(p => p.percentProjected < 100),
                veDich_actual: items.filter(p => p.percentActual >= 100),
                canCoGang_actual: items.filter(p => p.percentActual >= 80 && p.percentActual < 100),
                canTapTrung_actual: items.filter(p => p.percentActual < 80)
            };
        }

        function renderTimeProgressBar() {
            const percent = getTimePassedFraction() * 100;
            const now = new Date();
            document.getElementById('progress-fill-time').style.width = `${percent}%`;
            document.getElementById('progress-text-time').textContent = `Đã qua ${formatNumber(percent,1)}% thời gian (${now.toLocaleTimeString('vi-VN')})`;
            document.getElementById('progress-summary-time').textContent = now.toLocaleTimeString('vi-VN');
        }

        function renderRealtimeTargetProgress(totalRow) {
            const htThuc = totalRow['% HT Target Ngày (QĐ)'];
            const progressFill = document.getElementById('progress-fill-target-rt');
            progressFill.style.width = `${htThuc > 100 ? 100 : htThuc}%`;
            progressFill.style.backgroundColor = getColor(htThuc);
            document.getElementById('progress-text-target-rt').textContent = `Thực tế ${formatNumber(htThuc, 1)}%`;
            document.getElementById('progress-summary-target-rt').textContent = `${formatNumber(totalRow['DT Realtime (QĐ)'])} / ${formatNumber(totalRow['Target Ngày (QĐ)'])}`;
        }

        function renderRealtimeKPIs(totalRow, contestData) {
            const kpiPanel = document.getElementById('kpi-panel-rt');
            const ht = totalRow['% HT Target Ngày (QĐ)'];
            const timeFraction = getTimePassedFraction();
            const projectedSales = timeFraction > 0 && timeFraction < 1 ? (totalRow['DT Realtime (QĐ)'] / timeFraction) : totalRow['DT Realtime (QĐ)'];
            const projectedHt = totalRow['Target Ngày (QĐ)'] > 0 ? (projectedSales / totalRow['Target Ngày (QĐ)'] * 100) : 0;
            const onTrackCount = contestData.onTrack.length;
            const totalCount = contestData.all.length;
            const remainingRevenue = totalRow['Target Ngày (QĐ)'] - totalRow['DT Realtime (QĐ)'];
            const installmentPercent = totalRow['Tỷ trọng trả góp'];

            const getInstallmentColor = (percent) => {
                if (percent < 20) return '#F04770';
                if (percent < 30) return '#F78C6A';
                return '#06D7A0';
            };

            const kpis = [
                { id: 'kpi-target', title: 'Target Ngày', value: formatNumber(totalRow['Target Ngày (QĐ)']), subtext: 'Mục tiêu hôm nay', icon: '<path fill="currentColor" d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z"/>' },
                { id: 'kpi-realtime', title: 'DT Realtime', value: formatNumber(totalRow['DT Realtime (QĐ)']), subtext: `${formatNumber(ht,1)}% HT`, color: getColor(ht), icon: '<path fill="currentColor" d="M9 14.5A2.5 2.5 0 0 1 6.5 12A2.5 2.5 0 0 1 9 9.5V14.5M9 16.5A4.5 4.5 0 0 0 13.5 12A4.5 4.5 0 0 0 9 7.5V16.5M22 12l-4-4v3H3v2h15v3l4-4Z"/>' },
                { id: 'kpi-remaining', title: 'DT Còn lại', value: remainingRevenue <= 0 ? '🏆' : formatNumber(remainingRevenue), subtext: remainingRevenue <= 0 ? 'Đã hoàn thành!' : 'Cần đạt thêm', color: remainingRevenue <= 0 ? '#06D7A0' : '#F04770', icon: '<path fill="currentColor" d="M12,6A6,6 0 0,1 18,12C18,14.21 16.84,16.21 15,17.2V19A1,1 0 0,1 14,20H10A1,1 0 0,1 9,19V17.2C7.16,16.21 6,14.21 6,12A6,6 0 0,1 12,6M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4Z"/>' },
                { id: 'kpi-projected', title: 'Dự kiến đạt', value: formatNumber(projectedSales), subtext: `${formatNumber(projectedHt, 1)}%`, color: getColor(projectedHt), icon: '<path fill="currentColor" d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6h-6z"/>' },
                { id: 'kpi-contest', title: 'Thi đua đạt', value: `${onTrackCount}/${totalCount}`, subtext: 'Chương trình Về Đích', icon: '<path fill="currentColor" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>' },
                { id: 'kpi-installment', title: 'Tỷ trọng Trả góp', value: `${formatNumber(installmentPercent, 2)}%`, subtext: "DT: " + formatNumber(totalRow['DT Trả Góp']), icon: '<path fill="currentColor" d="M21,11H12.42A3,3 0 0,1 12,11.58V13.42A3,3 0 0,1 12.42,14H21V16H12.42A3,3 0 0,1 10,18.42V20H8V18.42A3,3 0 0,1 5.58,16H3V14H5.58A3,3 0 0,1 8,11.58V10H10V11.58A3,3 0 0,1 12.42,14H15V12H12.42A3,3 0 0,1 10,9.58V8H8V9.58A3,3 0 0,1 5.58,12H3V10H5.58A3,3 0 0,1 8,7.58V6H10V7.58A3,3 0 0,1 12.42,10H21V11Z"/>' },
            ];
            kpiPanel.innerHTML = kpis.map(kpi => {
                if(kpi.id === 'kpi-installment') {
                    return `<div class="sub-kpi-card card kpi-installment-card">
                                <div class="text-content">
                                    <h4><svg class="title-icon" viewBox="0 0 24 24">${kpi.icon}</svg>${kpi.title}</h4>
                                    <p class="sub-text">${kpi.subtext}</p>
                                </div>
                                <div class="chart-content">
                                    <canvas id="installment-pie-chart-rt"></canvas>
                                    <div id="installment-pie-text" class="chart-inner-text"></div>
                                </div>
                            </div>`;
                }
                return `<div class="sub-kpi-card card">
                            <h4><svg class="title-icon" viewBox="0 0 24 24">${kpi.icon}</svg>${kpi.title}</h4>
                            <p class="value" style="color: ${kpi.color || 'var(--primary-accent)'}">${kpi.value}</p>
                            <p class="sub-text">${kpi.subtext}</p>
                        </div>`;
            }).join('');

            const installmentCtx = document.getElementById('installment-pie-chart-rt').getContext('2d');
            document.getElementById('installment-pie-text').textContent = `${formatNumber(installmentPercent, 1)}%`;

            installmentChart = new Chart(installmentCtx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [installmentPercent, 100 - installmentPercent],
                        backgroundColor: [getInstallmentColor(installmentPercent), '#e9ecef'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: { display: false }
                    }
                }
            });
        }
        
        function renderEmployeeSalesChart(data) {
            const wrapper = document.getElementById('employee-sales-chart-wrapper');
            if (!data || data.length === 0) {
                wrapper.style.display = 'none';
                return;
            }
            wrapper.style.display = 'block';
            wrapper.innerHTML = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>Xếp hạng Doanh thu Nhân viên</h2><div class="chart-container" style="min-height: 300px; height: ${data.length * 45}px;"><canvas id="employeeSalesChart"></canvas></div>`;

            const canvas = document.getElementById('employeeSalesChart');
            const ctx = canvas.getContext('2d');
            
            const sortedData = data.sort((a, b) => b.revenue - a.revenue);

            const labels = sortedData.map((d) => {
                let icon = '';
                if (d.revenue > 0) {
                    const positiveRank = sortedData.filter(item => item.revenue > 0).findIndex(item => item.name === d.name);
                    if (positiveRank === 0) icon = '🥇 ';
                    else if (positiveRank === 1) icon = '🥈 ';
                    else if (positiveRank === 2) icon = '🥉 ';
                } else if (d.revenue < 0) {
                    icon = '📉 '; 
                } else {
                    icon = '💤 '; 
                }
                return icon + d.name;
            });
            const revenues = sortedData.map(d => d.revenue);

            const gradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            gradient.addColorStop(0, 'rgba(6, 215, 160, 0.9)'); 
            gradient.addColorStop(0.5, 'rgba(16, 185, 129, 0.9)'); 
            gradient.addColorStop(1, 'rgba(16, 138, 177, 0.9)'); 

            const negativeGradient = ctx.createLinearGradient(0, 0, canvas.width, 0);
            negativeGradient.addColorStop(0, 'rgba(240, 71, 112, 0.9)'); 
            negativeGradient.addColorStop(1, 'rgba(247, 140, 106, 0.9)');

            employeeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu',
                        data: revenues,
                        backgroundColor: (context) => context.raw >= 0 ? gradient : negativeGradient,
                        borderColor: (context) => context.raw >= 0 ? 'rgba(7, 58, 75, 0.7)' : 'rgba(150, 30, 60, 0.7)',
                        borderWidth: 2,
                        // CẬP NHẬT: Sửa lỗi bo tròn cho cột âm
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            right: 35 
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)',
                                borderDash: [2, 4],
                            },
                            ticks: {
                                callback: (value) => formatNumber(value / 1000000, 2) + 'tr'
                            },
                            position: 'top'
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: { size: 14, weight: '600' }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             enabled: true,
                             backgroundColor: 'rgba(7, 58, 75, 0.9)',
                             titleFont: { size: 14, weight: 'bold' },
                             bodyFont: { size: 12 },
                             callbacks: {
                                 label: function(context) {
                                     return ` Doanh thu: ${formatNumber(context.raw)} VNĐ`;
                                 }
                             }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            offset: 4,
                            color: 'var(--text-primary)',
                            font: { weight: 'bold', size: 13 },
                            formatter: (value) => {
                                if (value === 0) return 'Chưa có DT';
                                return formatNumber(value / 1000000, 2) + 'tr';
                            },
                        }
                    }
                }
            });
        }
        
        function renderRealtimeContestTable(processedContest) {
            const wrapper = document.getElementById('contest-table-rt-wrapper');
            if (!processedContest.all || processedContest.all.length === 0) {
                wrapper.innerHTML = '<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M5,4H19A2,2 0 0,1 21,6V18A2,2 0 0,1 19,20H5A2,2 0 0,1 3,18V6A2,2 0 0,1 5,4M5,8V12H11V8H5M13,8V12H19V8H13M5,14V18H11V14H5M13,14V18H19V14H13Z" /></svg>Bảng chi tiết Thi đua Real-time</h2><p>Không có dữ liệu thi đua.</p>';
                return;
            }
            wrapper.style.display = 'block';

            const itemsWithRevenue = processedContest.all.filter(item => item.actual > 0);
            const itemsWithoutRevenue = processedContest.all.filter(item => item.actual <= 0);

            const completedItems = processedContest.onTrack.length;
            const totalItems = processedContest.all.length;
            const progressPercentContest = totalItems > 0 ? (completedItems / totalItems * 100) : 0;
            const contestProgressColor = getColor(progressPercentContest);
            const progressBarHtml = `
                <div class="progress-bar-container" style="padding: 0 0 20px 0;">
                    <div class="progress-labels">
                        <span>Tiến độ Về Đích</span>
                        <span>${completedItems} / ${totalItems} Nhóm</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width: ${progressPercentContest}%; background-color: ${contestProgressColor};"></div>
                    </div>
                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(progressPercentContest, 1)}%</span></div>
                </div>`;
            
            let tableHtml = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M5,4H19A2,2 0 0,1 21,6V18A2,2 0 0,1 19,20H5A2,2 0 0,1 3,18V6A2,2 0 0,1 5,4M5,8V12H11V8H5M13,8V12H19V8H13M5,14V18H11V14H5M13,14V18H19V14H13Z" /></svg>Bảng chi tiết Thi đua Real-time</h2>
                                 ${progressBarHtml}
                                 <table class="rt-styled-table">
                                     <thead>
                                         <tr><th>#</th><th>Ngành hàng</th><th>DT Realtime</th><th>Còn lại</th><th>Target Ngày</th><th>% HT</th><th>% HT Dự kiến</th></tr>
                                     </thead>
                                     <tbody>`;

            itemsWithRevenue.forEach((item, index) => {
                const remainingCell = item.remaining <= 0 ? `<td style="color: var(--success-color); font-weight: bold; font-size: 1.5em;">🏆</td>` : `<td style="color: var(--danger-color); font-weight: bold;">${formatNumber(item.remaining, 1)}</td>`;
                const icon = item.percentProjected >= 100 ? ' <span title="Dự kiến hoàn thành!">🚀</span>' : '';
                tableHtml += `<tr>
                    <td>${index + 1}${icon}</td>
                    <td style="text-align: left !important;">${item.name}</td>
                    <td>${formatNumber(item.actual)}</td>
                    ${remainingCell}
                    <td>${formatNumber(item.target)}</td>
                    <td style="color: ${getColor(item.percentActual)}; font-weight: bold;">${formatNumber(item.percentActual, 1)}%</td>
                    <td style="color: ${getColor(item.percentProjected)}; font-weight: bold;">${formatNumber(item.percentProjected, 1)}%</td>
                </tr>`;
            });
            tableHtml += '</tbody></table>';
            wrapper.innerHTML = tableHtml;

            if (itemsWithoutRevenue.length > 0) {
                 const noRevenueHtml = `<div id="contest-no-revenue-section" class="no-revenue-section" style="display:none;">
                                     <h4>Nhóm chưa phát sinh doanh thu (${itemsWithoutRevenue.length}):</h4>
                                     <ul class="no-revenue-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                                         ${itemsWithoutRevenue.map((item, index) => `<li>${index + 1}. ${item.name}</li>`).join('')}
                                     </ul>
                                   </div>`;
                const buttonHtml = `<div class="details-toggle" style="margin-top: 15px;">
                                    <button id="toggle-contest-no-revenue-btn">
                                        Hiện ${itemsWithoutRevenue.length} nhóm chưa có DT
                                    </button>
                                </div>`;
                
                wrapper.insertAdjacentHTML('beforeend', buttonHtml + noRevenueHtml);

                const toggleBtn = document.getElementById('toggle-contest-no-revenue-btn');
                const noRevenueSection = document.getElementById('contest-no-revenue-section');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = noRevenueSection.style.display === 'none';
                    noRevenueSection.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? `Ẩn ${itemsWithoutRevenue.length} nhóm chưa có DT` : `Hiện ${itemsWithoutRevenue.length} nhóm chưa có DT`;
                });
            }
        }
        
        function renderRealtimeCategoryTable(mainData) {
            const wrapper = document.getElementById('category-table-rt-wrapper');
            if (!mainData || mainData.length === 0) {
                wrapper.style.display = 'none';
                return;
            }
            wrapper.style.display = 'block';

            const totalRow = mainData.find(row => row["Nhóm ngành hàng"].toLowerCase() === "tổng");
            const categoryData = mainData.filter(row => 
                row["Nhóm ngành hàng"].toLowerCase() !== "tổng" && 
                row["Target Ngày (QĐ)"] > 0
            );
            
            const categoriesWithRevenue = categoryData.filter(row => row["DT Realtime (QĐ)"] > 0).sort((a,b) => b["DT Realtime (QĐ)"] - a["DT Realtime (QĐ)"]);
            const categoriesWithoutRevenue = categoryData.filter(row => row["DT Realtime (QĐ)"] <= 0);

            let mainProgressBarHtml = '';
            if (totalRow) {
                const htThuc = totalRow['% HT Target Ngày (QĐ)'];
                mainProgressBarHtml = `<div class="progress-bar-container" style="padding: 0 0 20px 0;">
                                    <div class="progress-labels"><span>Tiến độ Target Ngày (Tổng)</span><span>${formatNumber(totalRow['DT Realtime (QĐ)'])} / ${formatNumber(totalRow['Target Ngày (QĐ)'])}</span></div>
                                    <div class="progress-track"><div class="progress-fill" style="width: ${htThuc > 100 ? 100 : htThuc}%; background-color: ${getColor(htThuc)};"></div></div>
                                    <div class="progress-text-wrapper"><span class="progress-text">${formatNumber(htThuc, 1)}%</span></div>
                                </div>`;
            }

            let tableHtml = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M3,4H21V6H3V4M3,7H21V9H3V7M3,10H21V12H3V10M3,13H21V15H3V13M3,16H21V18H3V16Z"/></svg>Bảng chi tiết Ngành hàng</h2>
                                 ${mainProgressBarHtml}
                                 <table class="rt-styled-table">
                                     <thead><tr><th>Ngành hàng</th><th>SL</th><th>DT Realtime</th><th>Target Ngày</th><th>% HT</th><th>% Trả Góp</th></tr></thead>
                                     <tbody>`;
            if (totalRow) {
                 tableHtml += `<tr style="font-weight:bold; background-color: #e9ecef;">
                                     <td style="text-align: left !important;">${totalRow["Nhóm ngành hàng"]}</td><td>${formatNumber(totalRow["Số lượng"])}</td><td>${formatNumber(totalRow["DT Realtime (QĐ)"])}</td><td>${formatNumber(totalRow["Target Ngày (QĐ)"])}</td><td style="color: ${getColor(totalRow["% HT Target Ngày (QĐ)"])};">${formatNumber(totalRow["% HT Target Ngày (QĐ)"], 1)}%</td><td>${formatNumber(totalRow["Tỷ trọng trả góp"], 2)}%</td>
                                 </tr>`;
            }
            categoriesWithRevenue.forEach(row => { 
                tableHtml += `<tr><td style="text-align: left !important;">${row["Nhóm ngành hàng"]}</td><td>${formatNumber(row["Số lượng"])}</td><td>${formatNumber(row["DT Realtime (QĐ)"])}</td><td>${formatNumber(row["Target Ngày (QĐ)"])}</td><td style="color: ${getColor(row["% HT Target Ngày (QĐ)"])}; font-weight: bold;">${formatNumber(row["% HT Target Ngày (QĐ)"], 1)}%</td><td>${formatNumber(row["Tỷ trọng trả góp"], 2)}%</td></tr>`;
            });
            tableHtml += '</tbody></table>';
            wrapper.innerHTML = tableHtml;

            if (categoriesWithoutRevenue.length > 0) {
                const noRevenueHtml = `<div id="category-no-revenue-section" class="no-revenue-section" style="display:none;">
                                     <h4>Ngành hàng chưa phát sinh doanh thu (${categoriesWithoutRevenue.length}):</h4>
                                     <ul class="no-revenue-grid">
                                         ${categoriesWithoutRevenue.map((item, index) => `<li>${index + 1}. ${item["Nhóm ngành hàng"]}</li>`).join('')}
                                     </ul>
                                   </div>`;

                const buttonHtml = `<div class="details-toggle" style="margin-top: 15px;">
                                    <button id="toggle-category-no-revenue-btn">
                                        Hiện ${categoriesWithoutRevenue.length} ngành hàng chưa có DT
                                    </button>
                                </div>`;
                
                wrapper.insertAdjacentHTML('beforeend', buttonHtml + noRevenueHtml);

                const toggleBtn = document.getElementById('toggle-category-no-revenue-btn');
                const noRevenueSection = document.getElementById('category-no-revenue-section');
                toggleBtn.addEventListener('click', () => {
                    const isHidden = noRevenueSection.style.display === 'none';
                    noRevenueSection.style.display = isHidden ? 'block' : 'none';
                    toggleBtn.textContent = isHidden ? `Ẩn ${categoriesWithoutRevenue.length} ngành hàng chưa có DT` : `Hiện ${categoriesWithoutRevenue.length} ngành hàng chưa có DT`;
                });
            }
        }

        // CẬP NHẬT: Thêm nhận xét thi đua vào summary tổng
        function renderRealtimeSummary(totalRow, contestData) {
            const container = document.getElementById('summary-report-wrapper-rt');
            container.style.display = 'block';
            if (!totalRow) { container.innerHTML = ''; return; }
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            const ht = totalRow['% HT Target Ngày (QĐ)'];
            const timeFraction = getTimePassedFraction();
            const projectedSales = timeFraction > 0 && timeFraction < 1 ? (totalRow['DT Realtime (QĐ)'] / timeFraction) : totalRow['DT Realtime (QĐ)'];
            const projectedHt = totalRow['Target Ngày (QĐ)'] > 0 ? (projectedSales / totalRow['Target Ngày (QĐ)'] * 100) : 0;
            const onTrackCount = contestData.onTrack.length;
            const totalCount = contestData.all.length;
            const remaining = totalRow['Target Ngày (QĐ)'] - totalRow['DT Realtime (QĐ)'];

            let contestSummary = '';
            if (contestData.all.length > 0) {
                const onTrackNames = contestData.onTrack.map(item => `${item.name} (${formatNumber(item.percentProjected, 0)}%)`).join(', ');
                const behindNames = contestData.behind.map(item => `${item.name} (${formatNumber(item.percentProjected, 0)}%)`).join(', ');
                
                contestSummary += `\n-------------------\n🏁 TÌNH HÌNH THI ĐUA 🏁`;
                if(onTrackNames) contestSummary += `\n✅ Đang Về Đích: ${onTrackNames}`;
                if(behindNames) contestSummary += `\n🏃‍♂️ Cần Tăng Tốc: ${behindNames}`;
            }

            const summaryText = `📊 BÁO CÁO NHANH REAL-TIME - ${timeString} 📊
-------------------
- 🎯 Target Ngày: ${formatNumber(totalRow['Target Ngày (QĐ)'])}
- 📈 Realtime: ${formatNumber(totalRow['DT Realtime (QĐ)'])} (${formatNumber(ht, 1)}%)
- 📉 Còn lại: ${formatNumber(remaining)}
- 🚀 Dự kiến: ${formatNumber(projectedSales)} (${formatNumber(projectedHt, 1)}%)
- 🏆 Thi đua dự kiến đạt: ${onTrackCount}/${totalCount}
-------------------
- 💳 DT Trả góp: ${formatNumber(totalRow['DT Trả Góp'])} (${formatNumber(totalRow['Tỷ trọng trả góp'], 1)}%)
- 📱 Số lượng bán: ${formatNumber(totalRow['Số lượng'])}
${contestSummary}`.trim();

            const html = `<h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z" /></svg>Nhận xét Real-time (Tổng)</h2>
                                 <textarea class="summary-textarea" readonly>${summaryText}</textarea>
                                 <button class="action-btn copySummaryBtn" style="width: 100%; max-width: 400px; margin: 15px auto 0 auto;">
                                     <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                                     Sao chép Nhận xét
                                 </button>`;
            container.innerHTML = html;
            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = e.currentTarget.previousElementSibling;
                textarea.select();
                document.execCommand('copy');
                showToast('Đã sao chép nhận xét!');
            });
        }
        
        // CẬP NHẬT: Nhận xét nhân viên theo yêu cầu mới
        function renderEmployeeSummary(data) {
            const container = document.getElementById('summary-report-wrapper-rt-employee');
            if (!data || data.length === 0) {
                container.style.display = 'none';
                return;
            }
            container.style.display = 'block';

            const sortedData = [...data].sort((a, b) => b.revenue - a.revenue);
            
            let summaryLines = [];
            summaryLines.push(`🚀 BẢNG PHONG THẦN - ĐUA TOP DOANH THU 🚀`);
            summaryLines.push(`-------------------`);

            const hasPositiveRevenue = sortedData.some(e => e.revenue > 0);

            if (!hasPositiveRevenue) {
                summaryLines.push(`🤔 Hôm nay anh em chưa ai mở hàng à? Cùng nhau phá băng nào!`);
                sortedData.forEach(emp => {
                    summaryLines.push(`- ${emp.name}: Chờ đơn đầu tiên khai hỏa! 🔥`);
                });
            } else {
                // Ghi nhận TOP 3
                const topPerformers = sortedData.slice(0, 3);
                summaryLines.push(`👑 TOP 3 CHIẾN THẦN HÔM NAY:`);
                topPerformers.forEach((emp, index) => {
                    if (emp.revenue > 0) {
                        const icons = ['🥇', '🥈', '🥉'];
                        const comments = [
                            `Thánh chốt đơn gọi tên ${emp.name} với ${formatNumber(emp.revenue / 1000000, 2)} triệu! Quá đẳng cấp!`,
                            `Á quân ${emp.name} bám rất sát với ${formatNumber(emp.revenue / 1000000, 2)} triệu! Cố lên!`,
                            `Vị trí thứ 3 thuộc về ${emp.name} với ${formatNumber(emp.revenue / 1000000, 2)} triệu! Tuyệt vời!`
                        ];
                        summaryLines.push(`${icons[index]} ${comments[index]}`);
                    }
                });

                // Nhóm giữa và nhóm cuối
                if (sortedData.length > 3) {
                    const remainingEmployees = sortedData.slice(3);
                    const bottomCount = 3;
                    
                    // Đảm bảo không lấy nhiều hơn số nhân viên còn lại
                    const actualBottomCount = Math.min(bottomCount, remainingEmployees.length);
                    
                    const middleEmployees = remainingEmployees.slice(0, -actualBottomCount);
                    const bottomEmployees = remainingEmployees.slice(-actualBottomCount);

                    if (middleEmployees.length > 0) {
                        summaryLines.push(`\n🌟 CÁC CHIẾN BINH ĐANG TĂNG TỐC:`);
                        middleEmployees.forEach((emp, index) => {
                            const rank = index + 4; // Bắt đầu từ hạng 4
                            if (emp.revenue > 0) {
                                summaryLines.push(`- Hạng ${rank}: ${emp.name} - ${formatNumber(emp.revenue / 1000000, 2)} triệu. Giữ vững tay lái nhé!`);
                            } else {
                                summaryLines.push(`- ${emp.name}: "Em bé" vẫn chưa về. Cố lên bạn ơi! 🐢`);
                            }
                        });
                    }

                    if (bottomEmployees.length > 0) {
                        summaryLines.push(`\n⚠️ NHÓM CẦN CẢI THIỆN GẤP:`);
                        bottomEmployees.forEach((emp) => {
                            if (emp.revenue > 0) {
                                 summaryLines.push(`- ${emp.name} (${formatNumber(emp.revenue / 1000000, 2)} triệu): Doanh thu còn thấp, cần một cú hích mạnh mẽ hơn! 💥`);
                            } else {
                                 summaryLines.push(`- ${emp.name}: Báo động đỏ! 🚨 Khách hàng đang đi lạc đâu hết rồi, mau tìm lại thôi!`);
                            }
                        });
                    }
                }
            }

            const summaryText = summaryLines.join('\n');
            const html = `
                <h2><svg class="title-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" /></svg>Nhận xét Doanh thu Nhân viên</h2>
                <textarea id="employeeSummaryTextarea" class="summary-textarea" readonly>${summaryText}</textarea>
                <button class="action-btn copySummaryBtn" style="width: 100%; max-width: 400px; margin: 15px auto 0 auto;">
                    <svg fill="currentColor" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z" /></svg>
                    Sao chép Nhận xét
                </button>`;
            container.innerHTML = html;

            container.querySelector('.copySummaryBtn').addEventListener('click', (e) => {
                const textarea = document.getElementById('employeeSummaryTextarea');
                textarea.select();
                document.execCommand('copy');
                showToast('Đã sao chép nhận xét nhân viên!');
            });
        }
    }
    </script>
</body>
</html>
